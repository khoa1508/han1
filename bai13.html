<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i √în T·∫≠p Ti·∫øng Trung - B√†i 13: ËøôÊòØ‰∏çÊòØ‰∏≠ËçØÔºü</title>
    <style>
        :root {
            --primary-color: #4A90E2; /* M√†u xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
            --secondary-color: #50E3C2; /* M√†u xanh ng·ªçc lam */
            --success-color: #7ED321; /* Xanh l√° c√¢y t∆∞∆°i s√°ng */
            --warning-color: #F5A623; /* V√†ng cam */
            --danger-color: #D0021B; /* ƒê·ªè */
            --light-color: #FDFDFD;
            --dark-color: #4A4A4A;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
            --cute-yellow: #FFFACD; /* Lemon Chiffon */
            --cute-green: #98FB98; /* PaleGreen */
        }

        body {
            font-family: var(--font-family);
            background-color: #F4F7F6; /* N·ªÅn x√°m r·∫•t nh·∫°t */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-color);
            line-height: 1.7; /* TƒÉng line-height cho d·ªÖ ƒë·ªçc */
        }

        .game-container {
            background-color: var(--light-color);
            padding: 25px 35px;
            border-radius: 16px; /* Bo tr√≤n nhi·ªÅu h∆°n */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* B√≥ng ƒë·ªï m·ªÅm m·∫°i h∆°n */
            width: 100%;
            max-width: 950px; /* R·ªông h∆°n cho nhi·ªÅu n·ªôi dung */
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInGame 0.6s ease-out forwards 0.2s; /* Delay animation m·ªôt ch√∫t */
        }

        @keyframes fadeInGame {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1, h2, h3 {
            text-align: center;
            font-weight: 600; /* Ch·ªØ ƒë·∫≠m v·ª´a ph·∫£i */
        }
        h1 { color: var(--primary-color); font-size: 2.1em; margin-bottom: 15px; }
        h2 { color: var(--secondary-color); font-size: 1.7em; margin-top: 35px; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; }
        h3 { color: var(--dark-color); font-size: 1.4em; margin-top: 25px; margin-bottom: 15px; }

        .game-section {
            margin-bottom: 35px;
            padding: 20px;
            border: 1px solid #EAEAEA;
            border-radius: 12px;
            background-color: #FFFFFF; /* N·ªÅn tr·∫Øng cho c√°c section */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .game-section.hidden { display: none; }

        .status-bar {
            display: flex;
            justify-content: space-around; /* C√°ch ƒë·ªÅu c√°c item */
            align-items: center;
            padding: 12px 15px;
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color)); /* Gradient background */
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 1.15em;
            box-shadow: 0 4px 10px rgba(74,144,226,0.3);
        }
        #timer, #score-display { font-weight: bold; }

        .instruction-text {
            font-size: 1.05em;
            color: #555;
            margin-bottom: 15px;
            background-color: var(--cute-yellow);
            padding: 12px 18px;
            border-radius: 8px;
            border-left: 5px solid var(--warning-color);
        }
        .instruction-text i { margin-right: 7px; font-style: normal; }

        /* Ph·∫ßn 1: N·ªëi ch·ªØ H√°n */
        .matching-game table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0 5px; 
        }
        .matching-game th, .matching-game td {
            border: 1px solid #E0E0E0;
            padding: 10px 12px; 
            text-align: left;
        }
        .matching-game th {
            background-color: #F5F5F5;
            font-weight: 600;
        }
        .matching-game td:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px;}
        .matching-game td:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px;}

        .matching-game select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #CCC;
            width: 95%;
            box-sizing: border-box;
            font-size: 1em;
        }
        .pinyin-column span.pinyin-text { display: none; } /* ·∫®n pinyin ban ƒë·∫ßu */
        .pinyin-column span.pinyin-text.visible { display: inline; } /* Hi·ªán khi c√≥ class visible */


        /* Ph·∫ßn 2: T·ª´ v·ª±ng v√† L∆∞·ª£ng t·ª´ */
        .image-vocab-item { margin-bottom: 15px; text-align: center;}
        .image-vocab-item img { max-width: 120px; max-height: 90px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; }
        .image-vocab-item input[type="text"] { width: 150px; text-align: center; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .image-vocab-item .pinyin-hint { font-size: 0.9em; color: #777; display: none; } /* ·∫®n pinyin hint ban ƒë·∫ßu */
        .image-vocab-item .pinyin-hint.visible { display: block; margin-top: 5px; }


        .quantifier-fill-item { margin-bottom: 10px; display: flex; align-items: center; }
        .quantifier-fill-item input[type="text"], .quantifier-fill-item select {
            width: 70px; text-align: center; margin: 0 8px; padding: 6px;
            border: 1px solid #ccc; border-radius: 5px;
        }

        /* Ph·∫ßn 3: M·∫´u c√¢u */
        .sentence-fill-item { margin-bottom: 15px; }
        .sentence-fill-item .options-inline button {
            margin: 0 5px 5px 0; padding: 6px 10px; font-size: 0.95em;
            border: 1px solid var(--primary-color); background-color: white; color: var(--primary-color);
            border-radius: 15px; cursor: pointer;
        }
        .sentence-fill-item .options-inline button.selected { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .sentence-fill-item .blank {
            display: inline-block; width: 80px; height: 20px;
            border-bottom: 2px solid var(--primary-color); margin: 0 5px;
            text-align: center; font-weight: bold; color: var(--danger-color);
        }
        .qna-item textarea { width: 95%; min-height: 40px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .youmeiyou-item { margin-bottom: 10px; }
        .youmeiyou-item input[type="text"] { width: 60px; text-align: center; margin: 0 5px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;}


        /* Ph·∫ßn 4: ƒê·ªçc hi·ªÉu */
        .reading-comprehension .passage {
            background-color: #F9F9F9; padding: 15px; border-radius: 8px;
            margin-bottom: 15px; line-height: 1.8;
        }
        .reading-comprehension .question-item textarea { width: 95%; min-height: 30px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }

        /* Ph·∫ßn 5: Mi√™u t·∫£ */
        .describe-luggage-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .describe-luggage-item label { min-width: 50px; }
        .describe-luggage-item input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }


        /* Chung */
        .feedback { margin-top: 8px; font-style: italic; font-size: 0.95em; }
        .feedback.correct { color: var(--success-color); }
        .feedback.incorrect { color: var(--danger-color); }

        .action-button, .toggle-pinyin-btn {
            padding: 12px 28px; 
            font-size: 1.15em; 
            color: white;
            border: none;
            border-radius: 28px; 
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 25px auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .action-button { background-image: linear-gradient(to right, var(--success-color), #5CB85C); }
        .toggle-pinyin-btn {
            background-image: linear-gradient(to right, var(--warning-color), #f0ad4e);
            font-size: 0.95em; padding: 10px 20px; margin-top: 10px;
        }

        .action-button:hover, .toggle-pinyin-btn:hover {
            transform: translateY(-3px) scale(1.03); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .action-button:active, .toggle-pinyin-btn:active {
            transform: translateY(-1px) scale(1.01);
        }
        .action-button.next-section-btn { background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color)); }


        #final-summary {
            padding: 25px;
            background-color: var(--light-color);
            border: 3px solid var(--secondary-color); 
            border-radius: 12px;
            margin-top: 35px;
        }
        #final-summary h2 { color: var(--primary-color); }
        #final-summary ul { list-style-type: none; padding-left: 0; }
        #final-summary li { margin-bottom: 10px; padding: 8px 12px; border-radius: 6px; font-size: 1.05em; }
        #final-summary li.correct-ans { background-color: #E9F7EF; color: #1D6F42; border-left: 4px solid var(--success-color); }
        #final-summary li.incorrect-ans { background-color: #FDEDED; color: #A94442; border-left: 4px solid var(--danger-color); }
        #final-summary li.incorrect-ans .user-answer { text-decoration: line-through; margin-right: 8px;}
        #final-summary li .correct-value { font-weight: bold; color: #333; }

    </style>
</head>
<body>
    <div class="game-container">
        <h1>‰Ω†Â•Ω! Ch√†o m·ª´ng em ƒë·∫øn v·ªõi Tr√≤ Ch∆°i √în T·∫≠p B√†i 13: ËøôÊòØ‰∏çÊòØ‰∏≠ËçØÔºü üíä</h1>
        <p style="text-align:center; font-size: 1.1em; color: var(--secondary-color);">
            ËÄÅÂ∏à ƒë√£ chu·∫©n b·ªã c√°c th·ª≠ th√°ch th√∫ v·ªã ƒë·ªÉ gi√∫p em √¥n l·∫°i ki·∫øn th·ª©c b√†i n√†y. C·ªë g·∫Øng l√™n nh√©! Âä†Ê≤π! üí™
        </p>

        <div class="status-bar">
            <div id="timer">‚è≥ Th·ªùi gian: 00:00:00</div>
            <div id="score-display">ƒêi·ªÉm: 0</div>
        </div>

        <div id="section-hanzi" class="game-section">
            <h2>I. ËÆ§Ê±âÂ≠ó (R√®n H√†nz√¨ - Nh·∫≠n bi·∫øt ch·ªØ H√°n)</h2>
            <div id="hanzi-matching">
                <h3>1. ÊääÊ±âÂ≠óÂíåÊãºÈü≥ËøûËµ∑Êù• (N·ªëi ch·ªØ H√°n v√† phi√™n √¢m):</h3>
                <p class="instruction-text">üí° H√£y ch·ªçn phi√™n √¢m (Pinyin) ch√≠nh x√°c cho m·ªói ch·ªØ H√°n trong b·∫£ng d∆∞·ªõi ƒë√¢y. Nh·∫•n n√∫t "üí° Hi·ªán/·∫®n Pinyin" ƒë·ªÉ xem ho·∫∑c ·∫©n g·ª£i √Ω Pinyin cho c√°c l·ª±a ch·ªçn nh√©!</p>
                <button class="toggle-pinyin-btn" onclick="togglePinyinVisibility('hanzi-matching-body', 'pinyin-text')">üí° Hi·ªán/·∫®n Pinyin ƒê√°p √Ån</button>
                <table class="matching-game">
                    <thead><tr><th>Ê±âÂ≠ó (H√†nz√¨)</th><th class="pinyin-column">ÊãºÈü≥ (Pƒ´nyƒ´n) - Ch·ªçn</th><th>K·∫øt qu·∫£</th></tr></thead>
                    <tbody id="hanzi-matching-body"></tbody>
                </table>
                <button onclick="checkHanziMatching_B13()" class="action-button" style="background-image: linear-gradient(to right, var(--warning-color), #F0AD4E); margin-top:15px;">Ki·ªÉm tra N·ªëi T·ª´</button>
            </div>
            </div>

        <div id="section-vocab-quantifier" class="game-section hidden">
            <h2>II. ÁîüËØçÂíåÈáèËØç (Shƒìngc√≠ h√© Li√†ngc√≠ - T·ª´ v·ª±ng v√† L∆∞·ª£ng t·ª´)</h2>
            <div id="image-vocab-writing">
                <h3>1. ÁúãÂõæÂÜôËØçËØ≠ (Nh√¨n h√¨nh vi·∫øt t·ª´):</h3>
                <p class="instruction-text">üñºÔ∏è (ËÄÅÂ∏à s·∫Ω s·ªõm th√™m h√¨nh ·∫£nh minh h·ªça nh√©!) H√£y vi·∫øt t·ª´ ti·∫øng Trung (H√°n t·ª±) t∆∞∆°ng ·ª©ng v·ªõi g·ª£i √Ω Pinyin b√™n d∆∞·ªõi. Nh·∫•n "üí° Hi·ªán/·∫®n Pinyin G·ª£i √ù" n·∫øu c·∫ßn!</p>
                <button class="toggle-pinyin-btn" onclick="togglePinyinVisibility('image-vocab-writing', 'pinyin-hint')">üí° Hi·ªán/·∫®n Pinyin G·ª£i √ù</button>
                </div>
            <div id="quantifier-fill" style="margin-top: 25px;">
                <h3>2. Áî®Ê≠£Á°ÆÁöÑÈáèËØçÂ°´Á©∫ (D√πng l∆∞·ª£ng t·ª´ ƒë√∫ng ƒëi·ªÅn v√†o ch·ªó tr·ªëng):</h3>
                <p class="instruction-text">üìè Ch·ªçn ho·∫∑c ƒëi·ªÅn l∆∞·ª£ng t·ª´ (measure word) ph√π h·ª£p v√†o m·ªói ch·ªó tr·ªëng.</p>
                </div>
        </div>

        <div id="section-sentence-practice" class="game-section hidden">
            <h2>III. Âè•ÂûãÁªÉ‰π† (J√πx√≠ng Li√†nx√≠ - Luy·ªán t·∫≠p m·∫´u c√¢u)</h2>
            <div id="sentence-fill-blanks">
                <h3>1. ÈÄâÊã©ÂêàÈÄÇÁöÑËØçËØ≠Â°´Á©∫ (Ch·ªçn t·ª´ th√≠ch h·ª£p ƒëi·ªÅn v√†o ch·ªó tr·ªëng):</h3>
                <p class="instruction-text">ü§î H√£y ch·ªçn t·ª´ ƒë√∫ng trong c√°c l·ª±a ch·ªçn ƒë·ªÉ ho√†n th√†nh c√°c c√¢u sau.</p>
                </div>
            <div id="sentence-qna" style="margin-top: 25px;">
                <h3>2. ÂõûÁ≠îÈóÆÈ¢ò (Tr·∫£ l·ªùi c√¢u h·ªèi):</h3>
                <p class="instruction-text">üí¨ D√πng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi n√†y b·∫±ng ti·∫øng Trung nh√©! (Ph·∫ßn n√†y ËÄÅÂ∏à s·∫Ω nh·∫≠n x√©t sau nha üòä)</p>
                </div>
            <div id="sentence-completion-youmeiyou" style="margin-top: 25px;">
                <h3>3. Áî® "Êúâ" Êàñ "Ê≤°Êúâ" ÂÆåÊàêÂè•Â≠ê (D√πng "c√≥" ho·∫∑c "kh√¥ng c√≥" ho√†n th√†nh c√¢u):</h3>
                <p class="instruction-text">‚úçÔ∏è Ho√†n th√†nh c√°c c√¢u sau b·∫±ng c√°ch ƒëi·ªÅn "Êúâ (y«íu)" ho·∫∑c "Ê≤°Êúâ (m√©iy«íu)".</p>
                </div>
        </div>

        <div id="section-reading" class="game-section hidden">
            <h2>IV. ÈòÖËØªÁêÜËß£ (Yu√®d√∫ L«êjiƒõ - ƒê·ªçc hi·ªÉu)</h2>
            <div class="reading-comprehension">
                <h3>ËØæÊñá (K√®w√©n):</h3>
                <div class="passage">
                    A: ‰Ω†Ê≤°ÊúâÁÆ±Â≠êÂêóÔºü<br>
                    B: ÊúâÂïä„ÄÇÊàëÁöÑÂú®ËøôÂÑøÂë¢„ÄÇ<br>
                    A: ÊàëÁöÑÂæàÈáçÔºå‰Ω†ÁöÑÈáç‰∏çÈáçÔºü<br>
                    B: Ëøô‰∏™ÈªëÁöÑÂæàÈáçÔºåÈÇ£‰∏™Á∫¢ÁöÑÊØîËæÉËΩª„ÄÇ<br>
                    A: ‰Ω†ÁöÑÁÆ±Â≠êÂæàÊñ∞ÔºåÊàëÁöÑÂæàÊóß„ÄÇ<br>
                    B: ÈÇ£‰∏™Êñ∞ÁöÑÊòØÊúãÂèãÁöÑ„ÄÇËøô‰∏™ÊóßÁöÑÊòØÊàëÁöÑ„ÄÇ
                </div>
                <h3>Ê†πÊçÆËØæÊñáÂõûÁ≠îÈóÆÈ¢ò (D·ª±a v√†o ƒëo·∫°n vƒÉn tr·∫£ l·ªùi c√¢u h·ªèi):</h3>
                <p class="instruction-text">üìñ ƒê·ªçc k·ªπ ƒëo·∫°n h·ªôi tho·∫°i v√† tr·∫£ l·ªùi c√°c c√¢u h·ªèi b·∫±ng ti·∫øng Trung. (Ph·∫ßn n√†y ËÄÅÂ∏à s·∫Ω xem v√† g√≥p √Ω cho em sau nh√©!)</p>
                </div>
        </div>

        <div id="section-describe-luggage" class="game-section hidden">
            <h2>V. ÊèèËø∞‰Ω†ÁöÑË°åÊùé (Mi√°osh√π n«ê de x√≠ngl«ê - Mi√™u t·∫£ h√†nh l√Ω c·ªßa b·∫°n)</h2>
            <p class="instruction-text">üéí N·∫øu ƒëi du l·ªãch, em s·∫Ω mang theo nh·ªØng g√¨? H√£y li·ªát k√™ 5 th·ª©, m√†u s·∫Øc c·ªßa ch√∫ng v√† khi n√†o em d√πng ƒë·∫øn ch√∫ng b·∫±ng ti·∫øng Trung nh√©! (Ph·∫ßn n√†y ƒë·ªÉ em t·ª± do s√°ng t·∫°o, ËÄÅÂ∏à s·∫Ω gi√∫p em s·ª≠a sau nha!)</p>
            <div id="luggage-description-area">
                </div>
        </div>

        <button id="next-section-button" class="action-button next-section-btn" onclick="nextSection()">Ti·∫øp t·ª•c ph·∫ßn sau üöÄ</button>
        <button id="finish-game-button" class="action-button hidden" onclick="showFinalSummary_B13()">Ho√†n Th√†nh & Xem K·∫øt Qu·∫£ üéâ</button>

        <div id="final-summary" class="hidden">
            <h2>‚ú® B·∫£ng T·ªïng K·∫øt Th√†nh T√≠ch ‚ú®</h2>
            <p>Ch√∫c m·ª´ng em ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c th·ª≠ th√°ch! C√πng xem l·∫°i k·∫øt qu·∫£ n√†o:</p>
            <p><strong>T·ªïng th·ªùi gian l√†m b√†i:</strong> <span id="total-time-taken"></span></p>
            <p><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="total-score"></span></p>
            <h3>Chi ti·∫øt c√°c c√¢u tr·∫£ l·ªùi:</h3>
            <ul id="summary-details"></ul>
            <button onclick="restartGame()" class="action-button" style="background-image: linear-gradient(to right, var(--primary-color), #5BC0DE);">Ch∆°i L·∫°i T·ª´ ƒê·∫ßu üîÅ</button>
        </div>
    </div>

    <script>
        // --- D·ªØ li·ªáu cho tr√≤ ch∆°i B√†i 13 ---
        const hanziMatchingData_B13 = [
            { id: 1, hanzi: "ËçØ", pinyin: "y√†o" },
            { id: 2, hanzi: "ÁÆ±Â≠ê", pinyin: "xiƒÅngzi" },
            { id: 3, hanzi: "Èáç", pinyin: "zh√≤ng" },
            { id: 4, hanzi: "ËΩª", pinyin: "qƒ´ng" },
            { id: 5, hanzi: "Êñ∞", pinyin: "xƒ´n" },
            { id: 6, hanzi: "Êóß", pinyin: "ji√π" },
            { id: 7, hanzi: "ËàíÊúç", pinyin: "sh≈´fu" },
            { id: 8, hanzi: "Ë°£Êúç", pinyin: "yƒ´fu" },
            { id: 9, hanzi: "È¢úËâ≤", pinyin: "y√°ns√®" },
            { id: 10, hanzi: "ÈáåËæπ", pinyin: "l«êbian" }
        ];

        // D·ªØ li·ªáu cho "Nh√¨n nghƒ©a, vi·∫øt ch·ªØ H√°n v√† phi√™n √¢m" ƒë√£ ƒë∆∞·ª£c b·ªè

        const imageVocabData_B13 = [
            { id: 'iv1', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgb65KdoGb8eBIT0dyjodODL-fsDnGbRr2MhGmbcAZXp8Q6plo5I7s-KZ2-szmUW6B9rZeqOMAvAvCRvsF5Y1Fx8XXHaHQLapYQzA_eQ', answer: "‰∏≠ËçØ", pinyin_hint: "zh≈çngy√†o" },
            { id: 'iv2', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRZAmpQQ8uDZUCZghWEJK38JGtlCOFeVPfziA&s', answer: "Ë•øËçØ", pinyin_hint: "xƒ´y√†o" },
            { id: 'iv3', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRkJ61wN50cIkXFBc20NX3k73dpjbqM1cfs-Q&s', answer: "Ë°åÊùéÁÆ±", pinyin_hint: "x√≠ngl«êxiƒÅng" },
            { id: 'iv4', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRRne1I4S8wwF9YTNgeugkBktjjz7ELLxfDWQ&s', answer: "ÁâôÂà∑", pinyin_hint: "y√°shuƒÅ" },
            { id: 'iv5', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQFpjre9LrAoFfhwsMlNfa7puLa7UsdJel1Yw&s', answer: "Ë°£Êúç", pinyin_hint: "yƒ´fu" },
            { id: 'iv6', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQxysZJrTnTscFFKAkJoy2CKheBsj1G_XbWEQ&s', answer: "Èõ®‰ºû", pinyin_hint: "y«îs«én" },
            { id: 'iv7', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSDGVbcwUV85q86pMLimyaAuL216IqDHAnJ1A&s', answer: "ÊâãÊú∫", pinyin_hint: "sh«íujƒ´" },
            { id: 'iv8', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyvQ9IvuyLz4rzB6WuJRRTAY_sIwfR96dOxw&s', answer: "Èò≤ÊôíÈúú", pinyin_hint: "f√°ngsh√†ishuƒÅng" }
        ];

        const quantifierFillData_B13 = [
            { id: 'qf1', sentence_before: "‰∏Ä", sentence_after: "Ë°£Êúç (yƒ´fu)", answer: "‰ª∂", options: ["‰ª∂", "Êää", "Êú¨", "Âº†"] },
            { id: 'qf2', sentence_before: "‰∏Ä", sentence_after: "Èõ®‰ºû (y«îs«én)", answer: "Êää", options: ["‰ª∂", "Êää", "Êú¨", "Âº†"] },
            { id: 'qf3', sentence_before: "‰∏Ä", sentence_after: "ËØçÂÖ∏ (c√≠di«én)", answer: "Êú¨", options: ["‰ª∂", "Êää", "Êú¨", "Âº†"] },
            { id: 'qf4', sentence_before: "Âõõ", sentence_after: "Èì∂Ë°åÂç° (y√≠nh√°ngk«é)", answer: "Âº†", options: ["‰ª∂", "Êää", "Êú¨", "Âº†"] },
            { id: 'qf5', sentence_before: "‰∏Ä", sentence_after: "Á¨î (b«ê)", answer: "ÊîØ", options: ["ÊîØ", "Âè∞", "Êù°", "Áì∂"] },
            { id: 'qf6', sentence_before: "‰∏Ä", sentence_after: "ÁîµËÑë (di√†nn«éo)", answer: "Âè∞", options: ["ÊîØ", "Âè∞", "Êù°", "Áì∂"] },
            { id: 'qf7', sentence_before: "‰∏Ä", sentence_after: "ÁâôÂà∑ (y√°shuƒÅ)", answer: "Êää", options: ["ÊîØ", "Âè∞", "Êù°", "Êää"] },
            { id: 'qf8', sentence_before: "‰∏§", sentence_after: "Âï§ÈÖí (p√≠ji«î)", answer: "Áì∂", options: ["ÊîØ", "Âè∞", "Êù°", "Áì∂"] },
            { id: 'qf9', sentence_before: "‰∏â", sentence_after: "ÈìÖÁ¨î (qiƒÅnb«ê)", answer: "ÊîØ", options: ["ÊîØ", "Âè∞", "Êù°", "Áì∂"] },
            { id: 'qf10', sentence_before: "‰∏Ä", sentence_after: "Ë£§Â≠ê (k√πzi)", answer: "Êù°", options: ["ÊîØ", "Âè∞", "Êù°", "Áì∂"] },
            { id: 'qf11', sentence_before: "ÂæàÂ§ö", sentence_after: "Â∞èÈ∏ü (xi«éo ni«éo)", answer: "Âè™", options: ["Âè™", "Áæ§", "‰∏™", "Êù°"] },
            { id: 'qf12', sentence_before: "‰∏Ä", sentence_after: "È¶ôÊ∞¥ (xiƒÅngshu«ê)", answer: "Áì∂", options: ["Âè™", "Êª¥", "‰∏™", "Áì∂"] }
        ];

        const sentenceFillBlanksData_B13 = [
            { id: 'sf1', sentence_parts: ["ÊàëÁöÑÁÆ±Â≠êÂæà ", "Ôºå‰Ω†ÁöÑÁÆ±Â≠êÊØîËæÉ ", "„ÄÇ"], options: ["Èáç", "ËΩª"], answers: ["Èáç", "ËΩª"] },
            { id: 'sf2', sentence_parts: ["Ëøô‰ª∂Ë°£ÊúçÊòØ ", " ÁöÑÔºåÈÇ£‰ª∂ÊòØ ", " ÁöÑ„ÄÇ"], options: ["Êñ∞", "Êóß"], answers: ["Êñ∞", "Êóß"] },
            { id: 'sf3', sentence_parts: ["ÊàëÂñúÊ¨¢ ", " ËìùËâ≤ÁöÑÔºå‰∏çÂñúÊ¨¢ ", " ËìùËâ≤ÁöÑ„ÄÇ"], options: ["Ê∑±", "ÊµÖ"], answers: ["Ê∑±", "ÊµÖ"] },
            { id: 'sf4', sentence_parts: ["ÊàëÁîüÁóÖ‰∫ÜÔºåËßâÂæóÂæà ", "„ÄÇ"], options: ["ËàíÊúç", "‰∏çËàíÊúç"], answers: ["‰∏çËàíÊúç"] },
            { id: 'sf5', sentence_parts: ["‰Ω†ÂñúÊ¨¢ÂêÉ ", " ËøòÊòØ ", "Ôºü"], options: ["‰∏≠ËçØ", "Ë•øËçØ"], answers: ["‰∏≠ËçØ", "Ë•øËçØ"] },
            { id: 'sf6', sentence_parts: ["ÊàëÁöÑÊâãÊú∫Âú®ÁÆ±Â≠ê", "„ÄÇ"], options: ["ÈáåËæπ", "‰∏äÈù¢", "ÊóÅËæπ"], answers: ["ÈáåËæπ"] }
        ];

        const sentenceQnAData_B13 = [
            { id: 'qna1_b13', question: "‰Ω†ÁîüÁóÖÁöÑÊó∂ÂÄôÔºåËßâÂæóÊÄé‰πàÊ†∑Ôºü", exampleAnswer: "ÊàëËßâÂæó‰∏çËàíÊúçÔºåÂ§¥Áñº„ÄÇ" },
            { id: 'qna2_b13', question: "‰Ω†ÁöÑÁÆ±Â≠êÈáåÊúâ‰ªÄ‰πà‰∏úË•øÔºü (ÂÜô‰∏§Ê†∑‰∏úË•ø)", exampleAnswer: "ÊàëÁöÑÁÆ±Â≠êÈáåÊúâË°£ÊúçÂíå‰π¶„ÄÇ" },
            { id: 'qna3_b13', question: "Ëøô‰∏™ÈªëÁÆ±Â≠êÈáç‰∏çÈáçÔºü", exampleAnswer: "Ëøô‰∏™ÈªëÁÆ±Â≠êÂæàÈáç / ‰∏çÈáç„ÄÇ" },
            { id: 'qna4_b13', question: "‰Ω†ÁöÑÊâãÊú∫ÊòØ‰ªÄ‰πàÈ¢úËâ≤ÁöÑÔºü", exampleAnswer: "ÊàëÁöÑÊâãÊú∫ÊòØÈªëËâ≤ÁöÑ„ÄÇ" },
            { id: 'qna5_b13', question: "‰Ω†ÂñúÊ¨¢Áî®‰∏≠ËçØËøòÊòØË•øËçØÔºü", exampleAnswer: "ÊàëÂñúÊ¨¢Áî®Ë•øËçØ„ÄÇ" }
        ];

        const youMeiyouData_B13 = [
            { id: 'ym1', parts: ["Êàë ", " ‰∏Ä‰∏™Êñ∞ÊâãÊú∫„ÄÇ"], answer: "Êúâ" },
            { id: 'ym2', parts: ["‰ªñ ", " ‰∏≠ËçØÔºå‰ªñÊúâË•øËçØ„ÄÇ"], answer: "Ê≤°Êúâ" },
            { id: 'ym3', parts: ["Â¶πÂ¶π ", " Ëã±ËØ≠‰π¶ÂêóÔºüÂ•π ", " Ëã±ËØ≠‰π¶„ÄÇ"], answers: ["Êúâ", "Êúâ"] },
            { id: 'ym4', parts: ["ÁÆ±Â≠êÈáå ", " Ë°£ÊúçÔºå‰ΩÜÊòØ ", " Èõ®‰ºû„ÄÇ"], answers: ["Êúâ", "Ê≤°Êúâ"] }
        ];

        const readingQuestions_B13 = [
            { id: 'rq1', question: "B ÊúâÁÆ±Â≠êÂêóÔºü", correctAnswer: "ÊúâÂïä„ÄÇ/ Êúâ„ÄÇ" },
            { id: 'rq2', question: "A ÁöÑÁÆ±Â≠êÈáç‰∏çÈáçÔºü", correctAnswer: "AÁöÑÁÆ±Â≠êÂæàÈáç„ÄÇ" },
            { id: 'rq3', question: "B ÊúâÂá†‰∏™ÁÆ±Â≠êÔºüÂÆÉ‰ª¨ÊòØ‰ªÄ‰πàÈ¢úËâ≤ÁöÑÔºü", correctAnswer: "BÊúâ‰∏§‰∏™ÁÆ±Â≠êÔºå‰∏Ä‰∏™ÊòØÈªëÁöÑÔºå‰∏Ä‰∏™ÊòØÁ∫¢ÁöÑ„ÄÇ" },
            { id: 'rq4', question: "Á∫¢Ëâ≤ÁöÑÁÆ±Â≠êÊÄé‰πàÊ†∑Ôºü", correctAnswer: "Á∫¢Ëâ≤ÁöÑÁÆ±Â≠êÊØîËæÉËΩª„ÄÇ" },
            { id: 'rq5', question: "B ÁöÑÊñ∞ÁÆ±Â≠êÊòØË∞ÅÁöÑÔºüÊóßÁÆ±Â≠êÂë¢Ôºü", correctAnswer: "BÁöÑÊñ∞ÁÆ±Â≠êÊòØÊúãÂèãÁöÑÔºåÊóßÁÆ±Â≠êÊòØ‰ªñÁöÑ„ÄÇ" }
        ];

        let currentSectionIndex_B13 = 0;
        const sections_B13 = ['section-hanzi', 'section-vocab-quantifier', 'section-sentence-practice', 'section-reading', 'section-describe-luggage'];
        let score_B13 = 0;
        let timerInterval_B13;
        let secondsElapsed_B13 = 0;
        let userAnswers_B13 = {};

        document.addEventListener('DOMContentLoaded', () => {
            populateHanziMatching_B13();
            populateImageVocabWriting_B13();
            populateQuantifierFill_B13();
            populateSentenceFillBlanks_B13();
            populateSentenceQnA_B13();
            populateYouMeiyou_B13();
            populateReadingQuestions_B13();
            populateDescribeLuggage_B13();

            showSection_B13(currentSectionIndex_B13);
            startTimer_B13();
            updateScoreDisplay_B13();
        });

        function startTimer_B13() {
            if (timerInterval_B13) clearInterval(timerInterval_B13);
            secondsElapsed_B13 = 0;
            document.getElementById('timer').textContent = `‚è≥ Th·ªùi gian: ${formatTime_B13(secondsElapsed_B13)}`;
            timerInterval_B13 = setInterval(() => {
                secondsElapsed_B13++;
                document.getElementById('timer').textContent = `‚è≥ Th·ªùi gian: ${formatTime_B13(secondsElapsed_B13)}`;
            }, 1000);
        }
        function formatTime_B13(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function updateScoreDisplay_B13() {
             document.getElementById('score-display').textContent = `ƒêi·ªÉm: ${score_B13}`;
        }
        function updateScore_B13(points) {
            score_B13 += points;
            updateScoreDisplay_B13();
        }

        function showSection_B13(index) {
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            const currentSectionElement = document.getElementById(sections_B13[index]);
            if (currentSectionElement) {
                currentSectionElement.classList.remove('hidden');
            }

            const nextButton = document.getElementById('next-section-button');
            const finishButton = document.getElementById('finish-game-button');

            // UPDATED: Correctly hide "Next" button and show "Finish" button on the last section
            if (index >= sections_B13.length - 1) {
                if(nextButton) nextButton.style.display = 'none'; // Use style.display for more reliable hiding
                if(finishButton) finishButton.classList.remove('hidden');
            } else {
                if(nextButton) nextButton.style.display = 'block'; // Or 'inline-block' or 'flex' depending on original display
                if(finishButton) finishButton.classList.add('hidden');
            }
        }

        function nextSection() {
            currentSectionIndex_B13++;
            if (currentSectionIndex_B13 < sections_B13.length) {
                showSection_B13(currentSectionIndex_B13);
            }
            // No longer calls showFinalSummary_B13 here
        }
         function restartGame() {
            currentSectionIndex_B13 = 0;
            score_B13 = 0;
            userAnswers_B13 = {};
            updateScoreDisplay_B13();

            document.querySelectorAll('input[type="text"], textarea, select').forEach(input => {
                if(input.tagName === 'SELECT') input.selectedIndex = 0;
                else input.value = '';
                input.disabled = false;
                if(input.style) input.style.borderColor = '#ccc';
            });
            document.querySelectorAll('.feedback').forEach(fb => {fb.textContent = ''; fb.className = 'feedback';});
            document.querySelectorAll('.correct-hanzi').forEach(ch => ch.textContent = '');
             document.querySelectorAll('.pinyin-text.visible').forEach(p => p.classList.remove('visible'));
             document.querySelectorAll('.pinyin-hint.visible').forEach(p => p.classList.remove('visible'));


            document.querySelectorAll('.action-button, .show-answer-btn, .toggle-pinyin-btn').forEach(btn => btn.disabled = false);
            const hanziMatchingButton = document.querySelector('#hanzi-matching button.action-button');
             if(hanziMatchingButton) hanziMatchingButton.disabled = false;

            document.getElementById('final-summary').classList.add('hidden');
            showSection_B13(currentSectionIndex_B13);
            startTimer_B13();
        }

        function togglePinyinVisibility(containerId, pinyinClass) {
            const container = document.getElementById(containerId);
            if (container) {
                container.querySelectorAll(`.${pinyinClass}`).forEach(span => {
                    span.classList.toggle('visible');
                });
            }
        }

        function populateHanziMatching_B13() {
            const tbody = document.getElementById('hanzi-matching-body');
            tbody.innerHTML = '';
            const allPinyinsForOptions = shuffleArray_B13([...new Set(hanziMatchingData_B13.map(item => item.pinyin))]);

            hanziMatchingData_B13.forEach(item => {
                const row = tbody.insertRow();
                // Pinyin is now part of the first cell, initially hidden
                row.innerHTML = `
                    <td>${item.id}. ${item.hanzi} (<span class="pinyin-text">${item.pinyin}</span>)</td>
                    <td>
                        <select id="b13-pinyin-select-${item.id}">
                            <option value="">Ch·ªçn Pinyin</option>
                            ${allPinyinsForOptions.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                    </td>
                    <td id="b13-match-feedback-${item.id}" class="feedback"></td>
                `;
            });
        }
        function shuffleArray_B13(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function populateImageVocabWriting_B13() {
            const container = document.getElementById('image-vocab-writing');
            // Clear previous content and add title/button
            container.innerHTML = '<h3>1. ÁúãÂõæÂÜôËØçËØ≠ (Nh√¨n h√¨nh vi·∫øt t·ª´):</h3> <p class="instruction-text">üñºÔ∏è H√£y vi·∫øt t·ª´ ti·∫øng Trung (H√°n t·ª±) t∆∞∆°ng ·ª©ng v·ªõi g·ª£i √Ω Pinyin b√™n d∆∞·ªõi. Nh·∫•n "üí° Hi·ªán/·∫®n Pinyin G·ª£i √ù" n·∫øu c·∫ßn!</p> <button class="toggle-pinyin-btn" onclick="togglePinyinVisibility(\'image-vocab-writing\', \'pinyin-hint\')">üí° Hi·ªán/·∫®n Pinyin G·ª£i √ù</button>';
            imageVocabData_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'image-vocab-item';
                div.innerHTML = `
                    <img src="https://placehold.co/120x90/E8DDCB/000000?text=${encodeURIComponent(item.image_placeholder)}" alt="${item.image_placeholder}">
                    <input type="text" id="b13-iv-${item.id}" placeholder="Ê±âÂ≠ó">
                    <div><small class="pinyin-hint">${item.pinyin_hint}</small></div>
                    <button class="action-button" style="font-size:0.9em; padding: 6px 12px; margin-top:5px;" onclick="checkImageVocab_B13('${item.id}', '${item.answer}', this)">Ki·ªÉm tra</button>
                    <div id="b13-iv-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }

        function populateQuantifierFill_B13() {
            const container = document.getElementById('quantifier-fill');
            container.innerHTML = '<h3>2. Áî®Ê≠£Á°ÆÁöÑÈáèËØçÂ°´Á©∫ (D√πng l∆∞·ª£ng t·ª´ ƒë√∫ng ƒëi·ªÅn v√†o ch·ªó tr·ªëng):</h3> <p class="instruction-text">üìè Ch·ªçn ho·∫∑c ƒëi·ªÅn l∆∞·ª£ng t·ª´ (measure word) ph√π h·ª£p v√†o m·ªói ch·ªó tr·ªëng.</p>';
            quantifierFillData_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'quantifier-fill-item';
                let inputHtml = '';
                if (item.options && item.options.length > 0) {
                    inputHtml = `<select id="b13-qf-${item.id}">
                                    <option value="">Ch·ªçn</option>
                                    ${item.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                 </select>`;
                } else {
                    inputHtml = `<input type="text" id="b13-qf-${item.id}" placeholder="ÈáèËØç">`;
                }
                div.innerHTML = `
                    <span>${item.sentence_before}</span>
                    ${inputHtml}
                    <span>${item.sentence_after}</span>
                    <button class="action-button" style="font-size:0.8em; padding: 5px 10px; margin-left:10px;" onclick="checkQuantifier_B13('${item.id}', '${item.answer}', this)">Ki·ªÉm tra</button>
                    <span id="b13-qf-feedback-${item.id}" class="feedback"></span>
                `;
                container.appendChild(div);
            });
        }

        function populateSentenceFillBlanks_B13(){
            const container = document.getElementById('sentence-fill-blanks');
            container.innerHTML = '<h3>1. ÈÄâÊã©ÂêàÈÄÇÁöÑËØçËØ≠Â°´Á©∫ (Ch·ªçn t·ª´ th√≠ch h·ª£p ƒëi·ªÅn v√†o ch·ªó tr·ªëng):</h3><p class="instruction-text">ü§î H√£y ch·ªçn t·ª´ ƒë√∫ng trong c√°c l·ª±a ch·ªçn ƒë·ªÉ ho√†n th√†nh c√°c c√¢u sau.</p>';
            sentenceFillBlanksData_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'sentence-fill-item';
                let sentenceHtml = '';
                item.sentence_parts.forEach((part, i) => {
                    sentenceHtml += `<span>${part}</span>`;
                    if (i < item.answers.length) {
                        sentenceHtml += `<span id="b13-sf-blank-${item.id}-${i}" class="blank">(ch·ªçn)</span>`;
                    }
                });

                div.innerHTML = `
                    <p><strong>C√¢u ${index + 1}:</strong> ${sentenceHtml}</p>
                    <div class="options-inline">
                        ${item.options.map(opt => `<button onclick="selectSentenceFillOption(this, '${item.id}', '${opt}')">${opt}</button>`).join('')}
                    </div>
                    <button onclick="checkSentenceFill_B13('${item.id}', this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:10px;">Ki·ªÉm tra c√¢u ${index+1}</button>
                    <div id="b13-sf-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
                userAnswers_B13[`sentenceFill_${item.id}`] = { selected: Array(item.answers.length).fill(null) }; // Initialize based on number of blanks
            });
        }

        function populateSentenceQnA_B13(){
            const container = document.getElementById('sentence-qna');
            container.innerHTML = '<h3>2. ÂõûÁ≠îÈóÆÈ¢ò (Tr·∫£ l·ªùi c√¢u h·ªèi):</h3> <p class="instruction-text">üí¨ D√πng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi n√†y b·∫±ng ti·∫øng Trung nh√©! (Ph·∫ßn n√†y ËÄÅÂ∏à s·∫Ω nh·∫≠n x√©t sau nha üòä)</p>';
            sentenceQnAData_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'qna-item';
                div.innerHTML = `
                    <p><strong>${index + 1}. ${item.question}</strong></p>
                    <textarea id="b13-qna-ans-${item.id}" placeholder="${item.exampleAnswer}"></textarea>
                    <div class="feedback">ƒê√°p √°n c·ªßa em s·∫Ω ƒë∆∞·ª£c ËÄÅÂ∏à xem sau.</div>
                `;
                container.appendChild(div);
                document.getElementById(`b13-qna-ans-${item.id}`).addEventListener('change', (e) => {
                    userAnswers_B13[`sentenceQnA_${item.id}`] = { question: item.question, userAnswer: e.target.value, isSelfAssessed: true };
                });
            });
        }

        function populateYouMeiyou_B13(){
            const container = document.getElementById('sentence-completion-youmeiyou');
            container.innerHTML = '<h3>3. Áî® "Êúâ" Êàñ "Ê≤°Êúâ" ÂÆåÊàêÂè•Â≠ê (D√πng "c√≥" ho·∫∑c "kh√¥ng c√≥" ho√†n th√†nh c√¢u):</h3> <p class="instruction-text">‚úçÔ∏è Ho√†n th√†nh c√°c c√¢u sau b·∫±ng c√°ch ƒëi·ªÅn "Êúâ (y«íu)" ho·∫∑c "Ê≤°Êúâ (m√©iy«íu)".</p>';
            youMeiyouData_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'youmeiyou-item';
                let sentenceHtml = '';
                const numAnswers = Array.isArray(item.answers) ? item.answers.length : (item.answer ? 1 : 0);
                let partIndex = 0;
                for (let i = 0; i < numAnswers; i++) {
                    sentenceHtml += `<span>${item.parts[partIndex++]}</span>`;
                    sentenceHtml += `<input type="text" id="b13-ym-${item.id}-${i}" class="youmeiyou-blank" placeholder="Êúâ/Ê≤°Êúâ">`;
                }
                if (partIndex < item.parts.length) { // Add remaining part if any
                    sentenceHtml += `<span>${item.parts[partIndex]}</span>`;
                }

                div.innerHTML = `
                    <p><strong>C√¢u ${index + 1}:</strong> ${sentenceHtml}</p>
                    <button onclick="checkYouMeiyou_B13('${item.id}', this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:5px;">Ki·ªÉm tra</button>
                    <div id="b13-ym-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }

        function populateReadingQuestions_B13(){
            const container = document.querySelector('#section-reading .reading-comprehension');
            const h3Questions = container.querySelector('h3:nth-of-type(2)');
            // Clear previous questions if any, except for the h3 and p
            let currentElement = h3Questions.nextSibling;
            while(currentElement && currentElement.tagName !== 'P') { // Remove elements until the instruction P
                currentElement = currentElement.nextSibling;
            }
            if(currentElement && currentElement.tagName === 'P') currentElement = currentElement.nextSibling; // Move past the P

            while(currentElement) {
                let next = currentElement.nextSibling;
                currentElement.parentNode.removeChild(currentElement);
                currentElement = next;
            }


            readingQuestions_B13.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <p><strong>${index + 1}. ${item.question}</strong></p>
                    <textarea id="b13-rq-${item.id}" placeholder="Tr·∫£ l·ªùi b·∫±ng ti·∫øng Trung..."></textarea>
                    <div class="feedback">ƒê√°p √°n c·ªßa em s·∫Ω ƒë∆∞·ª£c ËÄÅÂ∏à xem sau.</div>
                `;
                container.appendChild(div); // Append after all existing content within .reading-comprehension
                 document.getElementById(`b13-rq-${item.id}`).addEventListener('change', (e) => {
                    userAnswers_B13[`readingQuestion_${item.id}`] = { question: item.question, userAnswer: e.target.value, isSelfAssessed: true };
                });
            });
        }

        function populateDescribeLuggage_B13(){
            const container = document.getElementById('luggage-description-area');
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const div = document.createElement('div');
                div.className = 'describe-luggage-item';
                div.innerHTML = `
                    <label for="b13-luggage-item-${i}">‰∏úË•ø ${i}:</label>
                    <input type="text" id="b13-luggage-item-${i}" placeholder="T√™n ƒë·ªì v·∫≠t (H√°n t·ª±)">
                    <label for="b13-luggage-color-${i}">È¢úËâ≤:</label>
                    <input type="text" id="b13-luggage-color-${i}" placeholder="M√†u s·∫Øc (H√°n t·ª±)">
                    <label for="b13-luggage-usage-${i}">‰ªÄ‰πàÊó∂ÂÄô‰ΩøÁî®:</label>
                    <input type="text" id="b13-luggage-usage-${i}" placeholder="Khi n√†o d√πng (ti·∫øng Trung)">
                `;
                container.appendChild(div);
                ['item', 'color', 'usage'].forEach(field => {
                    document.getElementById(`b13-luggage-${field}-${i}`).addEventListener('change', (e) => {
                        if (!userAnswers_B13[`describeLuggage_${i}`]) userAnswers_B13[`describeLuggage_${i}`] = {isSelfAssessed: true};
                        userAnswers_B13[`describeLuggage_${i}`][field] = e.target.value;
                    });
                });
            }
        }


        // --- Check Functions for Bai 13 (Examples) ---
        function checkHanziMatching_B13() {
            let sectionScore = 0;
            userAnswers_B13['hanziMatching_B13'] = [];
            hanziMatchingData_B13.forEach(item => {
                const pinyinSelect = document.getElementById(`b13-pinyin-select-${item.id}`);
                const feedbackEl = document.getElementById(`b13-match-feedback-${item.id}`);
                const userPinyin = pinyinSelect.value;
                let isCorrect = (userPinyin === item.pinyin);

                if (isCorrect) {
                    feedbackEl.textContent = 'üéâ Ch√≠nh x√°c!';
                    feedbackEl.className = 'feedback correct';
                    sectionScore++;
                } else {
                    feedbackEl.textContent = `üò¢ Ch∆∞a ƒë√∫ng. Pinyin ƒë√∫ng: ${item.pinyin}`;
                    feedbackEl.className = 'feedback incorrect';
                }
                pinyinSelect.disabled = true;
                userAnswers_B13['hanziMatching_B13'].push({
                    id: item.id, hanzi: item.hanzi, userPinyin: userPinyin, correctPinyin: item.pinyin, isCorrect: isCorrect
                });
            });
            updateScore_B13(sectionScore);
            document.querySelector('#hanzi-matching button.action-button').disabled = true;
        }

        function normalizePinyin_B13(pinyin) {
            if (!pinyin) return "";
            let str = pinyin.toLowerCase();
            str = str.replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π√º«ñ«ò«ö«ú]/g, 'u').replace(/\s+/g, '');
            return str;
        }

        function checkImageVocab_B13(itemId, correctAnswer, buttonElement) {
            const inputEl = document.getElementById(`b13-iv-${itemId}`);
            const userAnswer = inputEl.value.trim();
            const feedbackEl = document.getElementById(`b13-iv-feedback-${itemId}`);
            let isCorrect = (userAnswer === correctAnswer);

            if(isCorrect) {
                feedbackEl.textContent = 'üñºÔ∏èüëç Ch√≠nh x√°c!';
                feedbackEl.className = 'feedback correct';
                updateScore_B13(1);
            } else {
                feedbackEl.textContent = `ü§î Sai r·ªìi. ƒê√°p √°n: ${correctAnswer}`;
                feedbackEl.className = 'feedback incorrect';
            }
            inputEl.disabled = true;
            buttonElement.disabled = true;
            userAnswers_B13[`imageVocab_${itemId}`] = { userAnswer, correctAnswer, isCorrect };
        }

        function checkQuantifier_B13(itemId, correctAnswer, buttonElement) {
            const inputEl = document.getElementById(`b13-qf-${itemId}`);
            const userAnswer = inputEl.value.trim();
            const feedbackEl = document.getElementById(`b13-qf-feedback-${itemId}`);
            let isCorrect = (userAnswer === correctAnswer);

            if(isCorrect) {
                feedbackEl.textContent = 'üìè‚úîÔ∏è ƒê√∫ng r·ªìi!';
                feedbackEl.className = 'feedback correct';
                updateScore_B13(1);
            } else {
                feedbackEl.textContent = `ü§î Ch∆∞a ƒë√∫ng. ƒê√°p √°n: ${correctAnswer}`;
                feedbackEl.className = 'feedback incorrect';
            }
            inputEl.disabled = true;
            buttonElement.disabled = true;
            userAnswers_B13[`quantifierFill_${itemId}`] = { userAnswer, correctAnswer, isCorrect };
        }

        let selectedSentenceFillOptions = {};

        function selectSentenceFillOption(buttonEl, itemId, selectedOption) {
            const itemContainer = buttonEl.closest('.sentence-fill-item');
            const blanks = itemContainer.querySelectorAll('.blank');
            if (!selectedSentenceFillOptions[itemId]) {
                 selectedSentenceFillOptions[itemId] = Array(blanks.length).fill(null);
            }

            let filled = false;
            for (let i = 0; i < blanks.length; i++) {
                if (blanks[i].textContent === '(ch·ªçn)' || blanks[i].dataset.filled !== 'true') {
                    blanks[i].textContent = selectedOption;
                    blanks[i].style.color = 'var(--primary-color)'; // Change color of filled blank
                    blanks[i].dataset.filled = 'true';
                    selectedSentenceFillOptions[itemId][i] = selectedOption;
                    filled = true;
                    break;
                }
            }
            if(filled) buttonEl.disabled = true;
        }

        function checkSentenceFill_B13(itemId, buttonElement) {
            const itemData = sentenceFillBlanksData_B13.find(i => i.id === itemId);
            const feedbackEl = document.getElementById(`b13-sf-feedback-${itemId}`);
            const userSelectedAnswers = selectedSentenceFillOptions[itemId] || [];
            let allCorrect = true;
            let scoreForThisItem = 0;

            itemData.answers.forEach((correctAnswer, i) => {
                if (userSelectedAnswers[i] !== correctAnswer) {
                    allCorrect = false;
                } else {
                    scoreForThisItem++;
                }
            });

            if (allCorrect && userSelectedAnswers.length === itemData.answers.length) {
                feedbackEl.textContent = 'üìù‚úîÔ∏è Ho√†n h·∫£o!';
                feedbackEl.className = 'feedback correct';
            } else {
                feedbackEl.textContent = `ü§î Xem l·∫°i nh√©. ƒê√°p √°n ƒë√∫ng: ${itemData.answers.join(' / ')}`;
                feedbackEl.className = 'feedback incorrect';
            }
            updateScore_B13(scoreForThisItem);
            buttonElement.disabled = true;
            const itemContainer = document.getElementById(`b13-sf-feedback-${itemId}`).closest('.sentence-fill-item');
            if(itemContainer) itemContainer.querySelectorAll('.options-inline button').forEach(btn => btn.disabled = true);

            userAnswers_B13[`sentenceFill_${itemId}`] = { userAnswer: userSelectedAnswers.join(' / '), correctAnswer: itemData.answers.join(' / '), isCorrect: allCorrect };
        }


        function checkYouMeiyou_B13(itemId, buttonElement) {
            const itemData = youMeiyouData_B13.find(i => i.id === itemId);
            const feedbackEl = document.getElementById(`b13-ym-feedback-${itemId}`);
            let allCorrectInItem = true;
            let userAnswersArray = [];
            let scoreForThis = 0;

            const numBlanks = Array.isArray(itemData.answers) ? itemData.answers.length : 1;

            for (let i = 0; i < numBlanks; i++) {
                const inputEl = document.getElementById(`b13-ym-${itemId}-${i}`);
                const userAnswer = inputEl.value.trim();
                userAnswersArray.push(userAnswer);
                const correctAnswer = Array.isArray(itemData.answers) ? itemData.answers[i] : itemData.answer;
                if (userAnswer === correctAnswer) {
                    scoreForThis++;
                } else {
                    allCorrectInItem = false;
                }
                inputEl.disabled = true;
            }

            if (allCorrectInItem) {
                feedbackEl.textContent = 'üëç Ch√≠nh x√°c!';
                feedbackEl.className = 'feedback correct';
            } else {
                const correctAnswersText = Array.isArray(itemData.answers) ? itemData.answers.join(' / ') : itemData.answer;
                feedbackEl.textContent = `ü§î Ch∆∞a ƒë√∫ng. ƒê√°p √°n: ${correctAnswersText}`;
                feedbackEl.className = 'feedback incorrect';
            }
            updateScore_B13(scoreForThis);
            buttonElement.disabled = true;
            userAnswers_B13[`youMeiyou_${itemId}`] = { userAnswer: userAnswersArray.join(' / '), correctAnswer: Array.isArray(itemData.answers) ? itemData.answers.join(' / ') : itemData.answer, isCorrect: allCorrectInItem };
        }


        function showFinalSummary_B13() {
            if(timerInterval_B13) clearInterval(timerInterval_B13);
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('next-section-button').classList.add('hidden');
            document.getElementById('finish-game-button').classList.add('hidden');

            document.getElementById('total-time-taken').textContent = formatTime_B13(secondsElapsed_B13);
            document.getElementById('total-score').textContent = score_B13;

            const detailsUl = document.getElementById('summary-details');
            detailsUl.innerHTML = '';

            if (userAnswers_B13.hanziMatching_B13) {
                const li = document.createElement('li');
                let correctCount = userAnswers_B13.hanziMatching_B13.filter(a => a.isCorrect).length;
                li.innerHTML = `<strong>Ph·∫ßn I.1 - N·ªëi Ch·ªØ H√°n:</strong> ${correctCount}/${hanziMatchingData_B13.length} ƒë√∫ng.`;
                li.classList.add(correctCount === hanziMatchingData_B13.length ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
            }
            // Th√™m t·ªïng k·∫øt cho c√°c ph·∫ßn kh√°c t∆∞∆°ng t·ª±...

            document.getElementById('final-summary').classList.remove('hidden');
            window.scrollTo(0, document.getElementById('final-summary').offsetTop - 20);
        }

    </script>
</body>
</html>
