<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrÃ² ChÆ¡i Ã”n Táº­p Tiáº¿ng Trung - BÃ i 7: ä½ åƒä»€ä¹ˆ</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: 'Arial', sans-serif;
            --cute-pink: #ff69b4;
            --cute-blue: #87ceeb;
        }

        body {
            font-family: var(--font-family);
            background-color: #eef2f7;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .game-container {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInGame 0.7s ease-out forwards;
        }

        @keyframes fadeInGame {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        h1 { font-size: 2em; }
        h2 { font-size: 1.6em; color: var(--secondary-color); margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid var(--cute-blue); padding-bottom: 5px;}
        h3 { font-size: 1.3em; color: var(--dark-color); margin-top: 20px; margin-bottom: 10px;}

        .game-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: var(--light-color);
        }
        .game-section.hidden { display: none; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--cute-blue);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        #timer, #score-display { font-weight: bold; }

        /* Ná»‘i chá»¯ HÃ¡n */
        .matching-game table {
            width: 100%;
            border-collapse: collapse;
        }
        .matching-game th, .matching-game td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .matching-game th { background-color: #f0f0f0; }
        .matching-game select { padding: 5px; border-radius: 4px; min-width: 100px;}
        .matching-item { margin-bottom: 10px; }

        /* Táº­p viáº¿t chá»¯ HÃ¡n */
        .writing-practice-item { margin-bottom: 15px; }
        .writing-practice-item label { display: block; margin-bottom: 5px; font-weight: bold;}
        .writing-practice-item input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
            margin-right: 10px;
        }
        .writing-practice-item .show-answer-btn {
            padding: 6px 10px;
            background-color: var(--info-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .writing-practice-item .correct-hanzi { color: var(--success-color); font-weight: bold; margin-left: 10px; }

        /* Tá»« vá»±ng - HoÃ n thÃ nh báº£ng */
        .vocab-table-fill td input { width: 90%; padding: 5px; }
        .vocab-table-fill .instruction-text {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 10px;
            background-color: #e6f7ff;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--info-color);
        }

        /* Chá»n tá»« Ä‘Ãºng */
        .multiple-choice-item { margin-bottom: 20px; }
        .multiple-choice-item img { max-width: 150px; max-height: 100px; display: block; margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px;}
        .multiple-choice-item .options button {
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            background-color: white;
            color: var(--primary-color);
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .multiple-choice-item .options button:hover { background-color: var(--primary-color); color: white; }
        .multiple-choice-item .options button.selected { background-color: var(--cute-pink); color: white; border-color: var(--cute-pink); }


        /* Sáº¯p xáº¿p cÃ¢u */
        .sentence-scramble-item { margin-bottom: 20px; }
        .word-bank, .sentence-dropzone {
            padding: 10px;
            margin: 5px 0;
            border: 1px dashed #ccc;
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .draggable-word {
            padding: 5px 10px;
            background-color: var(--cute-blue);
            color: white;
            border-radius: 15px;
            cursor: grab;
            user-select: none;
        }
        .draggable-word:active { cursor: grabbing; }

        /* Dá»‹ch cÃ¢u */
        .translation-item textarea { width: 95%; min-height: 50px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }

        /* Ngá»¯ Ã¢m */
        .tone-practice-item { margin-bottom: 10px; display: flex; align-items: center; gap: 10px;}
        .tone-practice-item select { padding: 5px; }

        /* HoÃ n thÃ nh há»™i thoáº¡i */
        .dialogue-fill input[type="text"] {
            border: none;
            border-bottom: 1px solid var(--primary-color);
            padding: 3px;
            margin: 0 3px;
            width: 100px;
            text-align: center;
        }

        /* Viáº¿t Ä‘oáº¡n vÄƒn */
        #short-paragraph { width: 98%; min-height: 100px; padding: 10px; border-radius: 4px; border: 1px solid #ccc;}

        /* Chung */
        .feedback { margin-top: 5px; font-style: italic; }
        .feedback.correct { color: var(--success-color); }
        .feedback.incorrect { color: var(--danger-color); }

        .action-button {
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: block;
            margin: 20px auto;
        }
        .action-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .action-button.next-section-btn { background-color: var(--primary-color); }
        .action-button.next-section-btn:hover { background-color: #0056b3; }


        #final-summary {
            padding: 20px;
            background-color: var(--light-color);
            border: 2px solid var(--cute-pink);
            border-radius: 10px;
            margin-top: 30px;
        }
        #final-summary h2 { color: var(--cute-pink); }
        #final-summary ul { list-style-type: none; padding-left: 0; }
        #final-summary li { margin-bottom: 8px; padding: 5px; border-radius: 4px; }
        #final-summary li.correct-ans { background-color: #d4edda; color: #155724; }
        #final-summary li.incorrect-ans { background-color: #f8d7da; color: #721c24; }
        #final-summary li.incorrect-ans .user-answer { text-decoration: line-through; margin-right: 5px;}
        #final-summary li .correct-value { font-weight: bold; }

        .new-word-highlight {
            color: var(--danger-color);
            font-weight: bold;
            cursor: help;
            position: relative;
            border-bottom: 1px dotted var(--danger-color);
        }
        .tooltip-text {
            visibility: hidden;
            width: max-content;
            max-width: 200px;
            background-color: var(--dark-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-color) transparent transparent transparent;
        }
        .new-word-highlight:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

    </style>
</head>
<body>
    <div class="game-container">
        <h1>ä½ å¥½! ChÃ o má»«ng em Ä‘áº¿n vá»›i TrÃ² ChÆ¡i Ã”n Táº­p BÃ i 7: ä½ åƒä»€ä¹ˆ ğŸœ</h1>
        <p style="text-align:center; font-size: 1.1em; color: var(--secondary-color);">HÃ£y cÃ¹ng nhau cá»§ng cá»‘ kiáº¿n thá»©c Ä‘Ã£ há»c má»™t cÃ¡ch tháº­t vui nhÃ©! ğŸ˜‰</p>

        <div class="status-bar">
            <div id="timer">â³ Thá»i gian: 00:00:00</div>
            <div id="score-display">Äiá»ƒm: 0</div>
        </div>

        <div id="section-hanzi" class="game-section">
            <h2>I. Chá»¯ HÃ¡n (æ±‰å­—) âœï¸</h2>
            <div id="hanzi-matching">
                <h3>1. Ná»‘i chá»¯ HÃ¡n vá»›i phiÃªn Ã¢m vÃ  nghÄ©a Ä‘Ãºng:</h3>
                <p class="instruction-text">ğŸ’¡ HÃ£y chá»n phiÃªn Ã¢m (Pinyin) vÃ  nghÄ©a tiáº¿ng Viá»‡t tÆ°Æ¡ng á»©ng cho má»—i chá»¯ HÃ¡n trong báº£ng dÆ°á»›i Ä‘Ã¢y. Cá»‘ lÃªn nÃ o!</p>
                <table>
                    <thead>
                        <tr>
                            <th>Chá»¯ HÃ¡n</th>
                            <th>PhiÃªn Ã¢m (Pinyin)</th>
                            <th>NghÄ©a tiáº¿ng Viá»‡t</th>
                            <th>Káº¿t quáº£</th>
                        </tr>
                    </thead>
                    <tbody id="hanzi-matching-body">
                        </tbody>
                </table>
                <button onclick="checkHanziMatching()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Kiá»ƒm tra pháº§n ná»‘i tá»«</button>
            </div>

            <div id="hanzi-writing" style="margin-top: 20px;">
                <h3>2. Táº­p viáº¿t chá»¯ HÃ¡n:</h3>
                <p class="instruction-text">âœï¸ Giá» mÃ¬nh cÃ¹ng thá»­ tÃ i nhá»› máº·t chá»¯ nÃ o! HÃ£y gÃµ chá»¯ HÃ¡n dá»±a vÃ o phiÃªn Ã¢m vÃ  nghÄ©a cho sáºµn. Em cÃ³ thá»ƒ nháº¥n "Xem Ä‘Ã¡p Ã¡n" Ä‘á»ƒ tá»± kiá»ƒm tra nhÃ©! â¤ï¸</p>
                </div>
        </div>

        <div id="section-vocab" class="game-section hidden">
            <h2>II. Tá»« Vá»±ng (ç”Ÿè¯) ğŸ“–</h2>
            <div id="vocab-table-fill">
                <h3>1. HoÃ n thÃ nh báº£ng tá»« vá»±ng:</h3>
                <p class="instruction-text">ğŸ“ CÃ¹ng Ä‘iá»n phiÃªn Ã¢m (Pinyin) hoáº·c nghÄ©a tiáº¿ng Viá»‡t cÃ²n thiáº¿u vÃ o báº£ng. Khi Ä‘iá»n Pinyin, em cÃ³ thá»ƒ gÃµ khÃ´ng cáº§n dáº¥u thanh Ä‘iá»‡u (vÃ­ dá»¥: "shangwu" cho "shÃ ngwÇ”").</p>
                <table>
                    <thead>
                        <tr>
                            <th>Chá»¯ HÃ¡n</th>
                            <th>PhiÃªn Ã¢m (Pinyin)</th>
                            <th>NghÄ©a tiáº¿ng Viá»‡t</th>
                        </tr>
                    </thead>
                    <tbody id="vocab-fill-body">
                        </tbody>
                </table>
                 <button onclick="checkVocabFill()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Kiá»ƒm tra báº£ng tá»« vá»±ng</button>
            </div>

            <div id="vocab-multiple-choice" style="margin-top: 20px;">
                <h3>2. Chá»n tá»« Ä‘Ãºng:</h3>
                <p class="instruction-text">ğŸ¤” HÃ£y chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng nháº¥t cho má»—i hÃ¬nh áº£nh hoáº·c mÃ´ táº£. (è€å¸ˆ sáº½ sá»›m cáº­p nháº­t hÃ¬nh áº£nh tháº­t sinh Ä‘á»™ng nhÃ©! ğŸ˜‰)</p>
                </div>
            <div id="vocab-translation" style="margin-top: 20px;">
                <h3>3. Dá»‹ch tá»« Viá»‡t sang Trung:</h3>
                <p class="instruction-text">ğŸ”„ Thá»­ thÃ¡ch dá»‹ch cÃ¡c tá»« sau tá»« tiáº¿ng Viá»‡t sang tiáº¿ng Trung nÃ o!</p>
                </div>
        </div>

        <div id="section-sentence" class="game-section hidden">
            <h2>III. Máº«u CÃ¢u (å¥å‹) ğŸ—£ï¸</h2>
            <div id="sentence-scramble">
                <h3>1. Sáº¯p xáº¿p tá»« thÃ nh cÃ¢u hoÃ n chá»‰nh:</h3>
                <p class="instruction-text">ğŸ§© KÃ©o vÃ  tháº£ cÃ¡c tá»«/cá»¥m tá»« vÃ o Ã´ bÃªn dÆ°á»›i Ä‘á»ƒ táº¡o thÃ nh má»™t cÃ¢u tiáº¿ng Trung hoÃ n chá»‰nh vÃ  cÃ³ nghÄ©a nhÃ©!</p>
                </div>
            <div id="sentence-translation" style="margin-top: 20px;">
                <h3>2. Dá»‹ch cÃ¢u sang tiáº¿ng Trung:</h3>
                <p class="instruction-text">âœï¸ MÃ¬nh cÃ¹ng váº­n dá»¥ng kiáº¿n thá»©c Ä‘á»ƒ dá»‹ch nhá»¯ng cÃ¢u nÃ y sang tiáº¿ng Trung tháº­t chuáº©n nÃ o!</p>
                </div>
            <div id="sentence-qna" style="margin-top: 20px;">
                <h3>3. Tráº£ lá»i cÃ¢u há»i (dá»±a vÃ o báº£n thÃ¢n):</h3>
                <p class="instruction-text">ğŸ’¬ HÃ£y tráº£ lá»i cÃ¡c cÃ¢u há»i sau báº±ng tiáº¿ng Trung theo suy nghÄ© vÃ  tÃ¬nh hÃ¬nh thá»±c táº¿ cá»§a em nhÃ©! (Pháº§n nÃ y khÃ´ng cháº¥m Ä‘iá»ƒm tá»± Ä‘á»™ng, em cÃ³ thá»ƒ nhá» è€å¸ˆ xem giÃºp nha ğŸ’–)</p>
                </div>
            <div id="sentence-creation" style="margin-top: 20px;">
                <h3>4. Äáº·t cÃ¢u vá»›i tá»«/cáº¥u trÃºc cho sáºµn:</h3>
                <p class="instruction-text">ğŸ’¡ Thá»a sá»©c sÃ¡ng táº¡o vÃ  Ä‘áº·t nhá»¯ng cÃ¢u tháº­t hay vá»›i cÃ¡c tá»« vÃ  cáº¥u trÃºc Ä‘Æ°á»£c gá»£i Ã½! (Pháº§n nÃ y cÅ©ng Ä‘á»ƒ em tá»± do thá»ƒ hiá»‡n, è€å¸ˆ sáº½ xem sau nhÃ© ğŸ˜Š)</p>
                </div>
        </div>

        <div id="section-pronunciation" class="game-section hidden">
            <h2>IV. Ngá»¯ Ã‚m (è¯­éŸ³) - Biáº¿n Ä‘iá»‡u cá»§a "ä¸€ (yÄ«)" ğŸ¤</h2>
            <div id="tone-practice">
                <h3>1. Em hÃ£y chá»n thanh Ä‘iá»‡u Ä‘Ãºng cá»§a "ä¸€" trong cÃ¡c tá»« sau:</h3>
                <p class="instruction-text">ğŸ‘‚ Láº¯ng nghe (tÆ°á»Ÿng tÆ°á»£ng ğŸ˜‰) vÃ  chá»n thanh Ä‘iá»‡u chÃ­nh xÃ¡c cho chá»¯ "ä¸€" trong má»—i tá»«.</p>
                </div>
            <div id="tone-rules" style="margin-top: 20px;">
                <h3>2. Giáº£i thÃ­ch quy táº¯c biáº¿n Ä‘iá»‡u cá»§a "ä¸€" (yÄ«):</h3>
                <p>Khi "ä¸€" Ä‘á»©ng má»™t mÃ¬nh, á»Ÿ cuá»‘i tá»« hoáº·c biá»ƒu thá»‹ sá»‘ thá»© tá»±, nÃ³ mang thanh 1 (yÄ«).</p>
                <p>Khi "ä¸€" Ä‘á»©ng trÆ°á»›c má»™t tá»« mang thanh 1, 2, hoáº·c 3, nÃ³ sáº½ biáº¿n thÃ nh thanh 4 (yÃ¬). VÃ­ dá»¥: ä¸€å¤© (yÃ¬ tiÄn), ä¸€å¹´ (yÃ¬ niÃ¡n), ä¸€æœ¬ (yÃ¬ bÄ›n).</p>
                <p>Khi "ä¸€" Ä‘á»©ng trÆ°á»›c má»™t tá»« mang thanh 4, nÃ³ sáº½ biáº¿n thÃ nh thanh 2 (yÃ­). VÃ­ dá»¥: ä¸€ä¸ª (yÃ­ gÃ¨).</p>
            </div>
        </div>

        <div id="section-comprehensive" class="game-section hidden">
            <h2>V. Luyá»‡n Táº­p Tá»•ng Há»£p (ç»¼åˆç»ƒä¹ ) ğŸ¯</h2>
            <div id="dialogue-completion">
                <h3>1. HoÃ n thÃ nh Ä‘oáº¡n há»™i thoáº¡i ngáº¯n:</h3>
                <p class="instruction-text">ğŸ—£ï¸ Äiá»n tá»« cÃ²n thiáº¿u vÃ o chá»— trá»‘ng Ä‘á»ƒ hoÃ n thÃ nh cuá»™c trÃ² chuyá»‡n thÃº vá»‹ nÃ y nhÃ©!</p>
                A: ä½ å¥½ï¼ç°åœ¨å‡ ç‚¹ï¼Ÿ (NÇ hÇo! XiÃ nzÃ i jÇ diÇn?) <br>
                B: ä½ å¥½ï¼ç°åœ¨ <input type="text" id="dialogue-blank-1" data-answer="ä¹ç‚¹"> ç‚¹ã€‚ä½  <input type="text" id="dialogue-blank-2" data-answer="åƒ"> (Äƒn) ä»€ä¹ˆï¼Ÿ (NÇ chÄ« shÃ©nme?) <br>
                A: æˆ‘åƒ <input type="text" id="dialogue-blank-3" data-answer="é¢æ¡">ã€‚ä½ å‘¢ï¼Ÿ (WÇ’ chÄ« __________. NÇ ne?) <br>
                B: æˆ‘æƒ³åƒ <input type="text" id="dialogue-blank-4" data-answer="åŒ…å­">ã€‚ (WÇ’ xiÇng chÄ« __________.) æˆ‘ä»¬ä¸€èµ·å» <input type="text" id="dialogue-blank-5" data-answer="é¥­é¦†"> (nhÃ  hÃ ng/quÃ¡n Äƒn) åƒé¥­ï¼Œå¥½å—ï¼Ÿ (WÇ’men yÃ¬qÇ qÃ¹ __________ chÄ«fÃ n, hÇo ma?) <br>
                A: å¤ªå¥½äº†ï¼(TÃ i hÇo le!)
                <div id="dialogue-feedback" class="feedback"></div>
                 <button onclick="checkDialogue()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Kiá»ƒm tra há»™i thoáº¡i</button>
            </div>

            <div id="paragraph-writing" style="margin-top: 20px;">
                <h3>2. Viáº¿t má»™t Ä‘oáº¡n vÄƒn ngáº¯n (khoáº£ng 3-5 cÃ¢u) ká»ƒ vá» bá»¯a Äƒn yÃªu thÃ­ch cá»§a em báº±ng tiáº¿ng Trung.</h3>
                <p class="instruction-text">ğŸ“ (Gá»£i Ã½: Em thÃ­ch Äƒn gÃ¬? ThÆ°á»ng Äƒn á»Ÿ Ä‘Ã¢u? Ä‚n cÃ¹ng vá»›i ai? Táº¡i sao em thÃ­ch mÃ³n Ä‘Ã³? Pháº§n nÃ y em tá»± do sÃ¡ng táº¡o vÃ  cÃ³ thá»ƒ nhá» è€å¸ˆ kiá»ƒm tra sau nhÃ©! ğŸŒŸ)</p>
                <textarea id="short-paragraph" placeholder="Viáº¿t Ä‘oáº¡n vÄƒn cá»§a em vÃ o Ä‘Ã¢y..."></textarea>
            </div>
        </div>

        <button id="next-section-button" class="action-button next-section-btn" onclick="nextSection()">Tiáº¿p tá»¥c pháº§n sau ğŸš€</button>
        <button id="finish-game-button" class="action-button hidden" onclick="showFinalSummary()">HoÃ n ThÃ nh & Xem Káº¿t Quáº£ ğŸ‰</button>

        <div id="final-summary" class="hidden">
            <h2>âœ¨ Báº£ng Tá»•ng Káº¿t ThÃ nh TÃ­ch âœ¨</h2>
            <p>ChÃºc má»«ng em Ä‘Ã£ hoÃ n thÃ nh táº¥t cáº£ cÃ¡c thá»­ thÃ¡ch! CÃ¹ng xem láº¡i káº¿t quáº£ nÃ o:</p>
            <p><strong>Tá»•ng thá»i gian lÃ m bÃ i:</strong> <span id="total-time-taken"></span></p>
            <p><strong>Tá»•ng Ä‘iá»ƒm:</strong> <span id="total-score"></span></p>
            <h3>Chi tiáº¿t cÃ¡c cÃ¢u tráº£ lá»i:</h3>
            <ul id="summary-details"></ul>
            <button onclick="restartGame()" class="action-button" style="background-color: var(--cute-blue);">ChÆ¡i Láº¡i Tá»« Äáº§u ğŸ”</button>
        </div>
    </div>

    <script>
        // --- Dá»¯ liá»‡u cho trÃ² chÆ¡i ---
        const hanziData = [
            { id: 1, hanzi: "åƒ", pinyin: "chÄ«", meaning: "Ä‚n", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 2, hanzi: "å–", pinyin: "hÄ“", meaning: "Uá»‘ng", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 3, hanzi: "æƒ³", pinyin: "xiÇng", meaning: "Muá»‘n, nhá»›, nghÄ©", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 4, hanzi: "é¥­", pinyin: "fÃ n", meaning: "CÆ¡m", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 5, hanzi: "èœ", pinyin: "cÃ i", meaning: "MÃ³n Äƒn, rau", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 6, hanzi: "åšé¥­", pinyin: "zuÃ² fÃ n", meaning: "Náº¥u cÆ¡m", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 7, hanzi: "ç¡è§‰", pinyin: "shuÃ¬jiÃ o", meaning: "Ngá»§", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 8, hanzi: "ä»€ä¹ˆ", pinyin: "shÃ©nme", meaning: "CÃ¡i gÃ¬, gÃ¬", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 9, hanzi: "ä¸Šåˆ", pinyin: "shÃ ngwÇ”", meaning: "Buá»•i sÃ¡ng", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 10, hanzi: "èµ·åºŠ", pinyin: "qÇchuÃ¡ng", meaning: "Thá»©c dáº­y", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] },
            { id: 11, hanzi: "å›å®¶", pinyin: "huÃ­ jiÄ", meaning: "Vá» nhÃ ", optionsPinyin: ["xiÇng", "shÃ©nme", "chÄ«", "shuÃ¬jiÃ o", "zuÃ² fÃ n", "hÄ“", "fÃ n", "cÃ i", "qÇchuÃ¡ng", "huÃ­ jiÄ", "shÃ ngwÇ”"], optionsMeaning: ["Ngá»§", "Náº¥u cÆ¡m", "Ä‚n", "CÃ¡i gÃ¬, gÃ¬", "CÆ¡m", "Muá»‘n, nhá»›, nghÄ©", "Uá»‘ng", "MÃ³n Äƒn, rau", "Vá» nhÃ ", "Buá»•i sÃ¡ng", "Thá»©c dáº­y"] }
        ];

        const hanziWritingData = [
            { pinyin: "shÃ ngwÇ”", meaning: "buá»•i sÃ¡ng", hanzi: "ä¸Šåˆ" },
            { pinyin: "qÇchuÃ¡ng", meaning: "thá»©c dáº­y", hanzi: "èµ·åºŠ" },
            { pinyin: "huÃ­ jiÄ", meaning: "vá» nhÃ ", hanzi: "å›å®¶" },
            { pinyin: "shuÃ¬jiÃ o", meaning: "ngá»§", hanzi: "ç¡è§‰" },
            { pinyin: "zuÃ² fÃ n", meaning: "náº¥u cÆ¡m", hanzi: "åšé¥­" },
            { pinyin: "jÄ«dÃ n", meaning: "trá»©ng gÃ ", hanzi: "é¸¡è›‹" },
            { pinyin: "miÃ ntiÃ¡o", meaning: "mÃ¬ sá»£i", hanzi: "é¢æ¡" },
            { pinyin: "bÄozi", meaning: "bÃ¡nh bao", hanzi: "åŒ…å­" },
            { pinyin: "jiÇozi", meaning: "sá»§i cáº£o", hanzi: "é¥ºå­" },
            { pinyin: "pÃ­jiÇ”", meaning: "bia", hanzi: "å•¤é…’" }
        ];

        const vocabFillData = [
            { hanzi: "ä¸Šåˆ", pinyin: "shÃ ngwÇ”", meaning: "Buá»•i sÃ¡ng" },
            { hanzi: "èµ·åºŠ", pinyin: "qÇchuÃ¡ng", meaning: "Thá»©c dáº­y" },
            { hanzi: "å›å®¶", pinyin: "huÃ­ jiÄ", meaning: "Vá» nhÃ " },
            { hanzi: "ç¡è§‰", pinyin: "shuÃ¬jiÃ o", meaning: "Ngá»§" },
            { hanzi: "æ™šä¸Š", pinyin: "wÇnshang", meaning: "Buá»•i tá»‘i" },
            { hanzi: "ç‚¹", pinyin: "diÇn", meaning: "Giá»" },
            { hanzi: "ç°åœ¨", pinyin: "xiÃ nzÃ i", meaning: "BÃ¢y giá», hiá»‡n táº¡i" },
            { hanzi: "åšé¥­", pinyin: "zuÃ² fÃ n", meaning: "Náº¥u cÆ¡m" },
            { hanzi: "è™¾é¥º", pinyin: "xiÄ jiÇo", meaning: "BÃ¡nh cáº£o tÃ´m/HÃ¡ cáº£o" },
            { hanzi: "é¸¡è›‹", pinyin: "jÄ«dÃ n", meaning: "Trá»©ng gÃ " },
            { hanzi: "åŒ—äº¬çƒ¤é¸­", pinyin: "BÄ›ijÄ«ng kÇoyÄ", meaning: "Vá»‹t quay Báº¯c Kinh" },
            { hanzi: "æ±¤", pinyin: "tÄng", meaning: "Canh, sÃºp" },
            { hanzi: "ç³–è‘«èŠ¦", pinyin: "tÃ¡nghÃºlu", meaning: "Káº¹o há»“ lÃ´" },
            { hanzi: "è‡­è±†è…", pinyin: "chÃ²u dÃ²ufu", meaning: "Äáº­u hÅ© thá»‘i" },
            { hanzi: "ç³¯ç±³é¥­", pinyin: "nuÃ²mÇ fÃ n", meaning: "CÆ¡m náº¿p" },
            { hanzi: "é¤å…", pinyin: "cÄntÄ«ng", meaning: "NhÃ  hÃ ng (sang trá»ng hÆ¡n)" },
            { hanzi: "é¥­é¦†", pinyin: "fÃ nguÇn", meaning: "QuÃ¡n cÆ¡m, tiá»‡m Äƒn" },
            { hanzi: "æ–¹ä¾¿é¢", pinyin: "fÄngbiÃ nmiÃ n", meaning: "MÃ¬ Äƒn liá»n, mÃ¬ gÃ³i" },
            { hanzi: "é¢æ¡", pinyin: "miÃ ntiÃ¡o", meaning: "MÃ¬ sá»£i (tÆ°Æ¡i)" },
            { hanzi: "ä¸€èˆ¬", pinyin: "yÃ¬bÄn", meaning: "BÃ¬nh thÆ°á»ng, tÃ m táº¡m" }
        ];

        const vocabMcqData = [
            { id: 'mcq1', image: 'https://placehold.co/150x100/E8DDCB/000000?text=BÃ¡t+CÆ¡m', question: '(HÃ¬nh áº£nh bÃ¡t cÆ¡m)', options: ['é¢æ¡', 'ç±³é¥­', 'åŒ…å­'], answer: 'ç±³é¥­' },
            { id: 'mcq2', image: 'https://placehold.co/150x100/E8DDCB/000000?text=Cá»‘c+Bia', question: '(HÃ¬nh áº£nh cá»‘c bia)', options: ['æ±¤', 'æ°´', 'å•¤é…’'], answer: 'å•¤é…’' },
            { id: 'mcq3', image: null, question: '(MÃ´ táº£: má»™t mÃ³n Äƒn ná»•i tiáº¿ng cá»§a Báº¯c Kinh)', options: ['è‡­è±†è…', 'åŒ—äº¬çƒ¤é¸­', 'è™¾é¥º'], answer: 'åŒ—äº¬çƒ¤é¸­' },
            { id: 'mcq4', image: null, question: '(MÃ´ táº£: hÃ nh Ä‘á»™ng chuáº©n bá»‹ bá»¯a Äƒn)', options: ['ç¡è§‰', 'èµ·åºŠ', 'åšé¥­'], answer: 'åšé¥­' }
        ];

        const vocabTranslationData = [
            { viet: "Buá»•i sÃ¡ng", chinese: "ä¸Šåˆ" },
            { viet: "Thá»©c dáº­y", chinese: "èµ·åºŠ" },
            { viet: "Vá» nhÃ ", chinese: "å›å®¶" },
            { viet: "Ngá»§", chinese: "ç¡è§‰" },
            { viet: "Náº¥u Äƒn", chinese: "åšé¥­" },
            { viet: "MÃ¬ gÃ³i", chinese: "æ–¹ä¾¿é¢" },
            { viet: "NhÃ  hÃ ng", chinese: "é¤å…" },
            { viet: "QuÃ¡n Äƒn", chinese: "é¥­é¦†" }
        ];

        const sentenceScrambleData = [
            { id: 'sc1', words: ['æˆ‘', 'åƒ', 'åŒ…å­', 'æƒ³', 'ã€‚'], correctAnswer: 'æˆ‘æƒ³åƒåŒ…å­ã€‚' },
            { id: 'sc2', words: ['æ—©ä¸Š', 'æˆ‘', 'ä¸ƒç‚¹', 'èµ·åºŠ', 'ã€‚'], correctAnswer: 'æˆ‘æ—©ä¸Šä¸ƒç‚¹èµ·åºŠã€‚' },
            { id: 'sc3', words: ['å–œæ¬¢', 'åƒ', 'é¢æ¡', 'å¥¹', 'ã€‚'], correctAnswer: 'å¥¹å–œæ¬¢åƒé¢æ¡ã€‚' },
            { id: 'sc4', words: ['å‡ ç‚¹', 'ç°åœ¨', 'ï¼Ÿ'], correctAnswer: 'ç°åœ¨å‡ ç‚¹ï¼Ÿ' },
            { id: 'sc5', words: ['å¾ˆ', 'åŒ—äº¬çƒ¤é¸­', 'å¥½åƒ', 'ã€‚'], correctAnswer: 'åŒ—äº¬çƒ¤é¸­å¾ˆå¥½åƒã€‚' }
        ];

        const sentenceTranslationData = [
            { viet: "TÃ´i muá»‘n Äƒn cÆ¡m.", chinese: "æˆ‘æƒ³åƒé¥­ã€‚" },
            { viet: "BÃ¢y giá» lÃ  10 giá» tá»‘i.", chinese: "ç°åœ¨æ™šä¸Šåç‚¹ã€‚" },
            { viet: "Máº¹ tÃ´i khÃ´ng thÃ­ch Äƒn mÃ¬ gÃ³i, bÃ  áº¥y thÃ­ch Äƒn mÃ¬ tÆ°Æ¡i.", chinese: "æˆ‘å¦ˆå¦ˆä¸å–œæ¬¢åƒæ–¹ä¾¿é¢ï¼Œå¥¹å–œæ¬¢åƒé¢æ¡ã€‚" },
            { viet: "HÃ´m nay tÃ´i Ä‘i nhÃ  hÃ ng Äƒn cÆ¡m.", chinese: "ä»Šå¤©æˆ‘å»é¤å…åƒé¥­ã€‚" },
            { viet: "MÃ³n sÃºp nÃ y ráº¥t ngon.", chinese: "è¿™ä¸ªæ±¤å¾ˆå¥½å–ã€‚" }
        ];
         const sentenceQnAData = [
            { id: 'qna1', question: "ä½ å–œæ¬¢åƒä»€ä¹ˆï¼Ÿ", exampleAnswer: "æˆ‘å–œæ¬¢åƒ..." },
            { id: 'qna2', question: "ä½ å–œæ¬¢å–ä»€ä¹ˆï¼Ÿ", exampleAnswer: "æˆ‘å–œæ¬¢å–..." },
            { id: 'qna3', question: "ä½ å‡ ç‚¹èµ·åºŠï¼Ÿ", exampleAnswer: "æˆ‘æ—©ä¸Š...ç‚¹èµ·åºŠã€‚" },
            { id: 'qna4', question: "ä½ æ™šä¸Šå‡ ç‚¹ç¡è§‰ï¼Ÿ", exampleAnswer: "æˆ‘æ™šä¸Š...ç‚¹ç¡è§‰ã€‚" },
            { id: 'qna5', question: "ä½ å–œæ¬¢åƒæ–¹ä¾¿é¢è¿˜æ˜¯åƒé¢æ¡ï¼Ÿ", exampleAnswer: "æˆ‘å–œæ¬¢åƒ..." }
        ];
        const sentenceCreationData = [
            { id: 'scd1', prompt: "æƒ³ (xiÇng - muá»‘n)", example: "" },
            { id: 'scd2', prompt: "åœ¨å®¶ (zÃ i jiÄ - á»Ÿ nhÃ )", example: "æˆ‘æ™šä¸Š8ç‚¹åœ¨å®¶å­¦ä¹ æ±‰è¯­ã€‚" },
            { id: 'scd3', prompt: "è¿˜æ˜¯ (hÃ¡ishi - hay lÃ )", example: "" },
            { id: 'scd4', prompt: "å¥½åƒ (hÇochÄ« - ngon)", example: "" }
        ];

        const tonePracticeData = [
            { id: 'tp1', word: "ä¸€ä¸ª", context: "y _ gÃ¨", pinyin: "yÄ«", correctAnswer: "Ã­" },
            { id: 'tp2', word: "ä¸€å¤©", context: "y _ tiÄn", pinyin: "yÄ«", correctAnswer: "Ã¬" },
            { id: 'tp3', word: "ä¸€å¹´", context: "y _ niÃ¡n", pinyin: "yÄ«", correctAnswer: "Ã¬" },
            { id: 'tp4', word: "ä¸€æœ¬", context: "y _ bÄ›n", pinyin: "yÄ«", correctAnswer: "Ã¬" },
            { id: 'tp5', word: "ç¬¬ä¸€", context: "dÃ¬ y _", pinyin: "yÄ«", correctAnswer: "Ä«" }
        ];

        let currentSectionIndex = 0;
        const sections = ['section-hanzi', 'section-vocab', 'section-sentence', 'section-pronunciation', 'section-comprehensive'];
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let userAnswers = {};

        document.addEventListener('DOMContentLoaded', () => {
            populateHanziMatching();
            populateHanziWriting();
            populateVocabFill();
            populateVocabMCQ();
            populateVocabTranslation();
            populateSentenceScramble();
            populateSentenceTranslation();
            populateSentenceQnA();
            populateSentenceCreation();
            populateTonePractice();
            showSection(currentSectionIndex);
            startTimer();
        });

        function startTimer() {
            timerInterval = setInterval(() => {
                secondsElapsed++;
                document.getElementById('timer').textContent = `â³ Thá»i gian: ${formatTime(secondsElapsed)}`;
            }, 1000);
        }

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateScore(points) {
            score += points;
            document.getElementById('score-display').textContent = `Äiá»ƒm: ${score}`;
        }

        function showSection(index) {
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            const currentSection = document.getElementById(sections[index]);
            if (currentSection) {
                currentSection.classList.remove('hidden');
            }

            const nextButton = document.getElementById('next-section-button');
            const finishButton = document.getElementById('finish-game-button');
            if (index >= sections.length - 1) {
                if(nextButton) nextButton.classList.add('hidden');
                if(finishButton) finishButton.classList.remove('hidden');
            } else {
                if(nextButton) nextButton.classList.remove('hidden');
                if(finishButton) finishButton.classList.add('hidden');
            }
        }

        function nextSection() {
            currentSectionIndex++;
            if (currentSectionIndex < sections.length) {
                showSection(currentSectionIndex);
            } else {
                showFinalSummary();
            }
        }
        function restartGame() {
            currentSectionIndex = 0;
            score = 0;
            secondsElapsed = 0;
            userAnswers = {};
            document.getElementById('score-display').textContent = `Äiá»ƒm: 0`;
            document.getElementById('timer').textContent = `â³ Thá»i gian: 00:00:00`;

            document.querySelectorAll('input[type="text"], textarea, select').forEach(input => {
                if(input.tagName === 'SELECT') input.selectedIndex = 0;
                else input.value = '';
                input.disabled = false;
                if(input.style.borderColor) input.style.borderColor = '#ccc';
            });
            document.querySelectorAll('.feedback').forEach(fb => {fb.textContent = ''; fb.className = 'feedback';});
            document.querySelectorAll('.correct-hanzi').forEach(ch => ch.textContent = '');
            document.querySelectorAll('.options button').forEach(btn => { btn.classList.remove('selected'); btn.disabled = false; delete btn.dataset.scored;});
            
            sentenceScrambleData.forEach(item => {
                const bank = document.getElementById(`word-bank-${item.id}`);
                const dropzone = document.getElementById(`dropzone-${item.id}`);
                if(dropzone) dropzone.innerHTML = '';
                if(bank) bank.innerHTML = shuffleArray([...item.words]).map(word => `<div class="draggable-word" draggable="true">${word}</div>`).join('');
                makeDraggable(item.id);
                const scrambleButton = document.querySelector(`button[onclick="checkSentenceScramble('${item.id}', \`${item.correctAnswer}\`, this)"]`);
                if(scrambleButton) scrambleButton.disabled = false;
            });

             document.querySelectorAll('.action-button, .show-answer-btn').forEach(btn => btn.disabled = false);
             const hanziMatchingButton = document.querySelector('#hanzi-matching button');
             if(hanziMatchingButton) hanziMatchingButton.disabled = false;
             const vocabFillButton = document.querySelector('#vocab-table-fill button');
             if(vocabFillButton) vocabFillButton.disabled = false;
             const dialogueButton = document.querySelector('#dialogue-completion button');
             if(dialogueButton) dialogueButton.disabled = false;


            document.getElementById('final-summary').classList.add('hidden');
            showSection(currentSectionIndex);
            if (timerInterval) clearInterval(timerInterval);
            startTimer();
        }

        function populateHanziMatching() {
            const tbody = document.getElementById('hanzi-matching-body');
            tbody.innerHTML = '';
            const allPinyins = shuffleArray([...new Set(hanziData.flatMap(item => item.optionsPinyin))]);
            const allMeanings = shuffleArray([...new Set(hanziData.flatMap(item => item.optionsMeaning))]);

            hanziData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.id}. ${item.hanzi}</td>
                    <td>
                        <select id="pinyin-select-${item.id}">
                            <option value="">Chá»n Pinyin</option>
                            ${allPinyins.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select id="meaning-select-${item.id}">
                            <option value="">Chá»n NghÄ©a</option>
                            ${allMeanings.map(m => `<option value="${m}">${m}</option>`).join('')}
                        </select>
                    </td>
                    <td id="match-feedback-${item.id}" class="feedback"></td>
                `;
            });
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function checkHanziMatching() {
            let sectionScore = 0;
            userAnswers['hanziMatching'] = [];
            hanziData.forEach(item => {
                const pinyinSelect = document.getElementById(`pinyin-select-${item.id}`);
                const meaningSelect = document.getElementById(`meaning-select-${item.id}`);
                const feedbackEl = document.getElementById(`match-feedback-${item.id}`);
                const userPinyin = pinyinSelect.value;
                const userMeaning = meaningSelect.value;
                let isCorrect = false;

                if (userPinyin === item.pinyin && userMeaning === item.meaning) {
                    feedbackEl.textContent = 'ğŸ‰ ChÃ­nh xÃ¡c!';
                    feedbackEl.className = 'feedback correct';
                    sectionScore++;
                    isCorrect = true;
                } else {
                    feedbackEl.textContent = `ğŸ˜¢ ChÆ°a Ä‘Ãºng. Pinyin: ${item.pinyin}, NghÄ©a: ${item.meaning}`;
                    feedbackEl.className = 'feedback incorrect';
                }
                pinyinSelect.disabled = true;
                meaningSelect.disabled = true;
                userAnswers['hanziMatching'].push({
                    id: item.id,
                    hanzi: item.hanzi,
                    userPinyin: userPinyin,
                    userMeaning: userMeaning,
                    correctPinyin: item.pinyin,
                    correctMeaning: item.meaning,
                    isCorrect: isCorrect
                });
            });
            updateScore(sectionScore);
            document.querySelector('#hanzi-matching button').disabled = true;
        }

        function populateHanziWriting() {
            const container = document.getElementById('hanzi-writing');
            container.innerHTML = '<h3>2. Táº­p viáº¿t chá»¯ HÃ¡n:</h3> <p class="instruction-text">âœï¸ Giá» mÃ¬nh cÃ¹ng thá»­ tÃ i nhá»› máº·t chá»¯ nÃ o! HÃ£y gÃµ chá»¯ HÃ¡n dá»±a vÃ o phiÃªn Ã¢m vÃ  nghÄ©a cho sáºµn. Em cÃ³ thá»ƒ nháº¥n "Xem Ä‘Ã¡p Ã¡n" Ä‘á»ƒ tá»± kiá»ƒm tra nhÃ©! â¤ï¸</p>';
            hanziWritingData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'writing-practice-item';
                div.innerHTML = `
                    <label for="hanzi-input-${index}">${item.pinyin} (${item.meaning}):</label>
                    <input type="text" id="hanzi-input-${index}" placeholder="GÃµ chá»¯ HÃ¡n">
                    <button class="show-answer-btn" onclick="showHanziAnswer(${index}, this)">Xem Ä‘Ã¡p Ã¡n</button>
                    <span id="correct-hanzi-${index}" class="correct-hanzi"></span>
                    <div id="write-feedback-${index}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }

        function showHanziAnswer(index, buttonElement) {
            const correctHanziEl = document.getElementById(`correct-hanzi-${index}`);
            correctHanziEl.textContent = hanziWritingData[index].hanzi;
            const userInput = document.getElementById(`hanzi-input-${index}`).value;
            const feedbackEl = document.getElementById(`write-feedback-${index}`);
            userAnswers[`hanziWriting_${index}`] = {
                prompt: `${hanziWritingData[index].pinyin} (${hanziWritingData[index].meaning})`,
                userAnswer: userInput,
                correctAnswer: hanziWritingData[index].hanzi,
                isCorrect: userInput === hanziWritingData[index].hanzi
            };
            if (userInput === hanziWritingData[index].hanzi) {
                feedbackEl.textContent = 'ğŸ‰ Giá»i quÃ¡!';
                feedbackEl.className = 'feedback correct';
            } else if (userInput !== "") {
                feedbackEl.textContent = 'ğŸ¤” Thá»­ láº¡i xem sao!';
                feedbackEl.className = 'feedback incorrect';
            }
            buttonElement.disabled = true;
        }

        function normalizePinyin(pinyin) {
            if (!pinyin) return "";
            let str = pinyin.toLowerCase();
            str = str.replace(/[ÄÃ¡ÇÃ ]/g, 'a');
            str = str.replace(/[Ä“Ã©Ä›Ã¨]/g, 'e');
            str = str.replace(/[Ä«Ã­ÇÃ¬]/g, 'i');
            str = str.replace(/[ÅÃ³Ç’Ã²]/g, 'o');
            str = str.replace(/[Å«ÃºÇ”Ã¹Ã¼Ç–Ç˜ÇšÇœ]/g, 'u');
            str = str.replace(/\s+/g, '');
            return str;
        }

        function populateVocabFill() {
            const tbody = document.getElementById('vocab-fill-body');
            tbody.innerHTML = '';
            vocabFillData.forEach((item, index) => {
                const row = tbody.insertRow();
                const hidePinyin = Math.random() < 0.5;
                row.innerHTML = `
                    <td>${item.hanzi}</td>
                    <td>${hidePinyin ? `<input type="text" id="vocab-pinyin-${index}" placeholder="Äiá»n Pinyin (khÃ´ng cáº§n dáº¥u)">` : item.pinyin}</td>
                    <td>${!hidePinyin ? `<input type="text" id="vocab-meaning-${index}" placeholder="Äiá»n NghÄ©a">` : item.meaning}</td>
                    <td id="vocab-fill-feedback-${index}" class="feedback"></td>
                `;
                if (hidePinyin) row.querySelector(`#vocab-pinyin-${index}`).dataset.answer = item.pinyin;
                else row.querySelector(`#vocab-meaning-${index}`).dataset.answer = item.meaning;
            });
        }
        function checkVocabFill() {
            let sectionScore = 0;
            userAnswers['vocabFill'] = [];
            vocabFillData.forEach((item, index) => {
                const pinyinInput = document.getElementById(`vocab-pinyin-${index}`);
                const meaningInput = document.getElementById(`vocab-meaning-${index}`);
                const feedbackEl = document.getElementById(`vocab-fill-feedback-${index}`);
                let isCorrect = false;

                let userAnswerPinyinNormalized = "";
                let correctAnswerPinyinNormalized = normalizePinyin(item.pinyin);
                let userAnswerMeaning = "";

                if (pinyinInput) {
                    userAnswerPinyinNormalized = normalizePinyin(pinyinInput.value.trim());
                    if (userAnswerPinyinNormalized === correctAnswerPinyinNormalized) {
                        sectionScore++;
                        isCorrect = true;
                    }
                     pinyinInput.disabled = true;
                } else if (meaningInput) {
                    userAnswerMeaning = meaningInput.value.trim();
                    if (userAnswerMeaning.toLowerCase() === item.meaning.toLowerCase()) {
                        sectionScore++;
                        isCorrect = true;
                    }
                    meaningInput.disabled = true;
                }

                if (isCorrect) {
                    feedbackEl.textContent = 'ğŸ‘ ÄÃºng rá»“i!';
                    feedbackEl.className = 'feedback correct';
                } else {
                    feedbackEl.textContent = `ğŸ¤” Sai rá»“i. Pinyin: ${item.pinyin}, NghÄ©a: ${item.meaning}`;
                    feedbackEl.className = 'feedback incorrect';
                }
                 userAnswers['vocabFill'].push({
                    hanzi: item.hanzi,
                    userPinyin: pinyinInput ? pinyinInput.value.trim() : "N/A",
                    userMeaning: meaningInput ? userAnswerMeaning : "N/A",
                    correctPinyin: item.pinyin,
                    correctMeaning: item.meaning,
                    isCorrect: isCorrect
                });
            });
            updateScore(sectionScore);
            document.querySelector('#vocab-table-fill button').disabled = true;
        }

        function populateVocabMCQ() {
            const container = document.getElementById('vocab-multiple-choice');
            container.innerHTML = '<h3>2. Chá»n tá»« Ä‘Ãºng:</h3> <p class="instruction-text">ğŸ¤” HÃ£y chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng nháº¥t cho má»—i hÃ¬nh áº£nh hoáº·c mÃ´ táº£. (è€å¸ˆ sáº½ sá»›m cáº­p nháº­t hÃ¬nh áº£nh tháº­t sinh Ä‘á»™ng nhÃ©! ğŸ˜‰)</p>';
            vocabMcqData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'multiple-choice-item';
                div.id = `mcq-item-${item.id}`;
                let imageHtml = item.image ? `<img src="${item.image}" alt="${item.question}">` : '';
                div.innerHTML = `
                    ${imageHtml}
                    <p><strong>${item.question}</strong></p>
                    <div class="options">
                        ${item.options.map(opt => `<button onclick="selectMCQOption(this, '${item.id}', '${opt}')">${opt}</button>`).join('')}
                    </div>
                    <div id="mcq-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }
        function selectMCQOption(buttonEl, itemId, selectedOption) {
            const itemContainer = document.getElementById(`mcq-item-${itemId}`);
            itemContainer.querySelectorAll('.options button').forEach(btn => btn.classList.remove('selected'));
            buttonEl.classList.add('selected');

            const questionData = vocabMcqData.find(q => q.id === itemId);
            const feedbackEl = document.getElementById(`mcq-feedback-${itemId}`);
            let isCorrect = false;
            if (selectedOption === questionData.answer) {
                feedbackEl.textContent = 'ğŸ‰ Tuyá»‡t vá»i!';
                feedbackEl.className = 'feedback correct';
                isCorrect = true;
            } else {
                feedbackEl.textContent = `ğŸ¤” ChÆ°a Ä‘Ãºng rá»“i. ÄÃ¡p Ã¡n lÃ : ${questionData.answer}`;
                feedbackEl.className = 'feedback incorrect';
            }
             userAnswers[`vocabMCQ_${itemId}`] = {
                question: questionData.question,
                userAnswer: selectedOption,
                correctAnswer: questionData.answer,
                isCorrect: isCorrect
            };
            if(isCorrect && !buttonEl.dataset.scored) {
                updateScore(1);
                buttonEl.dataset.scored = true;
                itemContainer.querySelectorAll('.options button').forEach(btn => {
                     btn.disabled = true;
                });
            } else if (!isCorrect) {
                 buttonEl.disabled = true;
            }
        }

        function populateVocabTranslation() {
            const container = document.getElementById('vocab-translation');
            container.innerHTML = '<h3>3. Dá»‹ch tá»« Viá»‡t sang Trung:</h3> <p class="instruction-text">ğŸ”„ Thá»­ thÃ¡ch dá»‹ch cÃ¡c tá»« sau tá»« tiáº¿ng Viá»‡t sang tiáº¿ng Trung nÃ o!</p>';
            vocabTranslationData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'writing-practice-item';
                div.innerHTML = `
                    <label for="vocab-trans-${index}">${item.viet}:</label>
                    <input type="text" id="vocab-trans-${index}" placeholder="GÃµ tiáº¿ng Trung">
                    <button class="show-answer-btn" onclick="checkVocabTranslation(${index}, this)">Kiá»ƒm tra</button>
                    <span id="correct-vocab-trans-${index}" class="correct-hanzi"></span>
                    <div id="vocab-trans-feedback-${index}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }
        function checkVocabTranslation(index, buttonElement) {
            const userInputEl = document.getElementById(`vocab-trans-${index}`);
            const userInput = userInputEl.value.trim();
            const correctAnswer = vocabTranslationData[index].chinese;
            const feedbackEl = document.getElementById(`vocab-trans-feedback-${index}`);
            const correctDisplayEl = document.getElementById(`correct-vocab-trans-${index}`);
            let isCorrect = false;

            if (userInput === correctAnswer) {
                feedbackEl.textContent = 'ğŸ‘ Ráº¥t tá»‘t!';
                feedbackEl.className = 'feedback correct';
                updateScore(1);
                isCorrect = true;
            } else {
                feedbackEl.textContent = 'ğŸ¤” Sai rá»“i. ÄÃ¡p Ã¡n Ä‘Ãºng lÃ :';
                feedbackEl.className = 'feedback incorrect';
                correctDisplayEl.textContent = correctAnswer;
            }
            userInputEl.disabled = true;
            buttonElement.disabled = true;
            userAnswers[`vocabTrans_${index}`] = {
                prompt: vocabTranslationData[index].viet,
                userAnswer: userInput,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            };
        }

        function populateSentenceScramble() {
            const container = document.getElementById('sentence-scramble');
            container.innerHTML = '<h3>1. Sáº¯p xáº¿p tá»« thÃ nh cÃ¢u hoÃ n chá»‰nh:</h3> <p class="instruction-text">ğŸ§© KÃ©o vÃ  tháº£ cÃ¡c tá»«/cá»¥m tá»« vÃ o Ã´ bÃªn dÆ°á»›i Ä‘á»ƒ táº¡o thÃ nh má»™t cÃ¢u tiáº¿ng Trung hoÃ n chá»‰nh vÃ  cÃ³ nghÄ©a nhÃ©!</p>';
            sentenceScrambleData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'sentence-scramble-item';
                div.innerHTML = `
                    <p><strong>CÃ¢u ${index + 1}:</strong> Sáº¯p xáº¿p cÃ¡c tá»« sau:</p>
                    <div id="word-bank-${item.id}" class="word-bank">
                        ${shuffleArray([...item.words]).map(word => `<div class="draggable-word" draggable="true">${word}</div>`).join('')}
                    </div>
                    <p>CÃ¢u cá»§a báº¡n:</p>
                    <div id="dropzone-${item.id}" class="sentence-dropzone"></div>
                    <button onclick="checkSentenceScramble('${item.id}', \`${item.correctAnswer}\`, this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:10px;">Kiá»ƒm tra cÃ¢u ${index + 1}</button>
                    <div id="scramble-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
                makeDraggable(item.id);
            });
        }

        function makeDraggable(itemId) {
            const bank = document.getElementById(`word-bank-${itemId}`);
            const dropzone = document.getElementById(`dropzone-${itemId}`);
            if (!bank || !dropzone) return;
            const draggables = bank.querySelectorAll('.draggable-word');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggable.classList.add('dragging');
                });
                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                });
            });

            [bank, dropzone].forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(zone, e.clientY);
                    const dragging = document.querySelector('.dragging');
                    if (dragging) {
                        if (afterElement == null) {
                            zone.appendChild(dragging);
                        } else {
                            zone.insertBefore(dragging, afterElement);
                        }
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-word:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function checkSentenceScramble(itemId, correctAnswer, buttonElement) {
            const dropzone = document.getElementById(`dropzone-${itemId}`);
            const feedbackEl = document.getElementById(`scramble-feedback-${itemId}`);
            const wordsInDropzone = [...dropzone.querySelectorAll('.draggable-word')].map(w => w.textContent).join('');
            let isCorrect = false;

            if (wordsInDropzone === correctAnswer) {
                feedbackEl.textContent = 'ğŸ‰ HoÃ n háº£o!';
                feedbackEl.className = 'feedback correct';
                updateScore(2);
                isCorrect = true;
            } else {
                feedbackEl.textContent = `ğŸ¤” ChÆ°a Ä‘Ãºng láº¯m. ÄÃ¡p Ã¡n: ${correctAnswer}`;
                feedbackEl.className = 'feedback incorrect';
            }
            dropzone.querySelectorAll('.draggable-word').forEach(w => w.setAttribute('draggable', 'false'));
             const bank = document.getElementById(`word-bank-${itemId}`);
             if(bank) bank.querySelectorAll('.draggable-word').forEach(w => w.setAttribute('draggable', 'false'));
            buttonElement.disabled = true;

            userAnswers[`sentenceScramble_${itemId}`] = {
                prompt: "Sáº¯p xáº¿p tá»«",
                userAnswer: wordsInDropzone,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            };
        }

        function populateSentenceTranslation() {
            const container = document.getElementById('sentence-translation');
            container.innerHTML = '<h3>2. Dá»‹ch cÃ¢u sang tiáº¿ng Trung:</h3> <p class="instruction-text">âœï¸ MÃ¬nh cÃ¹ng váº­n dá»¥ng kiáº¿n thá»©c Ä‘á»ƒ dá»‹ch nhá»¯ng cÃ¢u nÃ y sang tiáº¿ng Trung tháº­t chuáº©n nÃ o!</p>';
            sentenceTranslationData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'translation-item';
                div.innerHTML = `
                    <p><strong>${index + 1}. ${item.viet}</strong></p>
                    <textarea id="sent-trans-${index}" placeholder="Dá»‹ch sang tiáº¿ng Trung..."></textarea>
                    <button onclick="checkSentenceTranslation(${index}, this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:5px;">Kiá»ƒm tra</button>
                    <div id="sent-trans-feedback-${index}" class="feedback"></div>
                `;
                container.appendChild(div);
            });
        }
        function checkSentenceTranslation(index, buttonElement) {
            const textarea = document.getElementById(`sent-trans-${index}`);
            const userAnswer = textarea.value.trim();
            const correctAnswer = sentenceTranslationData[index].chinese;
            const feedbackEl = document.getElementById(`sent-trans-feedback-${index}`);
            let isCorrect = false;
            if (userAnswer.replace(/[ï¼Ÿã€‚ï¼ï¼Œ]/g, '') === correctAnswer.replace(/[ï¼Ÿã€‚ï¼ï¼Œ]/g, '')) {
                feedbackEl.textContent = 'ğŸŒŸ Ráº¥t chuáº©n!';
                feedbackEl.className = 'feedback correct';
                updateScore(2);
                isCorrect = true;
            } else {
                feedbackEl.textContent = `ğŸ¤” Gáº§n Ä‘Ãºng rá»“i! ÄÃ¡p Ã¡n gá»£i Ã½: ${correctAnswer}`;
                feedbackEl.className = 'feedback incorrect';
            }
            textarea.disabled = true;
            buttonElement.disabled = true; // Directly disable the passed button element
             userAnswers[`sentenceTrans_${index}`] = {
                prompt: sentenceTranslationData[index].viet,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            };
        }

        function populateSentenceQnA() {
            const container = document.getElementById('sentence-qna');
            container.innerHTML = '<h3>3. Tráº£ lá»i cÃ¢u há»i (dá»±a vÃ o báº£n thÃ¢n):</h3> <p class="instruction-text">ğŸ’¬ HÃ£y tráº£ lá»i cÃ¡c cÃ¢u há»i sau báº±ng tiáº¿ng Trung theo suy nghÄ© vÃ  tÃ¬nh hÃ¬nh thá»±c táº¿ cá»§a em nhÃ©! (Pháº§n nÃ y khÃ´ng cháº¥m Ä‘iá»ƒm tá»± Ä‘á»™ng, em cÃ³ thá»ƒ nhá» è€å¸ˆ xem giÃºp nha ğŸ’–)</p>';
            sentenceQnAData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'translation-item';
                div.innerHTML = `
                    <p><strong>${index + 1}. ${item.question}</strong></p>
                    <textarea id="qna-ans-${item.id}" placeholder="${item.exampleAnswer}"></textarea>
                    <div class="feedback">Pháº§n nÃ y em tá»± Ä‘Ã¡nh giÃ¡ hoáº·c nhá» è€å¸ˆ xem giÃºp nhÃ©! â¤ï¸</div>
                `;
                container.appendChild(div);
                document.getElementById(`qna-ans-${item.id}`).addEventListener('change', (e) => {
                    userAnswers[`sentenceQnA_${item.id}`] = {
                        question: item.question,
                        userAnswer: e.target.value,
                        isSelfAssessed: true
                    };
                });
            });
        }
        function populateSentenceCreation() {
            const container = document.getElementById('sentence-creation');
            container.innerHTML = '<h3>4. Äáº·t cÃ¢u vá»›i tá»«/cáº¥u trÃºc cho sáºµn:</h3> <p class="instruction-text">ğŸ’¡ Thá»a sá»©c sÃ¡ng táº¡o vÃ  Ä‘áº·t nhá»¯ng cÃ¢u tháº­t hay vá»›i cÃ¡c tá»« vÃ  cáº¥u trÃºc Ä‘Æ°á»£c gá»£i Ã½! (Pháº§n nÃ y cÅ©ng Ä‘á»ƒ em tá»± do thá»ƒ hiá»‡n, è€å¸ˆ sáº½ xem sau nhÃ© ğŸ˜Š)</p>';
            sentenceCreationData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'translation-item';
                div.innerHTML = `
                    <p><strong>${index + 1}. Äáº·t cÃ¢u vá»›i: ${item.prompt}</strong></p>
                    ${item.example ? `<p><i>VÃ­ dá»¥: ${item.example}</i></p>` : ''}
                    <textarea id="scd-ans-${item.id}" placeholder="Viáº¿t cÃ¢u cá»§a em..."></textarea>
                    <div class="feedback">Pháº§n nÃ y em tá»± do sÃ¡ng táº¡o vÃ  nhá» è€å¸ˆ nháº­n xÃ©t nha! ğŸ’–</div>
                `;
                container.appendChild(div);
                document.getElementById(`scd-ans-${item.id}`).addEventListener('change', (e) => {
                    userAnswers[`sentenceCreation_${item.id}`] = {
                        prompt: item.prompt,
                        userAnswer: e.target.value,
                        isSelfAssessed: true
                    };
                });
            });
        }

        function populateTonePractice() {
            const container = document.getElementById('tone-practice');
            container.innerHTML = '<h3>1. Em hÃ£y chá»n thanh Ä‘iá»‡u Ä‘Ãºng cá»§a "ä¸€" trong cÃ¡c tá»« sau:</h3> <p class="instruction-text">ğŸ‘‚ Láº¯ng nghe (tÆ°á»Ÿng tÆ°á»£ng ğŸ˜‰) vÃ  chá»n thanh Ä‘iá»‡u chÃ­nh xÃ¡c cho chá»¯ "ä¸€" trong má»—i tá»«.</p>';
            tonePracticeData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'tone-practice-item';
                div.innerHTML = `
                    <span>${item.word} (${item.context.replace('_', `<select id="tone-select-${item.id}"><option value="">?</option><option value="Ä«">ã„§ (Thanh 1)</option><option value="Ã­">ËŠ (Thanh 2)</option><option value="Ç">Ë‡ (Thanh 3)</option><option value="Ã¬">Ë‹ (Thanh 4)</option></select>`)})</span>
                    <button onclick="checkTone('${item.id}', '${item.correctAnswer}', this)">Kiá»ƒm tra</button>
                    <span id="tone-feedback-${item.id}" class="feedback"></span>
                `;
                container.appendChild(div);
            });
        }
        function checkTone(itemId, correctAnswer, buttonElement) {
            const selectEl = document.getElementById(`tone-select-${itemId}`);
            const userAnswer = selectEl.value;
            const feedbackEl = document.getElementById(`tone-feedback-${itemId}`);
            let isCorrect = false;
            if (userAnswer === correctAnswer) {
                feedbackEl.textContent = 'ğŸ¶ Chuáº©n rá»“i!';
                feedbackEl.className = 'feedback correct';
                updateScore(1);
                isCorrect = true;
            } else {
                feedbackEl.textContent = `ğŸ¤” ChÆ°a Ä‘Ãºng. ÄÃ¡p Ã¡n: ${correctAnswer.replace('Ä«','thanh 1').replace('Ã­','thanh 2').replace('Ç','thanh 3').replace('Ã¬','thanh 4')}`;
                feedbackEl.className = 'feedback incorrect';
            }
            selectEl.disabled = true;
            buttonElement.disabled = true;
            userAnswers[`tonePractice_${itemId}`] = {
                word: tonePracticeData.find(i => i.id === itemId).word,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            };
        }

        function checkDialogue() {
            let sectionScore = 0;
            userAnswers['dialogue'] = [];
            for (let i = 1; i <= 5; i++) {
                const inputEl = document.getElementById(`dialogue-blank-${i}`);
                const userAnswer = inputEl.value.trim();
                const correctAnswer = inputEl.dataset.answer;
                let isCorrect = false;
                if (userAnswer === correctAnswer) {
                    sectionScore++;
                    inputEl.style.borderColor = 'var(--success-color)';
                    isCorrect = true;
                } else {
                    inputEl.style.borderColor = 'var(--danger-color)';
                }
                userAnswers['dialogue'].push({
                    blank: i,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: isCorrect
                });
                inputEl.disabled = true;
            }
            updateScore(sectionScore);
            const feedbackEl = document.getElementById('dialogue-feedback');
            feedbackEl.textContent = `Há»™i thoáº¡i: Báº¡n Ä‘Ãºng ${sectionScore}/5 chá»— trá»‘ng.`;
            feedbackEl.className = sectionScore === 5 ? 'feedback correct' : 'feedback incorrect';
            document.querySelector('#dialogue-completion button').disabled = true;
        }
        document.getElementById('short-paragraph').addEventListener('change', (e) => {
            userAnswers['paragraphWriting'] = {
                userText: e.target.value,
                isSelfAssessed: true
            };
        });

        function showFinalSummary() {
            clearInterval(timerInterval);
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('next-section-button').classList.add('hidden');
            document.getElementById('finish-game-button').classList.add('hidden');

            document.getElementById('total-time-taken').textContent = formatTime(secondsElapsed);
            document.getElementById('total-score').textContent = score;

            const detailsUl = document.getElementById('summary-details');
            detailsUl.innerHTML = '';

            if (userAnswers.hanziMatching) {
                const li = document.createElement('li');
                let correctCount = userAnswers.hanziMatching.filter(a => a.isCorrect).length;
                li.innerHTML = `<strong>Pháº§n I.1 - Ná»‘i Chá»¯ HÃ¡n:</strong> ${correctCount}/${hanziData.length} Ä‘Ãºng.`;
                li.classList.add(correctCount === hanziData.length ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                userAnswers.hanziMatching.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;â””â”€ ${ans.hanzi}: Báº¡n chá»n Pinyin '<span class="user-answer">${ans.userPinyin || "chÆ°a chá»n"}</span>', NghÄ©a '<span class="user-answer">${ans.userMeaning || "chÆ°a chá»n"}</span>'. ÄÃºng: Pinyin '<span class="correct-value">${ans.correctPinyin}</span>', NghÄ©a '<span class="correct-value">${ans.correctMeaning}</span>'.`;
                    detailsUl.appendChild(detailLi);
                });
            }
            hanziWritingData.forEach((item, index) => {
                if (userAnswers[`hanziWriting_${index}`]) {
                    const ans = userAnswers[`hanziWriting_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n I.2 - Viáº¿t '${ans.prompt}':</strong> Báº¡n viáº¿t '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(chÆ°a viáº¿t)"}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            if (userAnswers.vocabFill) {
                const li = document.createElement('li');
                let correctCount = userAnswers.vocabFill.filter(a => a.isCorrect).length;
                let totalFieldsToFill = 0;
                 vocabFillData.forEach((item, index) => {
                    if (document.getElementById(`vocab-pinyin-${index}`) || document.getElementById(`vocab-meaning-${index}`)) {
                        totalFieldsToFill++;
                    }
                });
                li.innerHTML = `<strong>Pháº§n II.1 - Báº£ng Tá»« Vá»±ng:</strong> ${correctCount}/${totalFieldsToFill} Ä‘Ãºng.`;
                li.classList.add(correctCount === totalFieldsToFill ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                 userAnswers.vocabFill.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    let promptText = ans.hanzi;
                    let userText = "";
                    let correctText = "";
                    if(ans.userPinyin !== "N/A"){
                        userText = `Pinyin: '<span class="user-answer">${ans.userPinyin || "(chÆ°a Ä‘iá»n)"}</span>'`;
                        correctText = `Pinyin: '<span class="correct-value">${ans.correctPinyin}</span>'`;
                    } else {
                         userText = `NghÄ©a: '<span class="user-answer">${ans.userMeaning || "(chÆ°a Ä‘iá»n)"}</span>'`;
                         correctText = `NghÄ©a: '<span class="correct-value">${ans.correctMeaning}</span>'`;
                    }
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;â””â”€ Tá»« '${promptText}': Báº¡n Ä‘iá»n ${userText}. ÄÃºng lÃ  ${correctText}.`;
                    detailsUl.appendChild(detailLi);
                });
            }

            vocabMcqData.forEach(item => {
                 if (userAnswers[`vocabMCQ_${item.id}`]) {
                    const ans = userAnswers[`vocabMCQ_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n II.2 - Tráº¯c Nghiá»‡m '${ans.question.substring(0,20)}...':</strong> Báº¡n chá»n '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            vocabTranslationData.forEach((item, index) => {
                if (userAnswers[`vocabTrans_${index}`]) {
                    const ans = userAnswers[`vocabTrans_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n II.3 - Dá»‹ch Tá»« '${ans.prompt}':</strong> Báº¡n dá»‹ch '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(chÆ°a dá»‹ch)"}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            sentenceScrambleData.forEach(item => {
                if (userAnswers[`sentenceScramble_${item.id}`]) {
                    const ans = userAnswers[`sentenceScramble_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n III.1 - Sáº¯p Xáº¿p CÃ¢u (Tá»« gá»‘c: ${item.words.join('/')}):</strong> Báº¡n sáº¯p xáº¿p: '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(chÆ°a sáº¯p xáº¿p)"}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });
            sentenceTranslationData.forEach((item, index) => {
                if (userAnswers[`sentenceTrans_${index}`]) {
                    const ans = userAnswers[`sentenceTrans_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n III.2 - Dá»‹ch CÃ¢u '${ans.prompt.substring(0,20)}...':</strong> Báº¡n dá»‹ch: '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(chÆ°a dá»‹ch)"}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            sentenceQnAData.forEach(item => {
                if (userAnswers[`sentenceQnA_${item.id}`]) {
                    const ans = userAnswers[`sentenceQnA_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n III.3 - Tráº£ lá»i '${ans.question}':</strong> Báº¡n tráº£ lá»i: "<em>${ans.userAnswer || '(chÆ°a tráº£ lá»i)'}</em>" (Tá»± Ä‘Ã¡nh giÃ¡).`;
                    detailsUl.appendChild(li);
                }
            });
             sentenceCreationData.forEach(item => {
                if (userAnswers[`sentenceCreation_${item.id}`]) {
                    const ans = userAnswers[`sentenceCreation_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Pháº§n III.4 - Äáº·t cÃ¢u vá»›i '${ans.prompt}':</strong> Báº¡n Ä‘áº·t cÃ¢u: "<em>${ans.userAnswer || '(chÆ°a Ä‘áº·t cÃ¢u)'}</em>" (Tá»± Ä‘Ã¡nh giÃ¡).`;
                    detailsUl.appendChild(li);
                }
            });

            tonePracticeData.forEach(item => {
                 // FIXED: Check for userAnswers[`tonePractice_${item.id}`] instead of itemId
                if (userAnswers[`tonePractice_${item.id}`]) {
                    const ans = userAnswers[`tonePractice_${item.id}`];
                    const li = document.createElement('li');
                    const formatToneDisplay = (toneMark) => toneMark.replace('Ä«','thanh 1').replace('Ã­','thanh 2').replace('Ç','thanh 3').replace('Ã¬','thanh 4') || "chÆ°a chá»n";
                    li.innerHTML = `<strong>Pháº§n IV - Thanh Ä‘iá»‡u '${ans.word}':</strong> Báº¡n chá»n '<span class="${ans.isCorrect ? '' : 'user-answer'}">${formatToneDisplay(ans.userAnswer)}</span>'. ÄÃ¡p Ã¡n: '<span class="correct-value">${formatToneDisplay(ans.correctAnswer)}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            if (userAnswers.dialogue) {
                const li = document.createElement('li');
                let correctCount = userAnswers.dialogue.filter(a => a.isCorrect).length;
                li.innerHTML = `<strong>Pháº§n V.1 - HoÃ n thÃ nh Há»™i Thoáº¡i:</strong> ${correctCount}/${userAnswers.dialogue.length} Ä‘Ãºng.`;
                li.classList.add(correctCount === userAnswers.dialogue.length ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                 userAnswers.dialogue.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;â””â”€ Chá»— trá»‘ng ${ans.blank}: Báº¡n Ä‘iá»n '<span class="user-answer">${ans.userAnswer || "(bá» trá»‘ng)"}</span>'. ÄÃºng: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    detailsUl.appendChild(detailLi);
                });
            }
            if (userAnswers.paragraphWriting) {
                const ans = userAnswers.paragraphWriting;
                const li = document.createElement('li');
                li.innerHTML = `<strong>Pháº§n V.2 - Viáº¿t Äoáº¡n VÄƒn:</strong> Em Ä‘Ã£ viáº¿t: "<em>${(ans.userText || "(chÆ°a viáº¿t)").substring(0, 50) + ((ans.userText || "").length > 50 ? '...' : '')}</em>" (Tá»± Ä‘Ã¡nh giÃ¡).`;
                detailsUl.appendChild(li);
            }

            document.getElementById('final-summary').classList.remove('hidden');
            window.scrollTo(0, document.getElementById('final-summary').offsetTop - 20);
        }

    </script>
</body>
</html>
