<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i √în T·∫≠p Ti·∫øng Trung - B√†i 7: ‰Ω†ÂêÉ‰ªÄ‰πà</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: 'Arial', sans-serif;
            --cute-pink: #ff69b4;
            --cute-blue: #87ceeb;
            --info-color: #17a2b8;
        }

        body {
            font-family: var(--font-family);
            background-color: #eef2f7;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .game-container {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInGame 0.7s ease-out forwards;
        }

        @keyframes fadeInGame {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        h1 { font-size: 2em; }
        h2 { font-size: 1.6em; color: var(--secondary-color); margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid var(--cute-blue); padding-bottom: 5px;}
        h3 { font-size: 1.3em; color: var(--dark-color); margin-top: 20px; margin-bottom: 10px;}

        .game-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: var(--light-color);
        }
        .game-section.hidden { display: none; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--cute-blue);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        #timer, #score-display { font-weight: bold; }

        .matching-game table { width: 100%; border-collapse: collapse; }
        .matching-game th, .matching-game td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .matching-game th { background-color: #f0f0f0; }
        .matching-game select { padding: 5px; border-radius: 4px; min-width: 100px;}

        .writing-practice-item { margin-bottom: 15px; }
        .writing-practice-item label { display: block; margin-bottom: 5px; font-weight: bold;}
        .writing-practice-item input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; margin-right: 10px; }
        .writing-practice-item .show-answer-btn { padding: 6px 10px; background-color: var(--info-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .writing-practice-item .correct-hanzi { color: var(--success-color); font-weight: bold; margin-left: 10px; }

        .vocab-table-fill td input { width: 90%; padding: 5px; }
        .vocab-table-fill .instruction-text { font-size: 0.95em; color: #555; margin-bottom: 10px; background-color: #e6f7ff; padding: 8px; border-radius: 4px; border-left: 3px solid var(--info-color); }

        .multiple-choice-item { margin-bottom: 20px; }
        .multiple-choice-item img { max-width: 150px; max-height: 100px; display: block; margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px;}
        .multiple-choice-item .options button { margin: 5px; padding: 8px 12px; border: 1px solid var(--primary-color); background-color: white; color: var(--primary-color); border-radius: 20px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .multiple-choice-item .options button:hover { background-color: var(--primary-color); color: white; }
        .multiple-choice-item .options button.selected { background-color: var(--cute-pink); color: white; border-color: var(--cute-pink); }

        /* S·∫Øp x·∫øp c√¢u - Ki·ªÉu d√°ng cho t·ª´ v√† khu v·ª±c */
        .sentence-scramble-item { margin-bottom: 20px; }
        .word-bank, .sentence-dropzone {
            padding: 10px;
            margin: 5px 0;
            border: 1px dashed #ccc;
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .draggable-word { /* Gi·ªØ t√™n class ho·∫∑c ƒë·ªïi th√†nh clickable-word n·∫øu mu·ªën */
            padding: 5px 10px;
            background-color: var(--cute-blue);
            color: white;
            border-radius: 15px;
            cursor: pointer; /* THAY ƒê·ªîI: Con tr·ªè chu·ªôt th√†nh pointer */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            display: inline-block; /* Cho c√°c t·ª´ n·∫±m tr√™n m·ªôt h√†ng n·∫øu ƒë·ªß ch·ªó */
            margin: 2px; /* Kho·∫£ng c√°ch nh·ªè gi·ªØa c√°c t·ª´ */
        }

        .translation-item textarea { width: 95%; min-height: 50px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .tone-practice-item { margin-bottom: 10px; display: flex; align-items: center; gap: 10px;}
        .tone-practice-item select { padding: 5px; }
        .dialogue-fill input[type="text"] { border: none; border-bottom: 1px solid var(--primary-color); padding: 3px; margin: 0 3px; width: 100px; text-align: center; }
        #short-paragraph { width: 98%; min-height: 100px; padding: 10px; border-radius: 4px; border: 1px solid #ccc;}

        .feedback { margin-top: 5px; font-style: italic; }
        .feedback.correct { color: var(--success-color); }
        .feedback.incorrect { color: var(--danger-color); }

        .action-button { padding: 12px 25px; font-size: 1.1em; background-color: var(--success-color); color: white; border: none; border-radius: 25px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; display: block; margin: 20px auto; }
        .action-button:hover { background-color: #218838; transform: translateY(-2px); }
        .action-button.next-section-btn { background-color: var(--primary-color); }
        .action-button.next-section-btn:hover { background-color: #0056b3; }

        #final-summary { padding: 20px; background-color: var(--light-color); border: 2px solid var(--cute-pink); border-radius: 10px; margin-top: 30px; }
        #final-summary h2 { color: var(--cute-pink); }
        #final-summary ul { list-style-type: none; padding-left: 0; }
        #final-summary li { margin-bottom: 8px; padding: 5px; border-radius: 4px; }
        #final-summary li.correct-ans { background-color: #d4edda; color: #155724; }
        #final-summary li.incorrect-ans { background-color: #f8d7da; color: #721c24; }
        #final-summary li.incorrect-ans .user-answer { text-decoration: line-through; margin-right: 5px;}
        #final-summary li .correct-value { font-weight: bold; }

        .new-word-highlight { color: var(--danger-color); font-weight: bold; cursor: help; position: relative; border-bottom: 1px dotted var(--danger-color); }
        .tooltip-text { visibility: hidden; width: max-content; max-width: 200px; background-color: var(--dark-color); color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.9em; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--dark-color) transparent transparent transparent; }
        .new-word-highlight:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>‰Ω†Â•Ω! Ch√†o m·ª´ng em ƒë·∫øn v·ªõi Tr√≤ Ch∆°i √în T·∫≠p B√†i 7: ‰Ω†ÂêÉ‰ªÄ‰πà üçú</h1>
        <p style="text-align:center; font-size: 1.1em; color: var(--secondary-color);">H√£y c√πng nhau c·ªßng c·ªë ki·∫øn th·ª©c ƒë√£ h·ªçc m·ªôt c√°ch th·∫≠t vui nh√©! üòâ</p>

        <div class="status-bar">
            <div id="timer">‚è≥ Th·ªùi gian: 00:00:00</div>
            <div id="score-display">ƒêi·ªÉm: 0</div>
        </div>

        <div id="section-hanzi" class="game-section">
            <h2>I. Ch·ªØ H√°n (Ê±âÂ≠ó) ‚úçÔ∏è</h2>
            <div id="hanzi-matching">
                <h3>1. N·ªëi ch·ªØ H√°n v·ªõi phi√™n √¢m v√† nghƒ©a ƒë√∫ng:</h3>
                <p class="instruction-text">üí° H√£y ch·ªçn phi√™n √¢m (Pinyin) v√† nghƒ©a ti·∫øng Vi·ªát t∆∞∆°ng ·ª©ng cho m·ªói ch·ªØ H√°n trong b·∫£ng d∆∞·ªõi ƒë√¢y. C·ªë l√™n n√†o!</p>
                <table>
                    <thead>
                        <tr>
                            <th>Ch·ªØ H√°n</th>
                            <th>Phi√™n √¢m (Pinyin)</th>
                            <th>Nghƒ©a ti·∫øng Vi·ªát</th>
                            <th>K·∫øt qu·∫£</th>
                        </tr>
                    </thead>
                    <tbody id="hanzi-matching-body">
                        </tbody>
                </table>
                <button onclick="checkHanziMatching()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Ki·ªÉm tra ph·∫ßn n·ªëi t·ª´</button>
            </div>

            <div id="hanzi-writing" style="margin-top: 20px;">
                <h3>2. T·∫≠p vi·∫øt ch·ªØ H√°n:</h3>
                <p class="instruction-text">‚úèÔ∏è Gi·ªù m√¨nh c√πng th·ª≠ t√†i nh·ªõ m·∫∑t ch·ªØ n√†o! H√£y g√µ ch·ªØ H√°n d·ª±a v√†o phi√™n √¢m v√† nghƒ©a cho s·∫µn. Em c√≥ th·ªÉ nh·∫•n "Xem ƒë√°p √°n" ƒë·ªÉ t·ª± ki·ªÉm tra nh√©! ‚ù§Ô∏è</p>
                </div>
        </div>

        <div id="section-vocab" class="game-section hidden">
            <h2>II. T·ª´ V·ª±ng (ÁîüËØç) üìñ</h2>
            <div id="vocab-table-fill">
                <h3>1. Ho√†n th√†nh b·∫£ng t·ª´ v·ª±ng:</h3>
                <p class="instruction-text">üìù C√πng ƒëi·ªÅn phi√™n √¢m (Pinyin) ho·∫∑c nghƒ©a ti·∫øng Vi·ªát c√≤n thi·∫øu v√†o b·∫£ng. Khi ƒëi·ªÅn Pinyin, em c√≥ th·ªÉ g√µ kh√¥ng c·∫ßn d·∫•u thanh ƒëi·ªáu (v√≠ d·ª•: "shangwu" cho "sh√†ngw«î").</p>
                <table>
                    <thead>
                        <tr>
                            <th>Ch·ªØ H√°n</th>
                            <th>Phi√™n √¢m (Pinyin)</th>
                            <th>Nghƒ©a ti·∫øng Vi·ªát</th>
                        </tr>
                    </thead>
                    <tbody id="vocab-fill-body">
                        </tbody>
                </table>
                 <button onclick="checkVocabFill()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Ki·ªÉm tra b·∫£ng t·ª´ v·ª±ng</button>
            </div>

            <div id="vocab-multiple-choice" style="margin-top: 20px;">
                <h3>2. Ch·ªçn t·ª´ ƒë√∫ng:</h3>
                <p class="instruction-text">ü§î H√£y ch·ªçn ƒë√°p √°n ƒë√∫ng nh·∫•t cho m·ªói h√¨nh ·∫£nh ho·∫∑c m√¥ t·∫£. (ËÄÅÂ∏à s·∫Ω s·ªõm c·∫≠p nh·∫≠t h√¨nh ·∫£nh th·∫≠t sinh ƒë·ªông nh√©! üòâ)</p>
                </div>
            <div id="vocab-translation" style="margin-top: 20px;">
                <h3>3. D·ªãch t·ª´ Vi·ªát sang Trung:</h3>
                <p class="instruction-text">üîÑ Th·ª≠ th√°ch d·ªãch c√°c t·ª´ sau t·ª´ ti·∫øng Vi·ªát sang ti·∫øng Trung n√†o!</p>
                </div>
        </div>

        <div id="section-sentence" class="game-section hidden">
            <h2>III. M·∫´u C√¢u (Âè•Âûã) üó£Ô∏è</h2>
            <div id="sentence-scramble">
                <h3>1. S·∫Øp x·∫øp t·ª´ th√†nh c√¢u ho√†n ch·ªânh:</h3>
                <p class="instruction-text">üß© Ch·ªçn v√†o c√°c t·ª´/c·ª•m t·ª´ ƒë·ªÉ di chuy·ªÉn ch√∫ng v√†o √¥ c√¢u tr·∫£ l·ªùi v√† s·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh nh√©!</p> {/* Thay ƒë·ªïi h∆∞·ªõng d·∫´n */}
            </div>
            <div id="sentence-translation" style="margin-top: 20px;">
                <h3>2. D·ªãch c√¢u sang ti·∫øng Trung:</h3>
                <p class="instruction-text">‚úçÔ∏è M√¨nh c√πng v·∫≠n d·ª•ng ki·∫øn th·ª©c ƒë·ªÉ d·ªãch nh·ªØng c√¢u n√†y sang ti·∫øng Trung th·∫≠t chu·∫©n n√†o!</p>
            </div>
            <div id="sentence-qna" style="margin-top: 20px;">
                <h3>3. Tr·∫£ l·ªùi c√¢u h·ªèi (d·ª±a v√†o b·∫£n th√¢n):</h3>
                <p class="instruction-text">üí¨ H√£y tr·∫£ l·ªùi c√°c c√¢u h·ªèi sau b·∫±ng ti·∫øng Trung theo suy nghƒ© v√† t√¨nh h√¨nh th·ª±c t·∫ø c·ªßa em nh√©! (Ph·∫ßn n√†y kh√¥ng ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông, em c√≥ th·ªÉ nh·ªù ËÄÅÂ∏à xem gi√∫p nha üíñ)</p>
            </div>
            <div id="sentence-creation" style="margin-top: 20px;">
                <h3>4. ƒê·∫∑t c√¢u v·ªõi t·ª´/c·∫•u tr√∫c cho s·∫µn:</h3>
                <p class="instruction-text">üí° Th·ªèa s·ª©c s√°ng t·∫°o v√† ƒë·∫∑t nh·ªØng c√¢u th·∫≠t hay v·ªõi c√°c t·ª´ v√† c·∫•u tr√∫c ƒë∆∞·ª£c g·ª£i √Ω! (Ph·∫ßn n√†y c≈©ng ƒë·ªÉ em t·ª± do th·ªÉ hi·ªán, ËÄÅÂ∏à s·∫Ω xem sau nh√© üòä)</p>
            </div>
        </div>

        <div id="section-pronunciation" class="game-section hidden">
            <h2>IV. Ng·ªØ √Çm (ËØ≠Èü≥) - Bi·∫øn ƒëi·ªáu c·ªßa "‰∏Ä (yƒ´)" üé§</h2>
            <div id="tone-practice">
                <h3>1. Em h√£y ch·ªçn thanh ƒëi·ªáu ƒë√∫ng c·ªßa "‰∏Ä" trong c√°c t·ª´ sau:</h3>
                <p class="instruction-text">üëÇ L·∫Øng nghe (t∆∞·ªüng t∆∞·ª£ng üòâ) v√† ch·ªçn thanh ƒëi·ªáu ch√≠nh x√°c cho ch·ªØ "‰∏Ä" trong m·ªói t·ª´.</p>
            </div>
            <div id="tone-rules" style="margin-top: 20px;">
                <h3>2. Gi·∫£i th√≠ch quy t·∫Øc bi·∫øn ƒëi·ªáu c·ªßa "‰∏Ä" (yƒ´):</h3>
                <p>Khi "‰∏Ä" ƒë·ª©ng m·ªôt m√¨nh, ·ªü cu·ªëi t·ª´ ho·∫∑c bi·ªÉu th·ªã s·ªë th·ª© t·ª±, n√≥ mang thanh 1 (yƒ´).</p>
                <p>Khi "‰∏Ä" ƒë·ª©ng tr∆∞·ªõc m·ªôt t·ª´ mang thanh 1, 2, ho·∫∑c 3, n√≥ s·∫Ω bi·∫øn th√†nh thanh 4 (y√¨). V√≠ d·ª•: ‰∏ÄÂ§© (y√¨ tiƒÅn), ‰∏ÄÂπ¥ (y√¨ ni√°n), ‰∏ÄÊú¨ (y√¨ bƒõn).</p>
                <p>Khi "‰∏Ä" ƒë·ª©ng tr∆∞·ªõc m·ªôt t·ª´ mang thanh 4, n√≥ s·∫Ω bi·∫øn th√†nh thanh 2 (y√≠). V√≠ d·ª•: ‰∏Ä‰∏™ (y√≠ g√®).</p>
            </div>
        </div>

        <div id="section-comprehensive" class="game-section hidden">
            <h2>V. Luy·ªán T·∫≠p T·ªïng H·ª£p (ÁªºÂêàÁªÉ‰π†) üéØ</h2>
            <div id="dialogue-completion">
                <h3>1. Ho√†n th√†nh ƒëo·∫°n h·ªôi tho·∫°i ng·∫Øn:</h3>
                <p class="instruction-text">üó£Ô∏è ƒêi·ªÅn t·ª´ c√≤n thi·∫øu v√†o ch·ªó tr·ªëng ƒë·ªÉ ho√†n th√†nh cu·ªôc tr√≤ chuy·ªán th√∫ v·ªã n√†y nh√©!</p>
                A: ‰Ω†Â•ΩÔºÅÁé∞Âú®Âá†ÁÇπÔºü (N«ê h«éo! Xi√†nz√†i j«ê di«én?) <br>
                B: ‰Ω†Â•ΩÔºÅÁé∞Âú® <input type="text" id="dialogue-blank-1" data-answer="‰πùÁÇπ"> ÁÇπ„ÄÇ‰Ω† <input type="text" id="dialogue-blank-2" data-answer="ÂêÉ"> (ƒÉn) ‰ªÄ‰πàÔºü (N«ê chƒ´ sh√©nme?) <br>
                A: ÊàëÂêÉ <input type="text" id="dialogue-blank-3" data-answer="Èù¢Êù°">„ÄÇ‰Ω†Âë¢Ôºü (W«í chƒ´ __________. N«ê ne?) <br>
                B: ÊàëÊÉ≥ÂêÉ <input type="text" id="dialogue-blank-4" data-answer="ÂåÖÂ≠ê">„ÄÇ (W«í xi«éng chƒ´ __________.) Êàë‰ª¨‰∏ÄËµ∑Âéª <input type="text" id="dialogue-blank-5" data-answer="È•≠È¶Ü"> (nh√† h√†ng/qu√°n ƒÉn) ÂêÉÈ•≠ÔºåÂ•ΩÂêóÔºü (W«ímen y√¨q«ê q√π __________ chƒ´f√†n, h«éo ma?) <br>
                A: Â§™Â•Ω‰∫ÜÔºÅ(T√†i h«éo le!)
                <div id="dialogue-feedback" class="feedback"></div>
                 <button onclick="checkDialogue()" class="action-button" style="background-color: var(--cute-pink); margin-top:15px;">Ki·ªÉm tra h·ªôi tho·∫°i</button>
            </div>

            <div id="paragraph-writing" style="margin-top: 20px;">
                <h3>2. Vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (kho·∫£ng 3-5 c√¢u) k·ªÉ v·ªÅ b·ªØa ƒÉn y√™u th√≠ch c·ªßa em b·∫±ng ti·∫øng Trung.</h3>
                <p class="instruction-text">üìù (G·ª£i √Ω: Em th√≠ch ƒÉn g√¨? Th∆∞·ªùng ƒÉn ·ªü ƒë√¢u? ƒÇn c√πng v·ªõi ai? T·∫°i sao em th√≠ch m√≥n ƒë√≥? Ph·∫ßn n√†y em t·ª± do s√°ng t·∫°o v√† c√≥ th·ªÉ nh·ªù ËÄÅÂ∏à ki·ªÉm tra sau nh√©! üåü)</p>
                <textarea id="short-paragraph" placeholder="Vi·∫øt ƒëo·∫°n vƒÉn c·ªßa em v√†o ƒë√¢y..."></textarea>
            </div>
        </div>


        <button id="next-section-button" class="action-button next-section-btn" onclick="nextSection()">Ti·∫øp t·ª•c ph·∫ßn sau üöÄ</button>
        <button id="finish-game-button" class="action-button hidden" onclick="showFinalSummary()">Ho√†n Th√†nh & Xem K·∫øt Qu·∫£ üéâ</button>

        <div id="final-summary" class="hidden">
            <h2>‚ú® B·∫£ng T·ªïng K·∫øt Th√†nh T√≠ch ‚ú®</h2>
            <p>Ch√∫c m·ª´ng em ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c th·ª≠ th√°ch! C√πng xem l·∫°i k·∫øt qu·∫£ n√†o:</p>
            <p><strong>T·ªïng th·ªùi gian l√†m b√†i:</strong> <span id="total-time-taken"></span></p>
            <p><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="total-score"></span></p>
            <h3>Chi ti·∫øt c√°c c√¢u tr·∫£ l·ªùi:</h3>
            <ul id="summary-details"></ul>
            <button onclick="restartGame()" class="action-button" style="background-color: var(--cute-blue);">Ch∆°i L·∫°i T·ª´ ƒê·∫ßu üîÅ</button>
        </div>
    </div>

    <script>
        // --- D·ªØ li·ªáu cho tr√≤ ch∆°i ---
        const hanziData = [
            { id: 1, hanzi: "ÂêÉ", pinyin: "chƒ´", meaning: "ƒÇn", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 2, hanzi: "Âñù", pinyin: "hƒì", meaning: "U·ªëng", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 3, hanzi: "ÊÉ≥", pinyin: "xi«éng", meaning: "Mu·ªën, nh·ªõ, nghƒ©", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 4, hanzi: "È•≠", pinyin: "f√†n", meaning: "C∆°m", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 5, hanzi: "Ëèú", pinyin: "c√†i", meaning: "M√≥n ƒÉn, rau", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 6, hanzi: "ÂÅöÈ•≠", pinyin: "zu√≤ f√†n", meaning: "N·∫•u c∆°m", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 7, hanzi: "Áù°Ëßâ", pinyin: "shu√¨ji√†o", meaning: "Ng·ªß", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 8, hanzi: "‰ªÄ‰πà", pinyin: "sh√©nme", meaning: "C√°i g√¨, g√¨", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 9, hanzi: "‰∏äÂçà", pinyin: "sh√†ngw«î", meaning: "Bu·ªïi s√°ng", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 10, hanzi: "Ëµ∑Â∫ä", pinyin: "q«êchu√°ng", meaning: "Th·ª©c d·∫≠y", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] },
            { id: 11, hanzi: "ÂõûÂÆ∂", pinyin: "hu√≠ jiƒÅ", meaning: "V·ªÅ nh√†", optionsPinyin: ["xi«éng", "sh√©nme", "chƒ´", "shu√¨ji√†o", "zu√≤ f√†n", "hƒì", "f√†n", "c√†i", "q«êchu√°ng", "hu√≠ jiƒÅ", "sh√†ngw«î"], optionsMeaning: ["Ng·ªß", "N·∫•u c∆°m", "ƒÇn", "C√°i g√¨, g√¨", "C∆°m", "Mu·ªën, nh·ªõ, nghƒ©", "U·ªëng", "M√≥n ƒÉn, rau", "V·ªÅ nh√†", "Bu·ªïi s√°ng", "Th·ª©c d·∫≠y"] }
        ];
        const hanziWritingData = [
            { pinyin: "sh√†ngw«î", meaning: "bu·ªïi s√°ng", hanzi: "‰∏äÂçà" }, { pinyin: "q«êchu√°ng", meaning: "th·ª©c d·∫≠y", hanzi: "Ëµ∑Â∫ä" },
            { pinyin: "hu√≠ jiƒÅ", meaning: "v·ªÅ nh√†", hanzi: "ÂõûÂÆ∂" }, { pinyin: "shu√¨ji√†o", meaning: "ng·ªß", hanzi: "Áù°Ëßâ" },
            { pinyin: "zu√≤ f√†n", meaning: "n·∫•u c∆°m", hanzi: "ÂÅöÈ•≠" }, { pinyin: "jƒ´d√†n", meaning: "tr·ª©ng g√†", hanzi: "È∏°Ëõã" },
            { pinyin: "mi√†nti√°o", meaning: "m√¨ s·ª£i", hanzi: "Èù¢Êù°" }, { pinyin: "bƒÅozi", meaning: "b√°nh bao", hanzi: "ÂåÖÂ≠ê" },
            { pinyin: "ji«éozi", meaning: "s·ªßi c·∫£o", hanzi: "È•∫Â≠ê" }, { pinyin: "p√≠ji«î", meaning: "bia", hanzi: "Âï§ÈÖí" }
        ];
        const vocabFillData = [
            { hanzi: "‰∏äÂçà", pinyin: "sh√†ngw«î", meaning: "Bu·ªïi s√°ng" }, { hanzi: "Ëµ∑Â∫ä", pinyin: "q«êchu√°ng", meaning: "Th·ª©c d·∫≠y" },
            { hanzi: "ÂõûÂÆ∂", pinyin: "hu√≠ jiƒÅ", meaning: "V·ªÅ nh√†" }, { hanzi: "Áù°Ëßâ", pinyin: "shu√¨ji√†o", meaning: "Ng·ªß" },
            { hanzi: "Êôö‰∏ä", pinyin: "w«énshang", meaning: "Bu·ªïi t·ªëi" }, { hanzi: "ÁÇπ", pinyin: "di«én", meaning: "Gi·ªù" },
            { hanzi: "Áé∞Âú®", pinyin: "xi√†nz√†i", meaning: "B√¢y gi·ªù, hi·ªán t·∫°i" }, { hanzi: "ÂÅöÈ•≠", pinyin: "zu√≤ f√†n", meaning: "N·∫•u c∆°m" },
            { hanzi: "ËôæÈ•∫", pinyin: "xiƒÅ ji«éo", meaning: "B√°nh c·∫£o t√¥m/H√° c·∫£o" }, { hanzi: "È∏°Ëõã", pinyin: "jƒ´d√†n", meaning: "Tr·ª©ng g√†" },
            { hanzi: "Âåó‰∫¨ÁÉ§È∏≠", pinyin: "Bƒõijƒ´ng k«éoyƒÅ", meaning: "V·ªãt quay B·∫Øc Kinh" }, { hanzi: "Ê±§", pinyin: "tƒÅng", meaning: "Canh, s√∫p" },
            { hanzi: "Á≥ñËë´Ëä¶", pinyin: "t√°ngh√∫lu", meaning: "K·∫πo h·ªì l√¥" }, { hanzi: "Ëá≠Ë±ÜËÖê", pinyin: "ch√≤u d√≤ufu", meaning: "ƒê·∫≠u h≈© th·ªëi" },
            { hanzi: "Á≥ØÁ±≥È•≠", pinyin: "nu√≤m«ê f√†n", meaning: "C∆°m n·∫øp" }, { hanzi: "È§êÂéÖ", pinyin: "cƒÅntƒ´ng", meaning: "Nh√† h√†ng (sang tr·ªçng h∆°n)" },
            { hanzi: "È•≠È¶Ü", pinyin: "f√†ngu«én", meaning: "Qu√°n c∆°m, ti·ªám ƒÉn" }, { hanzi: "Êñπ‰æøÈù¢", pinyin: "fƒÅngbi√†nmi√†n", meaning: "M√¨ ƒÉn li·ªÅn, m√¨ g√≥i" },
            { hanzi: "Èù¢Êù°", pinyin: "mi√†nti√°o", meaning: "M√¨ s·ª£i (t∆∞∆°i)" }, { hanzi: "‰∏ÄËà¨", pinyin: "y√¨bƒÅn", meaning: "B√¨nh th∆∞·ªùng, t√†m t·∫°m" }
        ];
        const vocabMcqData = [
            { id: 'mcq1', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgDhK_qsabdbBUNMAZF-2jVI9LrwAmH4Tosw&s', question: '(H√¨nh ·∫£nh b√°t c∆°m)', options: ['Èù¢Êù°', 'Á±≥È•≠', 'ÂåÖÂ≠ê'], answer: 'Á±≥È•≠' },
            { id: 'mcq2', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ7kRj2Fkh4FtTtmUmQwS8JGAWFu3Gbmd1ejQ&s', question: '(H√¨nh ·∫£nh c·ªëc bia)', options: ['Ê±§', 'Ê∞¥', 'Âï§ÈÖí'], answer: 'Âï§ÈÖí' },
            { id: 'mcq3', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcShXaUhHzSOn8IHS1rsBtCAu5knQ1yevyYQKw&s', question: '(M√¥ t·∫£: m·ªôt m√≥n ƒÉn n·ªïi ti·∫øng c·ªßa B·∫Øc Kinh)', options: ['Ëá≠Ë±ÜËÖê', 'Âåó‰∫¨ÁÉ§È∏≠', 'ËôæÈ•∫'], answer: 'Âåó‰∫¨ÁÉ§È∏≠' },
            { id: 'mcq4', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRvGEusVMyBbrLSbkevRgi-5BpD0AHZF1mbcw&s', question: '(M√¥ t·∫£: h√†nh ƒë·ªông chu·∫©n b·ªã b·ªØa ƒÉn)', options: ['Áù°Ëßâ', 'Ëµ∑Â∫ä', 'ÂÅöÈ•≠'], answer: 'ÂÅöÈ•≠' }
        ];
        const vocabTranslationData = [
            { viet: "Bu·ªïi s√°ng", chinese: "‰∏äÂçà" }, { viet: "Th·ª©c d·∫≠y", chinese: "Ëµ∑Â∫ä" }, { viet: "V·ªÅ nh√†", chinese: "ÂõûÂÆ∂" },
            { viet: "Ng·ªß", chinese: "Áù°Ëßâ" }, { viet: "N·∫•u ƒÉn", chinese: "ÂÅöÈ•≠" }, { viet: "M√¨ g√≥i", chinese: "Êñπ‰æøÈù¢" },
            { viet: "Nh√† h√†ng", chinese: "È§êÂéÖ" }, { viet: "Qu√°n ƒÉn", chinese: "È•≠È¶Ü" }
        ];
        const sentenceScrambleData = [
            { id: 'sc1', words: ['Êàë', 'ÂêÉ', 'ÂåÖÂ≠ê', 'ÊÉ≥', '„ÄÇ'], correctAnswer: 'ÊàëÊÉ≥ÂêÉÂåÖÂ≠ê„ÄÇ' },
            { id: 'sc2', words: ['Êó©‰∏ä', 'Êàë', '‰∏ÉÁÇπ', 'Ëµ∑Â∫ä', '„ÄÇ'], correctAnswer: 'ÊàëÊó©‰∏ä‰∏ÉÁÇπËµ∑Â∫ä„ÄÇ' },
            { id: 'sc3', words: ['ÂñúÊ¨¢', 'ÂêÉ', 'Èù¢Êù°', 'Â•π', '„ÄÇ'], correctAnswer: 'Â•πÂñúÊ¨¢ÂêÉÈù¢Êù°„ÄÇ' },
            { id: 'sc4', words: ['Âá†ÁÇπ', 'Áé∞Âú®', 'Ôºü'], correctAnswer: 'Áé∞Âú®Âá†ÁÇπÔºü' },
            { id: 'sc5', words: ['Âæà', 'Âåó‰∫¨ÁÉ§È∏≠', 'Â•ΩÂêÉ', '„ÄÇ'], correctAnswer: 'Âåó‰∫¨ÁÉ§È∏≠ÂæàÂ•ΩÂêÉ„ÄÇ' }
        ];
        const sentenceTranslationData = [
            { viet: "T√¥i mu·ªën ƒÉn c∆°m.", chinese: "ÊàëÊÉ≥ÂêÉÈ•≠„ÄÇ" }, { viet: "B√¢y gi·ªù l√† 10 gi·ªù t·ªëi.", chinese: "Áé∞Âú®Êôö‰∏äÂçÅÁÇπ„ÄÇ" },
            { viet: "M·∫π t√¥i kh√¥ng th√≠ch ƒÉn m√¨ g√≥i, b√† ·∫•y th√≠ch ƒÉn m√¨ t∆∞∆°i.", chinese: "ÊàëÂ¶àÂ¶à‰∏çÂñúÊ¨¢ÂêÉÊñπ‰æøÈù¢ÔºåÂ•πÂñúÊ¨¢ÂêÉÈù¢Êù°„ÄÇ" },
            { viet: "H√¥m nay t√¥i ƒëi nh√† h√†ng ƒÉn c∆°m.", chinese: "‰ªäÂ§©ÊàëÂéªÈ§êÂéÖÂêÉÈ•≠„ÄÇ" }, { viet: "M√≥n s√∫p n√†y r·∫•t ngon.", chinese: "Ëøô‰∏™Ê±§ÂæàÂ•ΩÂñù„ÄÇ" }
        ];
        const sentenceQnAData = [
            { id: 'qna1', question: "‰Ω†ÂñúÊ¨¢ÂêÉ‰ªÄ‰πàÔºü", exampleAnswer: "ÊàëÂñúÊ¨¢ÂêÉ..." }, { id: 'qna2', question: "‰Ω†ÂñúÊ¨¢Âñù‰ªÄ‰πàÔºü", exampleAnswer: "ÊàëÂñúÊ¨¢Âñù..." },
            { id: 'qna3', question: "‰Ω†Âá†ÁÇπËµ∑Â∫äÔºü", exampleAnswer: "ÊàëÊó©‰∏ä...ÁÇπËµ∑Â∫ä„ÄÇ" }, { id: 'qna4', question: "‰Ω†Êôö‰∏äÂá†ÁÇπÁù°ËßâÔºü", exampleAnswer: "ÊàëÊôö‰∏ä...ÁÇπÁù°Ëßâ„ÄÇ" },
            { id: 'qna5', question: "‰Ω†ÂñúÊ¨¢ÂêÉÊñπ‰æøÈù¢ËøòÊòØÂêÉÈù¢Êù°Ôºü", exampleAnswer: "ÊàëÂñúÊ¨¢ÂêÉ..." }
        ];
        const sentenceCreationData = [
            { id: 'scd1', prompt: "ÊÉ≥ (xi«éng - mu·ªën)", example: "" }, { id: 'scd2', prompt: "Âú®ÂÆ∂ (z√†i jiƒÅ - ·ªü nh√†)", example: "ÊàëÊôö‰∏ä8ÁÇπÂú®ÂÆ∂Â≠¶‰π†Ê±âËØ≠„ÄÇ" },
            { id: 'scd3', prompt: "ËøòÊòØ (h√°ishi - hay l√†)", example: "" }, { id: 'scd4', prompt: "Â•ΩÂêÉ (h«éochƒ´ - ngon)", example: "" }
        ];
        const tonePracticeData = [
            { id: 'tp1', word: "‰∏Ä‰∏™", context: "y _ g√®", pinyin: "yƒ´", correctAnswer: "√≠" }, { id: 'tp2', word: "‰∏ÄÂ§©", context: "y _ tiƒÅn", pinyin: "yƒ´", correctAnswer: "√¨" },
            { id: 'tp3', word: "‰∏ÄÂπ¥", context: "y _ ni√°n", pinyin: "yƒ´", correctAnswer: "√¨" }, { id: 'tp4', word: "‰∏ÄÊú¨", context: "y _ bƒõn", pinyin: "yƒ´", correctAnswer: "√¨" },
            { id: 'tp5', word: "Á¨¨‰∏Ä", context: "d√¨ y _", pinyin: "yƒ´", correctAnswer: "ƒ´" }
        ];

        let currentSectionIndex = 0;
        const sections = ['section-hanzi', 'section-vocab', 'section-sentence', 'section-pronunciation', 'section-comprehensive'];
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let userAnswers = {};

        // ƒê·ªëi t∆∞·ª£ng l∆∞u tr·ªØ c√°c h√†m l·∫Øng nghe s·ª± ki·ªán cho c√°c m·ª•c s·∫Øp x·∫øp c√¢u
        if (!window.activeScrambleListeners) {
            window.activeScrambleListeners = {};
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateHanziMatching();
            populateHanziWriting();
            populateVocabFill();
            populateVocabMCQ();
            populateVocabTranslation();
            populateSentenceScramble(); // S·∫Ω g·ªçi setupClickToMoveWords
            populateSentenceTranslation();
            populateSentenceQnA();
            populateSentenceCreation();
            populateTonePractice();
            showSection(currentSectionIndex);
            startTimer();
        });

        function startTimer() { /* ... Gi·ªØ nguy√™n ... */ 
            timerInterval = setInterval(() => {
                secondsElapsed++;
                document.getElementById('timer').textContent = `‚è≥ Th·ªùi gian: ${formatTime(secondsElapsed)}`;
            }, 1000);
        }
        function formatTime(totalSeconds) { /* ... Gi·ªØ nguy√™n ... */ 
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function updateScore(points) { /* ... Gi·ªØ nguy√™n ... */ 
            score += points;
            document.getElementById('score-display').textContent = `ƒêi·ªÉm: ${score}`;
        }
        function showSection(index) { /* ... Gi·ªØ nguy√™n ... */ 
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            const currentSection = document.getElementById(sections[index]);
            if (currentSection) {
                currentSection.classList.remove('hidden');
            }
            const nextButton = document.getElementById('next-section-button');
            const finishButton = document.getElementById('finish-game-button');
            if (index >= sections.length - 1) {
                if(nextButton) nextButton.classList.add('hidden');
                if(finishButton) finishButton.classList.remove('hidden');
            } else {
                if(nextButton) nextButton.classList.remove('hidden');
                if(finishButton) finishButton.classList.add('hidden');
            }
        }
        function nextSection() { /* ... Gi·ªØ nguy√™n ... */ 
            currentSectionIndex++;
            if (currentSectionIndex < sections.length) {
                showSection(currentSectionIndex);
            } else {
                showFinalSummary();
            }
        }
        function shuffleArray(array) { /* ... Gi·ªØ nguy√™n ... */ 
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function populateHanziMatching() { /* ... Gi·ªØ nguy√™n ... */ 
            const tbody = document.getElementById('hanzi-matching-body');
            tbody.innerHTML = '';
            const allPinyins = shuffleArray([...new Set(hanziData.flatMap(item => item.optionsPinyin))]);
            const allMeanings = shuffleArray([...new Set(hanziData.flatMap(item => item.optionsMeaning))]);
            hanziData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.id}. ${item.hanzi}</td>
                    <td><select id="pinyin-select-${item.id}"><option value="">Ch·ªçn Pinyin</option>${allPinyins.map(p => `<option value="${p}">${p}</option>`).join('')}</select></td>
                    <td><select id="meaning-select-${item.id}"><option value="">Ch·ªçn Nghƒ©a</option>${allMeanings.map(m => `<option value="${m}">${m}</option>`).join('')}</select></td>
                    <td id="match-feedback-${item.id}" class="feedback"></td>`;
            });
        }
        function checkHanziMatching() { /* ... Gi·ªØ nguy√™n ... */ 
            let sectionScore = 0;
            userAnswers['hanziMatching'] = [];
            hanziData.forEach(item => {
                const pinyinSelect = document.getElementById(`pinyin-select-${item.id}`);
                const meaningSelect = document.getElementById(`meaning-select-${item.id}`);
                const feedbackEl = document.getElementById(`match-feedback-${item.id}`);
                const userPinyin = pinyinSelect.value;
                const userMeaning = meaningSelect.value;
                let isCorrect = false;
                if (userPinyin === item.pinyin && userMeaning === item.meaning) {
                    feedbackEl.textContent = 'üéâ Ch√≠nh x√°c!'; feedbackEl.className = 'feedback correct'; sectionScore++; isCorrect = true;
                } else {
                    feedbackEl.textContent = `üò¢ Ch∆∞a ƒë√∫ng. Pinyin: ${item.pinyin}, Nghƒ©a: ${item.meaning}`; feedbackEl.className = 'feedback incorrect';
                }
                pinyinSelect.disabled = true; meaningSelect.disabled = true;
                userAnswers['hanziMatching'].push({ id: item.id, hanzi: item.hanzi, userPinyin, userMeaning, correctPinyin: item.pinyin, correctMeaning: item.meaning, isCorrect });
            });
            updateScore(sectionScore); document.querySelector('#hanzi-matching button').disabled = true;
        }
        function populateHanziWriting() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('hanzi-writing');
            container.innerHTML = '<h3>2. T·∫≠p vi·∫øt ch·ªØ H√°n:</h3> <p class="instruction-text">‚úèÔ∏è Gi·ªù m√¨nh c√πng th·ª≠ t√†i nh·ªõ m·∫∑t ch·ªØ n√†o! H√£y g√µ ch·ªØ H√°n d·ª±a v√†o phi√™n √¢m v√† nghƒ©a cho s·∫µn. Em c√≥ th·ªÉ nh·∫•n "Xem ƒë√°p √°n" ƒë·ªÉ t·ª± ki·ªÉm tra nh√©! ‚ù§Ô∏è</p>';
            hanziWritingData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'writing-practice-item';
                div.innerHTML = `<label for="hanzi-input-${index}">${item.pinyin} (${item.meaning}):</label> <input type="text" id="hanzi-input-${index}" placeholder="G√µ ch·ªØ H√°n"> <button class="show-answer-btn" onclick="showHanziAnswer(${index}, this)">Xem ƒë√°p √°n</button> <span id="correct-hanzi-${index}" class="correct-hanzi"></span> <div id="write-feedback-${index}" class="feedback"></div>`;
                container.appendChild(div);
            });
        }
        function showHanziAnswer(index, buttonElement) { /* ... Gi·ªØ nguy√™n ... */ 
            const correctHanziEl = document.getElementById(`correct-hanzi-${index}`);
            correctHanziEl.textContent = hanziWritingData[index].hanzi;
            const userInputEl = document.getElementById(`hanzi-input-${index}`);
            const userInput = userInputEl.value;
            const feedbackEl = document.getElementById(`write-feedback-${index}`);
            userAnswers[`hanziWriting_${index}`] = { prompt: `${hanziWritingData[index].pinyin} (${hanziWritingData[index].meaning})`, userAnswer: userInput, correctAnswer: hanziWritingData[index].hanzi, isCorrect: userInput === hanziWritingData[index].hanzi };
            if (userInput === hanziWritingData[index].hanzi) {
                feedbackEl.textContent = 'üéâ Gi·ªèi qu√°!'; feedbackEl.className = 'feedback correct';
            } else if (userInput !== "") {
                feedbackEl.textContent = 'ü§î Th·ª≠ l·∫°i xem sao!'; feedbackEl.className = 'feedback incorrect';
            }
            buttonElement.disabled = true; userInputEl.disabled = true;
        }
        function normalizePinyin(pinyin) { /* ... Gi·ªØ nguy√™n ... */ 
            if (!pinyin) return "";
            let str = pinyin.toLowerCase();
            str = str.replace(/[ƒÅ√°«é√†]/g, 'a').replace(/[ƒì√©ƒõ√®]/g, 'e').replace(/[ƒ´√≠«ê√¨]/g, 'i').replace(/[≈ç√≥«í√≤]/g, 'o').replace(/[≈´√∫«î√π√º«ñ«ò«ö«ú]/g, 'u').replace(/\s+/g, '');
            return str;
        }
        function populateVocabFill() { /* ... Gi·ªØ nguy√™n ... */ 
            const tbody = document.getElementById('vocab-fill-body');
            tbody.innerHTML = '';
            vocabFillData.forEach((item, index) => {
                const row = tbody.insertRow();
                const hidePinyin = Math.random() < 0.5;
                row.innerHTML = `<td>${item.hanzi}</td><td>${hidePinyin ? `<input type="text" id="vocab-pinyin-${index}" placeholder="ƒêi·ªÅn Pinyin (kh√¥ng c·∫ßn d·∫•u)">` : item.pinyin}</td><td>${!hidePinyin ? `<input type="text" id="vocab-meaning-${index}" placeholder="ƒêi·ªÅn Nghƒ©a">` : item.meaning}</td><td id="vocab-fill-feedback-${index}" class="feedback"></td>`;
                if (hidePinyin) row.querySelector(`#vocab-pinyin-${index}`).dataset.answer = item.pinyin;
                else row.querySelector(`#vocab-meaning-${index}`).dataset.answer = item.meaning;
            });
        }
        function checkVocabFill() { /* ... Gi·ªØ nguy√™n ... */ 
            let sectionScore = 0; userAnswers['vocabFill'] = [];
            vocabFillData.forEach((item, index) => {
                const pinyinInput = document.getElementById(`vocab-pinyin-${index}`); const meaningInput = document.getElementById(`vocab-meaning-${index}`);
                const feedbackEl = document.getElementById(`vocab-fill-feedback-${index}`); let isCorrect = false;
                let userAnswerPinyinNormalized = "", correctAnswerPinyinNormalized = normalizePinyin(item.pinyin), userAnswerMeaning = "";
                if (pinyinInput) {
                    userAnswerPinyinNormalized = normalizePinyin(pinyinInput.value.trim()); if (userAnswerPinyinNormalized === correctAnswerPinyinNormalized) { sectionScore++; isCorrect = true; } pinyinInput.disabled = true;
                } else if (meaningInput) {
                    userAnswerMeaning = meaningInput.value.trim(); if (userAnswerMeaning.toLowerCase() === item.meaning.toLowerCase()) { sectionScore++; isCorrect = true; } meaningInput.disabled = true;
                }
                if (isCorrect) { feedbackEl.textContent = 'üëç ƒê√∫ng r·ªìi!'; feedbackEl.className = 'feedback correct'; } 
                else { feedbackEl.textContent = `ü§î Sai r·ªìi. Pinyin: ${item.pinyin}, Nghƒ©a: ${item.meaning}`; feedbackEl.className = 'feedback incorrect'; }
                userAnswers['vocabFill'].push({ hanzi: item.hanzi, userPinyin: pinyinInput ? pinyinInput.value.trim() : "N/A", userMeaning: meaningInput ? userAnswerMeaning : "N/A", correctPinyin: item.pinyin, correctMeaning: item.meaning, isCorrect });
            });
            updateScore(sectionScore); document.querySelector('#vocab-table-fill button').disabled = true;
        }
        function populateVocabMCQ() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('vocab-multiple-choice');
            container.innerHTML = '<h3>2. Ch·ªçn t·ª´ ƒë√∫ng:</h3> <p class="instruction-text">ü§î H√£y ch·ªçn ƒë√°p √°n ƒë√∫ng nh·∫•t cho m·ªói h√¨nh ·∫£nh ho·∫∑c m√¥ t·∫£. (ËÄÅÂ∏à s·∫Ω s·ªõm c·∫≠p nh·∫≠t h√¨nh ·∫£nh th·∫≠t sinh ƒë·ªông nh√©! üòâ)</p>';
            vocabMcqData.forEach(item => {
                const div = document.createElement('div'); div.className = 'multiple-choice-item'; div.id = `mcq-item-${item.id}`;
                let imageHtml = item.image ? `<img src="${item.image}" alt="${item.question}">` : '';
                div.innerHTML = `${imageHtml}<p><strong>${item.question}</strong></p><div class="options">${item.options.map(opt => `<button onclick="selectMCQOption(this, '${item.id}', '${opt}')">${opt}</button>`).join('')}</div><div id="mcq-feedback-${item.id}" class="feedback"></div>`;
                container.appendChild(div);
            });
        }
        function selectMCQOption(buttonEl, itemId, selectedOption) { /* ... Gi·ªØ nguy√™n ... */ 
            const itemContainer = document.getElementById(`mcq-item-${itemId}`); const questionData = vocabMcqData.find(q => q.id === itemId);
            if (!questionData || buttonEl.dataset.scored) return;
            itemContainer.querySelectorAll('.options button').forEach(btn => btn.classList.remove('selected')); buttonEl.classList.add('selected');
            const feedbackEl = document.getElementById(`mcq-feedback-${itemId}`); let isCorrect = false;
            if (selectedOption === questionData.answer) { feedbackEl.textContent = 'üéâ Tuy·ªát v·ªùi!'; feedbackEl.className = 'feedback correct'; updateScore(1); isCorrect = true; } 
            else { feedbackEl.textContent = `ü§î Ch∆∞a ƒë√∫ng r·ªìi. ƒê√°p √°n l√†: ${questionData.answer}`; feedbackEl.className = 'feedback incorrect'; }
            userAnswers[`vocabMCQ_${itemId}`] = { question: questionData.question, userAnswer: selectedOption, correctAnswer: questionData.answer, isCorrect };
            itemContainer.querySelectorAll('.options button').forEach(btn => { btn.disabled = true; btn.dataset.scored = true; });
        }
        function populateVocabTranslation() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('vocab-translation');
            container.innerHTML = '<h3>3. D·ªãch t·ª´ Vi·ªát sang Trung:</h3> <p class="instruction-text">üîÑ Th·ª≠ th√°ch d·ªãch c√°c t·ª´ sau t·ª´ ti·∫øng Vi·ªát sang ti·∫øng Trung n√†o!</p>';
            vocabTranslationData.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'writing-practice-item';
                div.innerHTML = `<label for="vocab-trans-${index}">${item.viet}:</label><input type="text" id="vocab-trans-${index}" placeholder="G√µ ti·∫øng Trung"><button class="show-answer-btn" onclick="checkVocabTranslation(${index}, this)">Ki·ªÉm tra</button><span id="correct-vocab-trans-${index}" class="correct-hanzi"></span><div id="vocab-trans-feedback-${index}" class="feedback"></div>`;
                container.appendChild(div);
            });
        }
        function checkVocabTranslation(index, buttonElement) { /* ... Gi·ªØ nguy√™n ... */ 
            const userInputEl = document.getElementById(`vocab-trans-${index}`); const userInput = userInputEl.value.trim();
            const correctAnswer = vocabTranslationData[index].chinese; const feedbackEl = document.getElementById(`vocab-trans-feedback-${index}`);
            const correctDisplayEl = document.getElementById(`correct-vocab-trans-${index}`); let isCorrect = false;
            if (userInput === correctAnswer) { feedbackEl.textContent = 'üëç R·∫•t t·ªët!'; feedbackEl.className = 'feedback correct'; updateScore(1); isCorrect = true; } 
            else { feedbackEl.textContent = 'ü§î Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†:'; feedbackEl.className = 'feedback incorrect'; correctDisplayEl.textContent = correctAnswer; }
            userInputEl.disabled = true; buttonElement.disabled = true;
            userAnswers[`vocabTrans_${index}`] = { prompt: vocabTranslationData[index].viet, userAnswer: userInput, correctAnswer, isCorrect };
        }

        // --- B·∫ÆT ƒê·∫¶U PH·∫¶N S·ª¨A ƒê·ªîI CHO S·∫ÆP X·∫æP C√ÇU ---
        function populateSentenceScramble() {
            const container = document.getElementById('sentence-scramble');
            // C·∫≠p nh·∫≠t HTML m·ªôt ch√∫t cho r√µ r√†ng h∆°n, gi·ªØ nguy√™n c·∫•u tr√∫c div ch√≠nh
            const instructionText = container.querySelector('.instruction-text');
            if (instructionText) {
                instructionText.innerHTML = 'üß© Ch·ªçn v√†o c√°c t·ª´/c·ª•m t·ª´ ƒë·ªÉ di chuy·ªÉn ch√∫ng v√† s·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh nh√©!';
            }
            // X√≥a c√°c sentence-scramble-item c≈© n·∫øu c√≥ (quan tr·ªçng khi restart game)
            container.querySelectorAll('.sentence-scramble-item').forEach(item => item.remove());

            sentenceScrambleData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'sentence-scramble-item';
                const bankId = `word-bank-${item.id}`;
                const dropzoneId = `dropzone-${item.id}`;

                // T·∫°o t·ª´ kh√¥ng c√≥ draggable="true"
                div.innerHTML = `
                    <p><strong>C√¢u ${index + 1}:</strong> S·∫Øp x·∫øp c√°c t·ª´ sau:</p>
                    <div id="${bankId}" class="word-bank">
                        ${shuffleArray([...item.words]).map(word => `<div class="draggable-word">${word}</div>`).join('')}
                    </div>
                    <p>C√¢u c·ªßa b·∫°n:</p>
                    <div id="${dropzoneId}" class="sentence-dropzone"></div>
                    <button onclick="checkSentenceScramble('${item.id}', \`${item.correctAnswer}\`, this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:10px;">Ki·ªÉm tra c√¢u ${index + 1}</button>
                    <div id="scramble-feedback-${item.id}" class="feedback"></div>
                `;
                container.appendChild(div);
                setupClickToMoveWords(item.id); // G·ªçi h√†m m·ªõi
            });
        }

        function setupClickToMoveWords(itemId) {
            const bank = document.getElementById(`word-bank-${itemId}`);
            const dropzone = document.getElementById(`dropzone-${itemId}`);

            if (!bank || !dropzone) {
                console.error("Bank or Dropzone not found for itemID:", itemId);
                return;
            }

            const bankListener = (event) => {
                // Ch·ªâ x·ª≠ l√Ω n·∫øu click v√†o m·ªôt 'draggable-word' v√† t·ª´ ƒë√≥ ƒëang n·∫±m trong bank
                if (event.target.classList.contains('draggable-word') && bank.contains(event.target)) {
                    dropzone.appendChild(event.target); // Di chuy·ªÉn t·ª´ bank sang dropzone
                }
            };

            const dropzoneListener = (event) => {
                // Ch·ªâ x·ª≠ l√Ω n·∫øu click v√†o m·ªôt 'draggable-word' v√† t·ª´ ƒë√≥ ƒëang n·∫±m trong dropzone
                if (event.target.classList.contains('draggable-word') && dropzone.contains(event.target)) {
                    bank.appendChild(event.target); // Di chuy·ªÉn t·ª´ dropzone v·ªÅ bank
                }
            };

            bank.addEventListener('click', bankListener);
            dropzone.addEventListener('click', dropzoneListener);

            // L∆∞u tr·ªØ listeners ƒë·ªÉ c√≥ th·ªÉ x√≥a sau khi ki·ªÉm tra
            if (!window.activeScrambleListeners) window.activeScrambleListeners = {};
            window.activeScrambleListeners[itemId] = {
                bankElement: bank,
                dropzoneElement: dropzone,
                bankListenerFunc: bankListener,
                dropzoneListenerFunc: dropzoneListener
            };
        }

        function disableClickToMoveWords(itemId) {
            if (window.activeScrambleListeners && window.activeScrambleListeners[itemId]) {
                const listenersInfo = window.activeScrambleListeners[itemId];
                if (listenersInfo.bankElement && listenersInfo.bankListenerFunc) {
                    listenersInfo.bankElement.removeEventListener('click', listenersInfo.bankListenerFunc);
                }
                if (listenersInfo.dropzoneElement && listenersInfo.dropzoneListenerFunc) {
                    listenersInfo.dropzoneElement.removeEventListener('click', listenersInfo.dropzoneListenerFunc);
                }
                delete window.activeScrambleListeners[itemId]; // X√≥a kh·ªèi ƒë·ªëi t∆∞·ª£ng l∆∞u tr·ªØ
            }
        }

        function checkSentenceScramble(itemId, correctAnswer, buttonElement) {
            const dropzone = document.getElementById(`dropzone-${itemId}`);
            const feedbackEl = document.getElementById(`scramble-feedback-${itemId}`);
            const wordsInDropzone = [...dropzone.querySelectorAll('.draggable-word')].map(w => w.textContent).join('');
            let isCorrect = false;

            if (wordsInDropzone === correctAnswer) {
                feedbackEl.textContent = 'üéâ Ho√†n h·∫£o!';
                feedbackEl.className = 'feedback correct';
                updateScore(2);
                isCorrect = true;
            } else {
                feedbackEl.textContent = `ü§î Ch∆∞a ƒë√∫ng l·∫Øm. ƒê√°p √°n: ${correctAnswer}`;
                feedbackEl.className = 'feedback incorrect';
            }
            
            disableClickToMoveWords(itemId); // V√¥ hi·ªáu h√≥a vi·ªác di chuy·ªÉn t·ª´ sau khi ki·ªÉm tra
            buttonElement.disabled = true;

            userAnswers[`sentenceScramble_${itemId}`] = {
                prompt: `S·∫Øp x·∫øp c√¢u ${itemId}`,
                userAnswer: wordsInDropzone,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            };
        }
        // --- K·∫æT TH√öC PH·∫¶N S·ª¨A ƒê·ªîI CHO S·∫ÆP X·∫æP C√ÇU ---


        function populateSentenceTranslation() { /* ... Gi·ªØ nguy√™n ... */ 
             const container = document.getElementById('sentence-translation');
            container.innerHTML = '<h3>2. D·ªãch c√¢u sang ti·∫øng Trung:</h3> <p class="instruction-text">‚úçÔ∏è M√¨nh c√πng v·∫≠n d·ª•ng ki·∫øn th·ª©c ƒë·ªÉ d·ªãch nh·ªØng c√¢u n√†y sang ti·∫øng Trung th·∫≠t chu·∫©n n√†o!</p>';
             sentenceTranslationData.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'translation-item';
                div.innerHTML = `<p><strong>${index + 1}. ${item.viet}</strong></p><textarea id="sent-trans-${index}" placeholder="D·ªãch sang ti·∫øng Trung..."></textarea><button onclick="checkSentenceTranslation(${index}, this)" class="action-button" style="font-size:0.9em; padding: 8px 15px; background-color:var(--cute-pink); margin-top:5px;">Ki·ªÉm tra</button><div id="sent-trans-feedback-${index}" class="feedback"></div>`;
                container.appendChild(div);
            });
        }
        function checkSentenceTranslation(index, buttonElement) { /* ... Gi·ªØ nguy√™n ... */ 
            const textarea = document.getElementById(`sent-trans-${index}`); const userAnswer = textarea.value.trim();
            const correctAnswer = sentenceTranslationData[index].chinese; const feedbackEl = document.getElementById(`sent-trans-feedback-${index}`);
            let isCorrect = false;
            if (userAnswer.replace(/[Ôºü„ÄÇÔºÅÔºå]/g, '') === correctAnswer.replace(/[Ôºü„ÄÇÔºÅÔºå]/g, '')) {
                feedbackEl.textContent = 'üåü R·∫•t chu·∫©n!'; feedbackEl.className = 'feedback correct'; updateScore(2); isCorrect = true;
            } else {
                feedbackEl.textContent = `ü§î G·∫ßn ƒë√∫ng r·ªìi! ƒê√°p √°n g·ª£i √Ω: ${correctAnswer}`; feedbackEl.className = 'feedback incorrect';
            }
            textarea.disabled = true; buttonElement.disabled = true;
            userAnswers[`sentenceTrans_${index}`] = { prompt: sentenceTranslationData[index].viet, userAnswer, correctAnswer, isCorrect };
        }
        function populateSentenceQnA() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('sentence-qna');
            container.innerHTML = '<h3>3. Tr·∫£ l·ªùi c√¢u h·ªèi (d·ª±a v√†o b·∫£n th√¢n):</h3> <p class="instruction-text">üí¨ H√£y tr·∫£ l·ªùi c√°c c√¢u h·ªèi sau b·∫±ng ti·∫øng Trung theo suy nghƒ© v√† t√¨nh h√¨nh th·ª±c t·∫ø c·ªßa em nh√©! (Ph·∫ßn n√†y kh√¥ng ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông, em c√≥ th·ªÉ nh·ªù ËÄÅÂ∏à xem gi√∫p nha üíñ)</p>';
            sentenceQnAData.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'translation-item';
                div.innerHTML = `<p><strong>${index + 1}. ${item.question}</strong></p><textarea id="qna-ans-${item.id}" placeholder="${item.exampleAnswer}"></textarea><div class="feedback">Ph·∫ßn n√†y em t·ª± ƒë√°nh gi√° ho·∫∑c nh·ªù ËÄÅÂ∏à xem gi√∫p nh√©! ‚ù§Ô∏è</div>`;
                container.appendChild(div);
                document.getElementById(`qna-ans-${item.id}`).addEventListener('change', (e) => { userAnswers[`sentenceQnA_${item.id}`] = { question: item.question, userAnswer: e.target.value, isSelfAssessed: true }; });
            });
        }
        function populateSentenceCreation() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('sentence-creation');
            container.innerHTML = '<h3>4. ƒê·∫∑t c√¢u v·ªõi t·ª´/c·∫•u tr√∫c cho s·∫µn:</h3> <p class="instruction-text">üí° Th·ªèa s·ª©c s√°ng t·∫°o v√† ƒë·∫∑t nh·ªØng c√¢u th·∫≠t hay v·ªõi c√°c t·ª´ v√† c·∫•u tr√∫c ƒë∆∞·ª£c g·ª£i √Ω! (Ph·∫ßn n√†y c≈©ng ƒë·ªÉ em t·ª± do th·ªÉ hi·ªán, ËÄÅÂ∏à s·∫Ω xem sau nh√© üòä)</p>';
            sentenceCreationData.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'translation-item';
                div.innerHTML = `<p><strong>${index + 1}. ƒê·∫∑t c√¢u v·ªõi: ${item.prompt}</strong></p>${item.example ? `<p><i>V√≠ d·ª•: ${item.example}</i></p>` : ''}<textarea id="scd-ans-${item.id}" placeholder="Vi·∫øt c√¢u c·ªßa em..."></textarea><div class="feedback">Ph·∫ßn n√†y em t·ª± do s√°ng t·∫°o v√† nh·ªù ËÄÅÂ∏à nh·∫≠n x√©t nha! üíñ</div>`;
                container.appendChild(div);
                document.getElementById(`scd-ans-${item.id}`).addEventListener('change', (e) => { userAnswers[`sentenceCreation_${item.id}`] = { prompt: item.prompt, userAnswer: e.target.value, isSelfAssessed: true }; });
            });
        }
        function populateTonePractice() { /* ... Gi·ªØ nguy√™n ... */ 
            const container = document.getElementById('tone-practice');
            container.innerHTML = '<h3>1. Em h√£y ch·ªçn thanh ƒëi·ªáu ƒë√∫ng c·ªßa "‰∏Ä" trong c√°c t·ª´ sau:</h3> <p class="instruction-text">üëÇ L·∫Øng nghe (t∆∞·ªüng t∆∞·ª£ng üòâ) v√† ch·ªçn thanh ƒëi·ªáu ch√≠nh x√°c cho ch·ªØ "‰∏Ä" trong m·ªói t·ª´.</p>';
            tonePracticeData.forEach(item => {
                const div = document.createElement('div'); div.className = 'tone-practice-item';
                div.innerHTML = `<span>${item.word} (${item.context.replace('_', `<select id="tone-select-${item.id}"><option value="">?</option><option value="ƒ´">„Ñß (Thanh 1)</option><option value="√≠">Àä (Thanh 2)</option><option value="«ê">Àá (Thanh 3)</option><option value="√¨">Àã (Thanh 4)</option></select>`)})</span><button onclick="checkTone('${item.id}', '${item.correctAnswer}', this)">Ki·ªÉm tra</button><span id="tone-feedback-${item.id}" class="feedback"></span>`;
                container.appendChild(div);
            });
        }
        function checkTone(itemId, correctAnswer, buttonElement) { /* ... Gi·ªØ nguy√™n ... */ 
            const selectEl = document.getElementById(`tone-select-${itemId}`); const userAnswer = selectEl.value;
            const feedbackEl = document.getElementById(`tone-feedback-${itemId}`); let isCorrect = false;
            if (userAnswer === correctAnswer) { feedbackEl.textContent = 'üé∂ Chu·∫©n r·ªìi!'; feedbackEl.className = 'feedback correct'; updateScore(1); isCorrect = true; } 
            else { feedbackEl.textContent = `ü§î Ch∆∞a ƒë√∫ng. ƒê√°p √°n: ${correctAnswer.replace('ƒ´','thanh 1').replace('√≠','thanh 2').replace('«ê','thanh 3').replace('√¨','thanh 4')}`; feedbackEl.className = 'feedback incorrect'; }
            selectEl.disabled = true; buttonElement.disabled = true;
            userAnswers[`tonePractice_${itemId}`] = { word: tonePracticeData.find(i => i.id === itemId).word, userAnswer, correctAnswer, isCorrect };
        }
        function checkDialogue() { /* ... Gi·ªØ nguy√™n ... */ 
            let sectionScore = 0; userAnswers['dialogue'] = [];
            for (let i = 1; i <= 5; i++) {
                const inputEl = document.getElementById(`dialogue-blank-${i}`); const userAnswer = inputEl.value.trim();
                const correctAnswer = inputEl.dataset.answer; let isCorrect = false;
                if (userAnswer === correctAnswer) { sectionScore++; inputEl.style.borderColor = 'var(--success-color)'; isCorrect = true; } 
                else { inputEl.style.borderColor = 'var(--danger-color)'; }
                userAnswers['dialogue'].push({ blank: i, userAnswer, correctAnswer, isCorrect }); inputEl.disabled = true;
            }
            updateScore(sectionScore); const feedbackEl = document.getElementById('dialogue-feedback');
            feedbackEl.textContent = `H·ªôi tho·∫°i: B·∫°n ƒë√∫ng ${sectionScore}/5 ch·ªó tr·ªëng.`;
            feedbackEl.className = sectionScore === 5 ? 'feedback correct' : 'feedback incorrect';
            document.querySelector('#dialogue-completion button').disabled = true;
        }
        document.getElementById('short-paragraph').addEventListener('change', (e) => { /* ... Gi·ªØ nguy√™n ... */ 
            userAnswers['paragraphWriting'] = { userText: e.target.value, isSelfAssessed: true };
        });
        function showFinalSummary() { /* ... Gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi c√°ch hi·ªÉn th·ªã k·∫øt qu·∫£ ... */ 
            clearInterval(timerInterval);
            document.querySelectorAll('.game-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('next-section-button').classList.add('hidden');
            document.getElementById('finish-game-button').classList.add('hidden');

            document.getElementById('total-time-taken').textContent = formatTime(secondsElapsed);
            document.getElementById('total-score').textContent = score;

            const detailsUl = document.getElementById('summary-details');
            detailsUl.innerHTML = '';

            if (userAnswers.hanziMatching) {
                const li = document.createElement('li');
                let correctCount = userAnswers.hanziMatching.filter(a => a.isCorrect).length;
                li.innerHTML = `<strong>Ph·∫ßn I.1 - N·ªëi Ch·ªØ H√°n:</strong> ${correctCount}/${hanziData.length} ƒë√∫ng.`;
                li.classList.add(correctCount === hanziData.length ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                userAnswers.hanziMatching.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;‚îî‚îÄ ${ans.hanzi}: B·∫°n ch·ªçn Pinyin '<span class="user-answer">${ans.userPinyin || "ch∆∞a ch·ªçn"}</span>', Nghƒ©a '<span class="user-answer">${ans.userMeaning || "ch∆∞a ch·ªçn"}</span>'. ƒê√∫ng: Pinyin '<span class="correct-value">${ans.correctPinyin}</span>', Nghƒ©a '<span class="correct-value">${ans.correctMeaning}</span>'.`;
                    detailsUl.appendChild(detailLi);
                });
            }
            hanziWritingData.forEach((item, index) => {
                if (userAnswers[`hanziWriting_${index}`]) {
                    const ans = userAnswers[`hanziWriting_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn I.2 - Vi·∫øt '${ans.prompt}':</strong> B·∫°n vi·∫øt '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(ch∆∞a vi·∫øt)"}</span>'. ƒê√°p √°n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            if (userAnswers.vocabFill) {
                const li = document.createElement('li');
                let correctCount = userAnswers.vocabFill.filter(a => a.isCorrect).length;
                let totalFieldsToFill = 0;
                 vocabFillData.forEach((item, index) => {
                    if (document.getElementById(`vocab-pinyin-${index}`) || document.getElementById(`vocab-meaning-${index}`)) {
                        totalFieldsToFill++;
                    }
                });
                li.innerHTML = `<strong>Ph·∫ßn II.1 - B·∫£ng T·ª´ V·ª±ng:</strong> ${correctCount}/${totalFieldsToFill} ƒë√∫ng.`;
                li.classList.add(correctCount === totalFieldsToFill ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                 userAnswers.vocabFill.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    let promptText = ans.hanzi;
                    let userText = "";
                    let correctText = "";
                    if(ans.userPinyin !== "N/A"){
                        userText = `Pinyin: '<span class="user-answer">${ans.userPinyin || "(ch∆∞a ƒëi·ªÅn)"}</span>'`;
                        correctText = `Pinyin: '<span class="correct-value">${ans.correctPinyin}</span>'`;
                    } else {
                         userText = `Nghƒ©a: '<span class="user-answer">${ans.userMeaning || "(ch∆∞a ƒëi·ªÅn)"}</span>'`;
                         correctText = `Nghƒ©a: '<span class="correct-value">${ans.correctMeaning}</span>'`;
                    }
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;‚îî‚îÄ T·ª´ '${promptText}': B·∫°n ƒëi·ªÅn ${userText}. ƒê√∫ng l√† ${correctText}.`;
                    detailsUl.appendChild(detailLi);
                });
            }

            vocabMcqData.forEach(item => {
                 if (userAnswers[`vocabMCQ_${item.id}`]) {
                    const ans = userAnswers[`vocabMCQ_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn II.2 - Tr·∫Øc Nghi·ªám '${ans.question.substring(0,20)}...':</strong> B·∫°n ch·ªçn '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer}</span>'. ƒê√°p √°n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            vocabTranslationData.forEach((item, index) => {
                if (userAnswers[`vocabTrans_${index}`]) {
                    const ans = userAnswers[`vocabTrans_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn II.3 - D·ªãch T·ª´ '${ans.prompt}':</strong> B·∫°n d·ªãch '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(ch∆∞a d·ªãch)"}</span>'. ƒê√°p √°n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            sentenceScrambleData.forEach(item => { // C·∫≠p nh·∫≠t ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£ c·ªßa click-to-move
                if (userAnswers[`sentenceScramble_${item.id}`]) {
                    const ans = userAnswers[`sentenceScramble_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn III.1 - S·∫Øp X·∫øp C√¢u (T·ª´ g·ªëc: ${item.words.join('/')}):</strong> B·∫°n s·∫Øp x·∫øp: '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(ch∆∞a s·∫Øp x·∫øp)"}</span>'. ƒê√°p √°n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });
            sentenceTranslationData.forEach((item, index) => {
                if (userAnswers[`sentenceTrans_${index}`]) {
                    const ans = userAnswers[`sentenceTrans_${index}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn III.2 - D·ªãch C√¢u '${ans.prompt.substring(0,20)}...':</strong> B·∫°n d·ªãch: '<span class="${ans.isCorrect ? '' : 'user-answer'}">${ans.userAnswer || "(ch∆∞a d·ªãch)"}</span>'. ƒê√°p √°n: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            sentenceQnAData.forEach(item => {
                if (userAnswers[`sentenceQnA_${item.id}`]) {
                    const ans = userAnswers[`sentenceQnA_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn III.3 - Tr·∫£ l·ªùi '${ans.question}':</strong> B·∫°n tr·∫£ l·ªùi: "<em>${ans.userAnswer || '(ch∆∞a tr·∫£ l·ªùi)'}</em>" (T·ª± ƒë√°nh gi√°).`;
                    detailsUl.appendChild(li);
                }
            });
             sentenceCreationData.forEach(item => {
                if (userAnswers[`sentenceCreation_${item.id}`]) {
                    const ans = userAnswers[`sentenceCreation_${item.id}`];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Ph·∫ßn III.4 - ƒê·∫∑t c√¢u v·ªõi '${ans.prompt}':</strong> B·∫°n ƒë·∫∑t c√¢u: "<em>${ans.userAnswer || '(ch∆∞a ƒë·∫∑t c√¢u)'}</em>" (T·ª± ƒë√°nh gi√°).`;
                    detailsUl.appendChild(li);
                }
            });

            tonePracticeData.forEach(item => {
                if (userAnswers[`tonePractice_${item.id}`]) {
                    const ans = userAnswers[`tonePractice_${item.id}`];
                    const li = document.createElement('li');
                    const formatToneDisplay = (toneMark) => toneMark.replace('ƒ´','thanh 1').replace('√≠','thanh 2').replace('«ê','thanh 3').replace('√¨','thanh 4') || "ch∆∞a ch·ªçn";
                    li.innerHTML = `<strong>Ph·∫ßn IV - Thanh ƒëi·ªáu '${ans.word}':</strong> B·∫°n ch·ªçn '<span class="${ans.isCorrect ? '' : 'user-answer'}">${formatToneDisplay(ans.userAnswer)}</span>'. ƒê√°p √°n: '<span class="correct-value">${formatToneDisplay(ans.correctAnswer)}</span>'.`;
                    li.classList.add(ans.isCorrect ? 'correct-ans' : 'incorrect-ans');
                    detailsUl.appendChild(li);
                }
            });

            if (userAnswers.dialogue) {
                const li = document.createElement('li');
                let correctCount = userAnswers.dialogue.filter(a => a.isCorrect).length;
                li.innerHTML = `<strong>Ph·∫ßn V.1 - Ho√†n th√†nh H·ªôi Tho·∫°i:</strong> ${correctCount}/${userAnswers.dialogue.length} ƒë√∫ng.`;
                li.classList.add(correctCount === userAnswers.dialogue.length ? 'correct-ans' : 'incorrect-ans');
                detailsUl.appendChild(li);
                 userAnswers.dialogue.filter(a => !a.isCorrect).forEach(ans => {
                    const detailLi = document.createElement('li');
                    detailLi.classList.add('incorrect-ans');
                    detailLi.innerHTML = `&nbsp;&nbsp;&nbsp;‚îî‚îÄ Ch·ªó tr·ªëng ${ans.blank}: B·∫°n ƒëi·ªÅn '<span class="user-answer">${ans.userAnswer || "(b·ªè tr·ªëng)"}</span>'. ƒê√∫ng: '<span class="correct-value">${ans.correctAnswer}</span>'.`;
                    detailsUl.appendChild(detailLi);
                });
            }
            if (userAnswers.paragraphWriting) {
                const ans = userAnswers.paragraphWriting;
                const li = document.createElement('li');
                li.innerHTML = `<strong>Ph·∫ßn V.2 - Vi·∫øt ƒêo·∫°n VƒÉn:</strong> Em ƒë√£ vi·∫øt: "<em>${(ans.userText || "(ch∆∞a vi·∫øt)").substring(0, 50) + ((ans.userText || "").length > 50 ? '...' : '')}</em>" (T·ª± ƒë√°nh gi√°).`;
                detailsUl.appendChild(li);
            }

            document.getElementById('final-summary').classList.remove('hidden');
            window.scrollTo(0, document.getElementById('final-summary').offsetTop - 20);
        }

        function restartGame() { /* ... Gi·ªØ nguy√™n ... */ 
            currentSectionIndex = 0; score = 0; secondsElapsed = 0; userAnswers = {};
            document.getElementById('score-display').textContent = `ƒêi·ªÉm: 0`;
            document.getElementById('timer').textContent = `‚è≥ Th·ªùi gian: 00:00:00`;
            document.querySelectorAll('input[type="text"], textarea, select').forEach(input => {
                if(input.tagName === 'SELECT') input.selectedIndex = 0; else input.value = '';
                input.disabled = false; if(input.style.borderColor) input.style.borderColor = '#ccc';
            });
            document.querySelectorAll('.feedback').forEach(fb => {fb.textContent = ''; fb.className = 'feedback';});
            document.querySelectorAll('.correct-hanzi').forEach(ch => ch.textContent = '');
            document.querySelectorAll('.options button').forEach(btn => { btn.classList.remove('selected'); btn.disabled = false; delete btn.dataset.scored;});
            
            // Quan tr·ªçng: G·ªçi l·∫°i populateSentenceScramble ƒë·ªÉ t·∫°o l·∫°i c√°c m·ª•c s·∫Øp x·∫øp c√¢u v·ªõi logic m·ªõi
            populateSentenceScramble(); // ƒêi·ªÅu n√†y s·∫Ω t·ª± ƒë·ªông g·ªçi setupClickToMoveWords cho m·ªói m·ª•c

            // K√≠ch ho·∫°t l·∫°i c√°c n√∫t ki·ªÉm tra kh√°c
            sentenceScrambleData.forEach(item => { // ƒê·∫£m b·∫£o n√∫t ki·ªÉm tra cho scramble ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i
                 const scrambleButton = document.querySelector(`button[onclick="checkSentenceScramble('${item.id}', \`${item.correctAnswer}\`, this)"]`);
                 if(scrambleButton) scrambleButton.disabled = false;
            });

            document.querySelectorAll('.action-button, .show-answer-btn').forEach(btn => {
                 // Kh√¥ng disable l·∫°i n√∫t ki·ªÉm tra c·ªßa scramble ·ªü ƒë√¢y v√¨ ƒë√£ l√†m ·ªü tr√™n
                if (!btn.closest('.sentence-scramble-item')) { // Ch·ªâ disable c√°c n√∫t kh√¥ng thu·ªôc scramble item
                    btn.disabled = false;
                }
            });
            const hanziMatchingButton = document.querySelector('#hanzi-matching button'); if(hanziMatchingButton) hanziMatchingButton.disabled = false;
            const vocabFillButton = document.querySelector('#vocab-table-fill button'); if(vocabFillButton) vocabFillButton.disabled = false;
            const dialogueButton = document.querySelector('#dialogue-completion button'); if(dialogueButton) dialogueButton.disabled = false;

            document.getElementById('final-summary').classList.add('hidden');
            showSection(currentSectionIndex);
            if (timerInterval) clearInterval(timerInterval);
            startTimer();
        }
    </script>
</body>
</html>
