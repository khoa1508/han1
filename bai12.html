<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrÃ² ChÆ¡i Ã”n Táº­p Tiáº¿ng Trung Vui Nhá»™n âœ¨</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.7;
            margin: 20px;
            background-color: #f0f8ff; /* Alice Blue */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #game-container {
            background: linear-gradient(135deg, #ffffff 0%, #e6f7ff 100%); /* White to light blue gradient */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 100%;
            text-align: center;
            border: 1px solid #b3e0ff;
        }

        h1, h2 {
            color: #0056b3;
            margin-bottom: 20px;
            font-weight: 600;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.5em; }

        #welcome-screen p, #welcome-screen ul {
            font-size: 1.1em;
            margin-bottom: 15px;
        }
         #welcome-screen ul {
            list-style: none;
            padding: 0;
            text-align: left;
            display: inline-block;
        }
        #welcome-screen li { margin-bottom: 8px; }
        #welcome-screen b { color: #007bff; }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-size: 1.05em;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }
        button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .hint-button { /* Common style for hint buttons */
            background-color: #ffc107; /* Yellow for hint */
            color: #333;
        }
        .hint-button:hover:not(:disabled) { background-color: #e0a800; }

        #restart-button { background-color: #28a745; }
        #restart-button:hover { background-color: #218838; }

        input[type="text"] {
            padding: 12px;
            border: 1px solid #b3cde0; /* Light blue border */
            border-radius: 8px;
            margin: 10px 0 15px 0; /* More margin bottom */
            width: calc(100% - 26px);
            font-size: 1.1em;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        input[type="text"]:focus {
             border-color: #007bff;
             box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
             outline: none;
        }

        /* Styles for Hanzi with Pinyin using <ruby> */
        .hanzi-ruby ruby {
            display: inline-flex; /* Changed from inline-block for better spacing */
            flex-direction: column;
            align-items: center;
            margin: 0 2px; /* Adjust spacing between characters */
            line-height: 1.2; /* Adjust line height for ruby */
            font-size: 1.5em; /* Larger Hanzi */
            font-weight: 500;
        }
        .hanzi-ruby rt { /* Pinyin style */
            font-size: 0.55em; /* Pinyin smaller relative to Hanzi */
            color: #555;
            font-weight: 400;
            line-height: 1;
            user-select: none; /* Prevent selecting pinyin easily */
        }
         /* Hide ruby parentheses for browsers that don't support ruby */
        .hanzi-ruby rp { display: none; }

        #scrambled-sentence {
            background-color: #e9f5ff; /* Lighter blue background */
            padding: 15px;
            border-radius: 8px;
            font-family: 'Noto Sans SC', sans-serif; /* Good font for Chinese */
            margin-bottom: 15px;
            min-height: 50px; /* Ensure space even if empty */
            border: 1px dashed #a0d0ff;
        }

        #meaning-display {
            font-size: 1.3em;
            font-weight: bold;
            margin: 15px 0;
            color: #0069d9;
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
        }


        p.feedback { /* Common class for feedback */
            margin-top: 15px;
            font-weight: bold;
            white-space: pre-wrap;
            min-height: 20px; /* Prevent layout shift */
            padding: 10px;
            border-radius: 5px;
        }
        p.feedback.correct { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb;}
        p.feedback.incorrect { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;}
        p.feedback.info { color: #004085; background-color: #cce5ff; border: 1px solid #b8daff;}


        p#attempts-left {
            color: #e67e22; /* Orange warning */
            font-size: 0.95em;
            margin-top: 5px;
        }

        .hint-display { /* Common class for hint displays */
            margin-top: 15px;
            color: #555;
            background-color: #fffbe6; /* Light yellow */
            padding: 12px;
            border-radius: 5px;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
            border: 1px solid #ffeeba;
            min-height: 20px;
        }

        .hidden { display: none; }

        /* Timer */
        #timer-container {
            position: fixed; /* Keep timer visible */
            top: 15px;
            right: 20px;
            background-color: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Ensure it's on top */
        }

        /* Summary Table & Incorrect List */
        #summary-area { text-align: left; }
        #summary-area h2 { text-align: center; }
        table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #cde;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #007bff;
            color: white;
            text-align: center;
        }
        tbody tr:nth-child(odd) { background-color: #f8f9fa; }
        tbody tr:nth-child(even) { background-color: #e9ecef; }

        #incorrect-list { margin-top: 20px; }
        #incorrect-list h3 { color: #dc3545; margin-bottom: 10px; text-align: center; }
        #incorrect-list ul {
            list-style: none;
            padding: 0;
        }
        #incorrect-list li {
            background-color: #fff0f1; /* Light pink */
            border: 1px solid #ffdbe0;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
        }
        #incorrect-list li strong { color: #721c24; }
        #summary-total-time {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            color: #0056b3;
        }

    </style>
    </head>
<body>

    <div id="game-container">
        <h1>TrÃ² ChÆ¡i Tiáº¿ng Trung Vui Nhá»™n âœ¨ğŸ’–</h1>

        <div id="timer-container" class="hidden">â±ï¸ <span id="timer">00:00</span></div>

        <div id="welcome-screen">
            <p>ChÃ o má»«ng báº¡n iu Ä‘áº¿n vá»›i thá»­ thÃ¡ch tiáº¿ng Trung nho nhá»!</p>
            <p>Game cÃ³ 2 pháº§n nÃ¨:</p>
            <ul>
                <li><b>Pháº§n 1:</b> Xem nghÄ©a Ä‘oÃ¡n chá»¯ HÃ¡n (cÃ³ gá»£i Ã½ Pinyin nha ğŸ˜‰)</li>
                <li><b>Pháº§n 2:</b> Xáº¿p chá»¯ HÃ¡n lá»™n xá»™n thÃ nh cÃ¢u Ä‘Ãºng (cÃ³ gá»£i Ã½ nghÄ©a nÃ¨ ğŸ˜)</li>
            </ul>
             <p>Sáºµn sÃ ng chinh phá»¥c chÆ°a nÃ o? Let's gooo! ğŸ”¥</p>
            <button id="start-button">Báº¯t Äáº§u Thui!</button>
        </div>

        <div id="part1-area" class="hidden">
            <h2>Pháº§n 1: ÄoÃ¡n Chá»¯ HÃ¡n ğŸ¤”</h2>
            <p id="vocab-counter"></p>
            <p><b>NghÄ©a lÃ  gÃ¬ nÃ¨?</b></p>
            <p id="meaning-display"></p>
            <label for="hanzi-input">GÃµ chá»¯ HÃ¡n tÆ°Æ¡ng á»©ng vÃ o Ä‘Ã¢y nha:</label>
            <input type="text" id="hanzi-input" autocomplete="off">
            <button id="submit-part1">Kiá»ƒm Tra</button>
            <button id="hint-button-part1" class="hint-button">Gá»£i Ã½ Pinyin</button>
            <p id="feedback-part1" class="feedback"></p>
            <p id="hint-display-part1" class="hint-display hidden"></p>
            <p id="attempts-left"></p>
        </div>

        <div id="part2-area" class="hidden">
            <h2>Pháº§n 2: Xáº¿p CÃ¢u Thuii ğŸ’ª</h2>
            <p id="sentence-counter"></p>
            <p><b>Sáº¯p xáº¿p cÃ¡c cá»¥m tá»« nÃ y nÃ¨:</b></p>
            <div id="scrambled-sentence" class="hanzi-ruby"></div> <label for="sentence-input">Viáº¿t cÃ¢u Ä‘Ãºng vÃ o Ä‘Ã¢y nÃ¨:</label>
            <input type="text" id="sentence-input" autocomplete="off">
            <button id="submit-part2">Kiá»ƒm Tra</button>
            <button id="hint-button-part2" class="hint-button">Gá»£i Ã½ NghÄ©a</button>
            <p id="feedback-part2" class="feedback"></p> <p id="hint-display-part2" class="hint-display hidden"></p>
        </div>

        <div id="summary-area" class="hidden">
            <h2>ğŸ“Š Káº¿t Quáº£ Cá»§a Báº¡n ÄÃ¢yyy ğŸ‰</h2>
            <table>
                <thead>
                    <tr>
                        <th>Pháº§n chÆ¡i</th>
                        <th>Sá»‘ lÆ°á»£ng</th>
                        <th>Sá»‘ cÃ¢u/tá»« Ä‘Ãºng âœ…</th>
                        <th>Sá»‘ cÃ¢u/tá»« sai âŒ</th>
                        <th>Gá»£i Ã½ Ä‘Ã£ dÃ¹ng ğŸ¤”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Pháº§n 1: Tá»« vá»±ng</td>
                        <td id="summary-p1-total"></td>
                        <td id="summary-p1-correct"></td>
                        <td id="summary-p1-incorrect"></td>
                        <td id="summary-p1-hints"></td>
                    </tr>
                    <tr>
                        <td>Pháº§n 2: Sáº¯p xáº¿p cÃ¢u</td>
                        <td id="summary-p2-total"></td>
                        <td id="summary-p2-correct"></td>
                        <td id="summary-p2-incorrect"></td>
                        <td id="summary-p2-hints"></td>
                    </tr>
                </tbody>
            </table>

            <div id="incorrect-list">
                 </div>

             <p id="summary-total-time">Tá»•ng thá»i gian lÃ m bÃ i: â±ï¸ <span id="total-time-value"></span></p>

            <button id="restart-button">ChÆ¡i Láº¡i Tá»« Äáº§u! ğŸš€</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ** NEW DATA V3 ** ---
            const vocabData = [
                { hanzi: 'è¯­è¨€', pinyin: 'yÇ” yÃ¡n', meaning: 'ngÃ´n ngá»¯' },
                { hanzi: 'å¤§å­¦', pinyin: 'dÃ  xuÃ©', meaning: 'Ä‘áº¡i há»c' },
                { hanzi: 'è¯»', pinyin: 'dÃº', meaning: 'Ä‘á»c' },
                { hanzi: 'è§‰å¾—', pinyin: 'juÃ© de', meaning: 'cáº£m tháº¥y' },
                { hanzi: 'æ€ä¹ˆæ ·', pinyin: 'zÄ›n me yÃ ng', meaning: 'tháº¿ nÃ o' },
                { hanzi: 'è¯­æ³•', pinyin: 'yÇ” fÇ', meaning: 'ngá»¯ phÃ¡p' }, // Corrected pinyin
                { hanzi: 'å¬', pinyin: 'tÄ«ng', meaning: 'nghe' },
                { hanzi: 'è¯´', pinyin: 'shuÅ', meaning: 'nÃ³i' },
                { hanzi: 'å†™', pinyin: 'xiÄ›', meaning: 'viáº¿t' },
                { hanzi: 'å’Œ', pinyin: 'hÃ©', meaning: 'vÃ ' },
                { hanzi: 'å®¹æ˜“', pinyin: 'rÃ³ng yÃ¬', meaning: 'dá»… dÃ ng' },
                { hanzi: 'ä½†æ˜¯', pinyin: 'dÃ n shÃ¬', meaning: 'nhÆ°ng' },
                { hanzi: 'ç»™', pinyin: 'gÄ›i', meaning: 'cho' },
                { hanzi: 'æ–°', pinyin: 'xÄ«n', meaning: 'má»›i' },
                { hanzi: 'æ—§', pinyin: 'jiÃ¹', meaning: 'cÅ©' },
                { hanzi: 'åŒå­¦', pinyin: 'tÃ³ng xuÃ©', meaning: 'báº¡n há»c' },
                { hanzi: 'åŒå±‹', pinyin: 'tÃ³ng wÅ«', meaning: 'báº¡n cÃ¹ng phÃ²ng' },
                { hanzi: 'ç­', pinyin: 'bÄn', meaning: 'lá»›p' },
                { hanzi: 'æ¯”è¾ƒ', pinyin: 'bÇ jiÃ o', meaning: 'tÆ°Æ¡ng Ä‘á»‘i' }
            ];

            const sentenceData = [
                { correct: 'ä½ ä¼šè¯´ä»€ä¹ˆè¯­è¨€ï¼Ÿ', pinyin: 'NÇ huÃ¬ shuÅ shÃ©n me yÇ” yÃ¡n?', scrambled: 'ä»€ä¹ˆ / è¯­è¨€ / ä¼šè¯´ / ä½ ', translation: 'Báº¡n cÃ³ thá»ƒ nÃ³i tiáº¿ng gÃ¬?' },
                { correct: 'ä½ åœ¨å“ªä¸ªå¤§å­¦å­¦ä¹ ï¼Ÿ', pinyin: 'NÇ zÃ i nÇ ge dÃ  xuÃ© xuÃ© xÃ­?', scrambled: 'å“ªä¸ª / å¤§å­¦ / åœ¨å­¦ä¹  / ä½ ', translation: 'Báº¡n há»c á»Ÿ trÆ°á»ng Ä‘áº¡i há»c nÃ o?' },
                { correct: 'æˆ‘åœ¨èƒ¡å¿—æ˜å¸‚å¸ˆèŒƒå¤§å­¦å­¦ä¹ ã€‚', pinyin: 'WÇ’ zÃ i HÃº zhÃ¬ mÃ­ng shÃ¬ ShÄ« fÃ n dÃ  xuÃ© xuÃ© xÃ­.', scrambled: 'èƒ¡å¿—æ˜å¸‚å¸ˆèŒƒå¤§å­¦ / åœ¨å­¦ä¹  / æˆ‘', translation: 'TÃ´i há»c táº¡i Äáº¡i há»c SÆ° pháº¡m TP. Há»“ ChÃ­ Minh.' },
                { correct: 'æˆ‘åœ¨æ¸…åå¤§å­¦è¯»ä¹¦ã€‚', pinyin: 'WÇ’ zÃ i QÄ«ng huÃ¡ dÃ  xuÃ© dÃº shÅ«.', scrambled: 'æ¸…åå¤§å­¦ / åœ¨è¯»ä¹¦ / æˆ‘', translation: 'TÃ´i há»c táº¡i Äáº¡i há»c Thanh Hoa.' }, // Corrected pinyin/translation
                { correct: 'æ±‰è¯­è¯­æ³•éš¾å—ï¼Ÿ', pinyin: 'HÃ n yÇ” yÇ” fÇ nÃ¡n ma?', scrambled: 'è¯­æ³• / éš¾å— / æ±‰è¯­', translation: 'Ngá»¯ phÃ¡p tiáº¿ng Trung cÃ³ khÃ³ khÃ´ng?' },
                { correct: 'ä½ å’Œå¥¹éƒ½æ˜¯æˆ‘çš„æœ‹å‹ã€‚', pinyin: 'NÇ hÃ© tÄ dÅu shÃ¬ wÇ’ de pÃ©ng you.', scrambled: 'ä½  / å¥¹ / æœ‹å‹ / éƒ½æ˜¯ / æˆ‘ / å’Œ', translation: 'Báº¡n vÃ  cÃ´ áº¥y Ä‘á»u lÃ  báº¡n tÃ´i.' }, // Used å¥¹ for clarity
                { correct: 'å­¦æ±‰è¯­å¾ˆå®¹æ˜“ã€‚', pinyin: 'XuÃ© HÃ n yÇ” hÄ›n rÃ³ng yÃ¬.', scrambled: 'å¾ˆ / å®¹æ˜“ / å­¦ / æ±‰è¯­', translation: 'Há»c tiáº¿ng Trung ráº¥t dá»….' },
                { correct: 'ä»–å¯¹æˆ‘å¾ˆå¥½ï¼Œä½†æ˜¯æˆ‘ä¸çˆ±ä»–ã€‚', pinyin: 'TÄ duÃ¬ wÇ’ hÄ›n hÇo, dÃ n shÃ¬ wÇ’ bÃ¹ Ã i tÄ.', scrambled: 'å¾ˆå¥½ / å¯¹æˆ‘ / ä»–ï¼Œä½†æ˜¯ / ä¸çˆ± / æˆ‘ / ä»–', translation: 'Anh áº¥y Ä‘á»‘i xá»­ tÃ´i ráº¥t tá»‘t, nhÆ°ng tÃ´i khÃ´ng yÃªu anh áº¥y.' }, // Adjusted translation/scrambled
                { correct: 'ä¸­æ–‡å¾ˆæœ‰æ„æ€ï¼Œä½†æ˜¯ä¹Ÿå¾ˆéš¾ã€‚', pinyin: 'ZhÅng wÃ©n hÄ›n yÇ’u yÃ¬ si, dÃ n shÃ¬ yÄ› hÄ›n nÃ¡n.', scrambled: 'å¾ˆæœ‰æ„æ€ / ä¸­æ–‡ï¼Œä½†æ˜¯ / ä¹Ÿå¾ˆéš¾', translation: 'Tiáº¿ng Trung ráº¥t thÃº vá»‹, nhÆ°ng cÅ©ng ráº¥t khÃ³.' },
                { correct: 'ä»Šå¤©ä¸‹å¤§é›¨ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜å»å­¦æ ¡ã€‚', pinyin: 'JÄ«n tiÄn xiÃ  dÃ  yÇ”, dÃ n shÃ¬ wÇ’ men hÃ¡i qÃ¹ xuÃ© xiÃ o.', scrambled: 'ä»Šå¤© / ä¸‹å¤§é›¨ï¼Œä½†æ˜¯ / æˆ‘ä»¬ / è¿˜å» / å­¦æ ¡', translation: 'HÃ´m nay mÆ°a lá»›n, nhÆ°ng chÃºng tÃ´i váº«n Ä‘i há»c.' }, // Adjusted scrambled
                { correct: 'æˆ‘æƒ³å»é“¶è¡Œå–é’±ï¼Œä½†æ˜¯å·¥ä½œå¾ˆå¿™ã€‚', pinyin: 'WÇ’ xiÇng qÃ¹ yÃ­n hÃ¡ng qÇ” qiÃ¡n, dÃ n shÃ¬ gÅng zuÃ² hÄ›n mÃ¡ng.', scrambled: 'æƒ³å» / é“¶è¡Œ / å–é’± / æˆ‘ï¼Œä½†æ˜¯ / å·¥ä½œ / å¾ˆå¿™', translation: 'TÃ´i muá»‘n Ä‘i ngÃ¢n hÃ ng rÃºt tiá»n, nhÆ°ng cÃ´ng viá»‡c ráº¥t báº­n.' }, // Adjusted scrambled
                { correct: 'æˆ‘æƒ³æ‰¾æˆ‘çš„åŒå­¦ã€‚', pinyin: 'WÇ’ xiÇng zhÇo wÇ’ de tÃ³ng xuÃ©.', scrambled: 'åŒå­¦ / æƒ³æ‰¾ / æˆ‘çš„', translation: 'TÃ´i muá»‘n tÃ¬m báº¡n há»c cá»§a tÃ´i.' },
                { correct: 'ä½ çš„åŒå±‹æ€ä¹ˆæ ·ï¼Ÿ', pinyin: 'NÇ de tÃ³ng wÅ« zÄ›n me yÃ ng?', scrambled: 'åŒå±‹ / æ€ä¹ˆæ · / ä½ çš„', translation: 'Báº¡n cÃ¹ng phÃ²ng cá»§a báº¡n tháº¿ nÃ o?' },
                { correct: 'ä½ çš„ç­æœ‰å¤šå°‘åŒå­¦ï¼Ÿ', pinyin: 'NÇ de bÄn yÇ’u duÅ shao tÃ³ng xuÃ©?', scrambled: 'ç­ / æœ‰å¤šå°‘åŒå­¦ / ä½ çš„', translation: 'Lá»›p báº¡n cÃ³ bao nhiÃªu báº¡n há»c?' },
                { correct: 'æ±‰è¯­æ¯”è¾ƒéš¾ã€‚', pinyin: 'HÃ n yÇ” bÇ jiÃ o nÃ¡n.', scrambled: 'æ¯”è¾ƒéš¾ / æ±‰è¯­', translation: 'Tiáº¿ng Trung khÃ¡ khÃ³.' },
                { correct: 'ä½ åœ¨å“ªå„¿å­¦ä¹ æ±‰è¯­ï¼Ÿ', pinyin: 'NÇ zÃ i nÇr xuÃ© xÃ­ HÃ n yÇ”?', scrambled: 'å“ªå„¿ / åœ¨ / å­¦ä¹  / æ±‰è¯­ / ä½ ', translation: 'Báº¡n há»c tiáº¿ng Trung á»Ÿ Ä‘Ã¢u?' },
                { correct: 'ä»–åœ¨å“ªå„¿å­¦ä¹ æ±‰è¯­ï¼Ÿ', pinyin: 'TÄ zÃ i nÇr xuÃ© xÃ­ HÃ n yÇ”?', scrambled: 'å“ªå„¿ / åœ¨ / å­¦ä¹  / æ±‰è¯­ / ä»–', translation: 'Anh áº¥y há»c tiáº¿ng Trung á»Ÿ Ä‘Ã¢u?' }, // Used ä»– for clarity
                { correct: 'ä»–ä»¬çš„è€å¸ˆæ€ä¹ˆæ ·ï¼Ÿ', pinyin: 'TÄ men de lÇo shÄ« zÄ›n me yÃ ng?', scrambled: 'è€å¸ˆ / æ€ä¹ˆæ · / ä»–ä»¬çš„', translation: 'GiÃ¡o viÃªn cá»§a há» tháº¿ nÃ o?' }, // Corrected translation
                { correct: 'ä»–ä»¬è§‰å¾—å­¦ä¹ æ±‰è¯­éš¾å—ï¼Ÿ', pinyin: 'TÄ men juÃ© de xuÃ© xÃ­ HÃ n yÇ” nÃ¡n ma?', scrambled: 'å­¦ä¹  / æ±‰è¯­ / éš¾å— / è§‰å¾— / ä»–ä»¬', translation: 'Há» cáº£m tháº¥y há»c tiáº¿ng Trung cÃ³ khÃ³ khÃ´ng?' }, // Corrected translation/scrambled
                { correct: 'ä½ ä»¬çš„è€å¸ˆæ˜¯è°ï¼Ÿ', pinyin: 'NÇ men de lÇo shÄ« shÃ¬ shÃ©i?', scrambled: 'è€å¸ˆ / æ˜¯è° / ä½ ä»¬çš„', translation: 'GiÃ¡o viÃªn cá»§a cÃ¡c báº¡n lÃ  ai?' },
                { correct: 'æ–°åŒå­¦åœ¨å“ªä¸ªç­å­¦ä¹ ï¼Ÿ', pinyin: 'XÄ«n tÃ³ng xuÃ© zÃ i nÇ ge bÄn xuÃ© xÃ­?', scrambled: 'å“ªä¸ªç­ / åœ¨å­¦ä¹  / æ–°åŒå­¦', translation: 'Báº¡n há»c má»›i há»c á»Ÿ lá»›p nÃ o?' },
                { correct: 'ä»–çš„è€å¸ˆæ˜¯è°ï¼Ÿ', pinyin: 'TÄ de lÇo shÄ« shÃ¬ shÃ©i?', scrambled: 'è€å¸ˆ / æ˜¯è° / ä»–çš„', translation: 'GiÃ¡o viÃªn cá»§a anh áº¥y lÃ  ai?' }, // Used ä»– for clarity
            ];
            // --- ** END NEW DATA V3 ** ---


            // --- DOM Elements ---
            const welcomeScreen = document.getElementById('welcome-screen');
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            const timerContainer = document.getElementById('timer-container');
            const timerDisplay = document.getElementById('timer');

            const part1Area = document.getElementById('part1-area');
            const vocabCounter = document.getElementById('vocab-counter');
            const meaningDisplay = document.getElementById('meaning-display'); // Changed from image
            const hanziInput = document.getElementById('hanzi-input');
            const submitPart1 = document.getElementById('submit-part1');
            const hintButtonPart1 = document.getElementById('hint-button-part1');
            const feedbackPart1 = document.getElementById('feedback-part1');
            const hintDisplayPart1 = document.getElementById('hint-display-part1');
            const attemptsLeftDisplay = document.getElementById('attempts-left');

            const part2Area = document.getElementById('part2-area');
            const sentenceCounter = document.getElementById('sentence-counter');
            const scrambledSentenceDisplay = document.getElementById('scrambled-sentence'); // Renamed for clarity
            const sentenceInput = document.getElementById('sentence-input');
            const submitPart2 = document.getElementById('submit-part2');
            const hintButtonPart2 = document.getElementById('hint-button-part2');
            const feedbackPart2 = document.getElementById('feedback-part2');
            const hintDisplayPart2 = document.getElementById('hint-display-part2');

            const summaryArea = document.getElementById('summary-area');
            const summaryP1Total = document.getElementById('summary-p1-total');
            const summaryP1Correct = document.getElementById('summary-p1-correct');
            const summaryP1Incorrect = document.getElementById('summary-p1-incorrect');
            const summaryP1Hints = document.getElementById('summary-p1-hints');
            const summaryP2Total = document.getElementById('summary-p2-total');
            const summaryP2Correct = document.getElementById('summary-p2-correct');
            const summaryP2Incorrect = document.getElementById('summary-p2-incorrect');
            const summaryP2Hints = document.getElementById('summary-p2-hints');
            const incorrectListDiv = document.getElementById('incorrect-list');
            const totalTimeValue = document.getElementById('total-time-value');


            // --- Game State ---
            let currentPart = 0; // 0: Welcome, 1: Vocab, 2: Sentence, 3: Summary
            let currentWordIndex = 0;
            let currentSentenceIndex = 0;
            let attemptsLeft = 3;
            let scorePart1 = 0;
            let scorePart2 = 0;
            let hintsUsedPart1 = 0;
            let hintsUsedPart2 = 0;
            let shuffledVocab = [];
            let shuffledSentences = [];
            let incorrectAnswers = []; // Store details of incorrect answers
            let timerInterval;
            let startTime;


            // --- Utility Functions ---
            function shuffleArray(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function hideAllSections() {
                welcomeScreen.classList.add('hidden');
                part1Area.classList.add('hidden');
                part2Area.classList.add('hidden');
                summaryArea.classList.add('hidden');
                timerContainer.classList.add('hidden'); // Hide timer initially
            }

             function updateFeedback(element, message, type) {
                element.innerHTML = message.replace(/\n/g, '<br>');
                // Keep existing feedback class + add new type for styling
                element.className = 'feedback ' + type; // 'correct', 'incorrect', 'info'
            }

            // Function to create <ruby> structure for Hanzi with Pinyin
            function createRubyHTML(hanzi, pinyin) {
                // Basic split by space for pinyin - might need refinement for complex cases
                const pinyinSyllables = pinyin.trim().split(/\s+/);
                let hanziChars = hanzi.replace(/\s+/g, ''); // Remove spaces from Hanzi if any
                let html = '';
                let pinyinIndex = 0;

                // Attempt to match Hanzi characters to Pinyin syllables
                // This is a simplified approach; complex words might not align perfectly.
                for (let i = 0; i < hanziChars.length; i++) {
                    const char = hanziChars[i];
                    // Skip punctuation commonly found in sentences
                    if ("ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼šã€,.?!;:'\"".includes(char)) {
                        html += `<span class="punctuation">${char}</span>`; // Style punctuation separately if needed
                    } else {
                         // Use the next available pinyin syllable, handle potential mismatch
                        const syllable = pinyinSyllables[pinyinIndex] || ''; // Default to empty if pinyin runs out
                        html += `<ruby>${char}<rp>(</rp><rt>${syllable}</rt><rp>)</rp></ruby>`;
                        pinyinIndex++; // Move to the next syllable
                    }
                }
                 // Add any remaining punctuation or non-ruby text if needed
                 // This part needs more robust logic if sentences contain non-Hanzi text mixed in.

                return html;
            }


            // --- Timer Functions ---
            function startTimer() {
                startTime = Date.now();
                timerContainer.classList.remove('hidden');
                timerInterval = setInterval(() => {
                    const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
                    const seconds = String(elapsedTime % 60).padStart(2, '0');
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                 const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                 const minutes = String(Math.floor(elapsedTime / 60)).padStart(2, '0');
                 const seconds = String(elapsedTime % 60).padStart(2, '0');
                 return `${minutes}:${seconds}`; // Return formatted final time
            }

            // --- Game Logic Functions ---

            function startGame() {
                // Reset state
                currentPart = 1;
                currentWordIndex = 0;
                currentSentenceIndex = 0;
                scorePart1 = 0;
                scorePart2 = 0;
                hintsUsedPart1 = 0;
                hintsUsedPart2 = 0;
                incorrectAnswers = []; // Clear previous incorrect answers

                // Shuffle data
                shuffledVocab = shuffleArray([...vocabData]);
                shuffledSentences = shuffleArray([...sentenceData]);

                hideAllSections();
                part1Area.classList.remove('hidden');
                startTimer(); // Start the timer
                loadVocabQuestion();
            }

            // --- Part 1: Vocabulary (Meaning -> Hanzi) ---
            function loadVocabQuestion() {
                if (currentWordIndex >= shuffledVocab.length) {
                    startPart2();
                    return;
                }

                const currentWord = shuffledVocab[currentWordIndex];
                vocabCounter.textContent = `Tá»« ${currentWordIndex + 1} / ${shuffledVocab.length}`;
                meaningDisplay.textContent = currentWord.meaning; // Show meaning
                hanziInput.value = '';
                feedbackPart1.textContent = '';
                feedbackPart1.className = 'feedback'; // Reset feedback style
                hintDisplayPart1.textContent = ''; // Clear hint
                hintDisplayPart1.classList.add('hidden'); // Hide hint
                attemptsLeft = 3;
                attemptsLeftDisplay.textContent = `Sá»‘ láº§n Ä‘oÃ¡n cÃ²n láº¡i: ${attemptsLeft} â¤ï¸`;
                hanziInput.disabled = false;
                submitPart1.disabled = false;
                hintButtonPart1.disabled = false; // Enable hint button
                hanziInput.focus();
            }

             function checkVocabAnswer() {
                const userAnswer = hanziInput.value.trim();
                const currentWord = shuffledVocab[currentWordIndex];
                const correctAnswer = currentWord.hanzi;

                if (!userAnswer) return;

                if (userAnswer === correctAnswer) {
                    updateFeedback(feedbackPart1, 'Chuáº©n luÃ´n! Báº¡n giá»i quÃ¡ ğŸ‘ğŸ’¯', 'correct');
                    if (!hanziInput.disabled) { scorePart1++; } // Score only once
                    finalizePart1Question(true); // Mark as correct
                } else {
                    attemptsLeft--;
                    attemptsLeftDisplay.textContent = `Sá»‘ láº§n Ä‘oÃ¡n cÃ²n láº¡i: ${attemptsLeft} ${attemptsLeft > 0 ? 'â¤ï¸' : 'ğŸ’”'}`;
                    if (attemptsLeft > 0) {
                        updateFeedback(feedbackPart1, 'Ui, sai máº¥t rÃ¹i, thá»­ láº¡i nha! ğŸ¤”', 'incorrect');
                        hanziInput.select();
                    } else {
                        updateFeedback(feedbackPart1, `Huhu, háº¿t lÆ°á»£t rÃ¹i! ğŸ˜­ ÄÃ¡p Ã¡n lÃ : <span class="hanzi-ruby">${createRubyHTML(correctAnswer, currentWord.pinyin)}</span>`, 'info');
                         // Record incorrect answer
                        incorrectAnswers.push({
                            type: 'Tá»« vá»±ng',
                            question: currentWord.meaning,
                            correctAnswer: `${currentWord.hanzi} (${currentWord.pinyin})`
                         });
                        finalizePart1Question(false); // Mark as incorrect
                    }
                }
            }

             function showHintPart1() {
                if (currentWordIndex < shuffledVocab.length) {
                    const currentWord = shuffledVocab[currentWordIndex];
                    hintDisplayPart1.textContent = `Gá»£i Ã½ Pinyin nÃ¨: ${currentWord.pinyin}`;
                    hintDisplayPart1.classList.remove('hidden');
                    if (!hintButtonPart1.disabled) { hintsUsedPart1++; } // Count hint only once
                    hintButtonPart1.disabled = true;
                }
            }

            function finalizePart1Question(isCorrect) {
                 hanziInput.disabled = true;
                 submitPart1.disabled = true;
                 hintButtonPart1.disabled = true;
                 setTimeout(() => {
                    currentWordIndex++;
                    loadVocabQuestion();
                }, isCorrect ? 1500 : 2500); // Longer delay if incorrect to read answer
            }


            // --- Part 2: Sentence Scramble ---
            function startPart2() {
                currentPart = 2;
                hideAllSections();
                part2Area.classList.remove('hidden');
                loadSentenceQuestion();
            }

            function loadSentenceQuestion() {
                if (currentSentenceIndex >= shuffledSentences.length) {
                    showSummary();
                    return;
                }
                const currentSentence = shuffledSentences[currentSentenceIndex];
                sentenceCounter.textContent = `CÃ¢u ${currentSentenceIndex + 1} / ${shuffledSentences.length}`;

                // Display scrambled sentence WITH ruby pinyin
                // Need to reconstruct pinyin for scrambled parts - this is HARD.
                // **Simplification:** Show scrambled parts WITHOUT pinyin for now.
                scrambledSentenceDisplay.innerHTML = currentSentence.scrambled.replace(/\//g, ' / '); // Just show text
                // ** If pinyin mapping for scrambled parts is needed, it requires complex logic **

                sentenceInput.value = '';
                feedbackPart2.textContent = '';
                feedbackPart2.className = 'feedback';
                hintDisplayPart2.textContent = '';
                hintDisplayPart2.classList.add('hidden');
                hintButtonPart2.disabled = false;
                sentenceInput.disabled = false;
                submitPart2.disabled = false;
                sentenceInput.focus();
            }

            function checkSentenceAnswer() {
                const normalize = (str) => str.trim().replace(/[ï¼Ÿã€‚ï¼ï¼Œ,\s]/g, ''); // Remove punctuation and spaces
                const userAnswer = normalize(sentenceInput.value);
                const currentSentence = shuffledSentences[currentSentenceIndex];
                const correctAnswer = normalize(currentSentence.correct);


                if (!userAnswer) return;

                if (userAnswer === correctAnswer) {
                     const rubyCorrect = createRubyHTML(currentSentence.correct, currentSentence.pinyin);
                     updateFeedback(feedbackPart2, `Xuáº¥t sáº¯c! CÃ¢u Ä‘Ãºng lÃ :\n<span class="hanzi-ruby">${rubyCorrect}</span>\n<i>(NghÄ©a: ${currentSentence.translation})</i>`, 'correct');
                     if (!sentenceInput.disabled) { scorePart2++; } // Score once
                     finalizePart2Question(true);
                } else {
                    updateFeedback(feedbackPart2, 'Opps, chÆ°a Ä‘Ãºng rÃ¹i báº¡n Æ¡i. Kiá»ƒm tra láº¡i hoáº·c dÃ¹ng gá»£i Ã½ nha! ğŸ¤”', 'incorrect');
                     sentenceInput.select();
                     // Don't record incorrect immediately, only if they move on without correcting maybe?
                     // Or record every wrong attempt? Let's record only if they finish the game without getting it right.
                     // For now, we'll record it in the summary based on score difference.
                }
            }

            function showHintPart2() {
                if (currentSentenceIndex < shuffledSentences.length) {
                    const currentSentence = shuffledSentences[currentSentenceIndex];
                    hintDisplayPart2.textContent = `Gá»£i Ã½ nghÄ©a: ${currentSentence.translation}`;
                    hintDisplayPart2.classList.remove('hidden');
                    if (!hintButtonPart2.disabled) { hintsUsedPart2++; } // Count hint once
                    hintButtonPart2.disabled = true;
                 }
            }

             function finalizePart2Question(isCorrect){
                sentenceInput.disabled = true;
                submitPart2.disabled = true;
                hintButtonPart2.disabled = true;

                // If incorrect when finalizing (e.g., skipping), record it
                if (!isCorrect) {
                     const currentSentence = shuffledSentences[currentSentenceIndex];
                     incorrectAnswers.push({
                         type: 'CÃ¢u',
                         question: currentSentence.scrambled,
                         correctAnswer: `${currentSentence.correct} (${currentSentence.pinyin}) - ${currentSentence.translation}`
                     });
                }

                setTimeout(() => {
                    currentSentenceIndex++;
                    loadSentenceQuestion();
                }, isCorrect ? 2500 : 1500); // Delay longer if correct to read feedback
             }


            // --- Summary ---
            function showSummary() {
                currentPart = 3;
                const finalTime = stopTimer(); // Stop timer and get final time
                hideAllSections();
                summaryArea.classList.remove('hidden');

                const totalVocab = shuffledVocab.length;
                const incorrectVocab = totalVocab - scorePart1;
                const totalSentences = shuffledSentences.length;
                const incorrectSentences = totalSentences - scorePart2;

                summaryP1Total.textContent = totalVocab;
                summaryP1Correct.textContent = scorePart1;
                summaryP1Incorrect.textContent = incorrectVocab;
                summaryP1Hints.textContent = hintsUsedPart1;

                summaryP2Total.textContent = totalSentences;
                summaryP2Correct.textContent = scorePart2;
                summaryP2Incorrect.textContent = incorrectSentences;
                summaryP2Hints.textContent = hintsUsedPart2;

                totalTimeValue.textContent = finalTime;

                // Populate incorrect answers list
                incorrectListDiv.innerHTML = ''; // Clear previous list
                if (incorrectAnswers.length > 0) {
                    let listHTML = '<h3>Nhá»¯ng chá»— cáº§n xem láº¡i nÃ¨ ğŸ‘€:</h3><ul>';
                    incorrectAnswers.forEach(item => {
                        listHTML += `<li><strong>${item.type}:</strong> ${item.question}<br>â¡ï¸ ÄÃ¡p Ã¡n Ä‘Ãºng: ${item.correctAnswer}</li>`;
                    });
                    listHTML += '</ul>';
                    incorrectListDiv.innerHTML = listHTML;
                } else {
                     incorrectListDiv.innerHTML = '<p style="text-align:center; color: green; font-weight: bold;">Wow! Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng háº¿t! Xuáº¥t sáº¯c! ğŸ¥³ğŸ‰</p>';
                }
            }


            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);

            // Part 1 Listeners
            submitPart1.addEventListener('click', checkVocabAnswer);
            hintButtonPart1.addEventListener('click', showHintPart1);
            hanziInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !submitPart1.disabled) {
                    e.preventDefault();
                    checkVocabAnswer();
                }
            });

            // Part 2 Listeners
            submitPart2.addEventListener('click', checkSentenceAnswer);
            hintButtonPart2.addEventListener('click', showHintPart2);
            sentenceInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !submitPart2.disabled) {
                    e.preventDefault();
                    checkSentenceAnswer();
                }
            });

        });
    </script>
    </body>
</html>