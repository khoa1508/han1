<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoáº¡t Äá»™ng Giao Tiáº¿p: Äi Chá»£ Mua Hoa Quáº£ (CÃ³ HÃ¬nh áº¢nh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        .role-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem; 
            border-left-width: 8px;
        }
        .buyer-card { border-left-color: #3b82f6; }
        .seller-card { border-left-color: #16a34a; }
        .role-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
        .buyer-title { color: #2563eb; }
        .seller-title { color: #15803d; }
        .fruit-list-item {
            background-color: #f9fafb; 
            padding: 0.75rem; 
            border-radius: 8px;
            margin-bottom: 0.75rem; 
            border: 1px solid #e5e7eb; 
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between image and text */
        }
        .fruit-list-item img {
            width: 5rem; /* 80px */
            height: 5rem; /* 80px */
            object-fit: cover;
            border-radius: 6px;
        }
        .fruit-list-item .info {
            flex-grow: 1;
        }
        .fruit-list-item .info .name {
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            color: #111827; /* Gray-900 */
        }
        .fruit-list-item .info .details {
            font-size: 1rem; /* 16px */
            color: #4b5563; /* Gray-600 */
        }

        .script-suggestion-list li {
            background-color: #f9fafb; 
            padding: 0.75rem; 
            border-radius: 6px;
            margin-bottom: 0.5rem; 
            border: 1px solid #e5e7eb; 
        }
        .suggestion, .script-suggestion {
            background-color: #fffbeb; 
            border: 1px dashed #f59e0b; 
            padding: 1rem; 
            border-radius: 8px;
            margin-top: 1rem; 
        }
        .script-suggestion { background-color: #eff6ff; border-color: #60a5fa; }
        .script-suggestion h4 { color: #1d4ed8; margin-top:0; font-size: 1.1rem; font-weight:600; }

        .chinese-text { font-style: italic; color: #57534e; }
        .pinyin-text { font-size: 0.9em; color: #78716c; display: none; }
        .pinyin-text.visible { display: inline; }
        h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.75rem; color: #374151; }
        
        .phach-section, .action-buttons-section {
            background-color: #e0f2fe; 
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #bae6fd; 
        }
        .phach-section input[type="number"] {
            padding: 0.5rem; border-radius: 6px; border: 1px solid #9ca3af; 
            margin-left: 0.5rem; margin-right: 0.5rem; width: 80px;
        }
        .phach-section button, .action-buttons-section button, #character-selection-view button {
            background-color: #38bdf8; color: white; padding: 0.75rem 1.5rem; 
            border-radius: 8px; font-weight: 600; font-size: 1.1rem; 
            border: none; cursor: pointer; transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phach-section button:hover, .action-buttons-section button:hover, #character-selection-view button:hover {
            background-color: #0ea5e9; transform: translateY(-1px);
        }
        #character-selection-view button.buyer-btn { background-color: #3b82f6; }
        #character-selection-view button.buyer-btn:hover { background-color: #2563eb; }
        #character-selection-view button.seller-btn { background-color: #16a34a; }
        #character-selection-view button.seller-btn:hover { background-color: #15803d; }
        .toggle-pinyin-btn {
            background-color: #eab308; color: white; padding: 0.5rem 1rem;
            border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; margin-bottom: 1rem; border: none;
        }
        .toggle-pinyin-btn:hover { background-color: #ca8a04; }
        .hidden { display: none !important; }
        #character-selection-view {
            text-align: center; padding: 2rem; background-color: white;
            border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        #character-selection-view h2 { font-size: 2rem; color: #1f2937; margin-bottom: 1.5rem; }
        #character-selection-view .button-container { display: flex; justify-content: center; gap: 1rem; }

        @media print {
            body { background-color: white; font-size: 12pt; }
            .role-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 1.5rem; padding: 1rem; page-break-inside: avoid; }
            .no-print { display: none; }
            .printable-area { max-width: 100%; }
            .phach-section, .action-buttons-section, #character-selection-view, .script-suggestion { display: none; }
            .toggle-pinyin-btn { display: none; }
            .pinyin-text { display: inline !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-gray-700">ğŸ›’ Hoáº¡t Äá»™ng Giao Tiáº¿p: Äi Chá»£ Mua Hoa Quáº£ ğŸ“</h1>
            <p class="text-md text-gray-500">å»å¸‚åœºä¹°æ°´æœ <span class="pinyin-text">(qÃ¹ shÃ¬chÇng mÇi shuÇguÇ’)</span></p>
        </header>

        <div id="character-selection-view">
            <h2>ğŸ‘‹ Báº¡n lÃ  ai hÃ´m nay?</h2>
            <div class="button-container">
                <button onclick="selectRole('buyer')" class="buyer-btn">TÃ´i lÃ  NgÆ°á»i Mua ğŸ§‘â€ğŸŒ¾</button>
                <button onclick="selectRole('seller')" class="seller-btn">TÃ´i lÃ  NgÆ°á»i BÃ¡n ğŸª</button>
            </div>
        </div>

        <div id="role-play-view" class="hidden">
            <div class="text-center mb-4 no-print">
                 <button onclick="showCharacterSelection()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">
                    â†©ï¸ Quay láº¡i chá»n nhÃ¢n váº­t
                </button>
            </div>
            <div class="phach-section no-print text-center">
                <h3 class="text-xl font-semibold text-sky-700 mt-0 mb-3">ğŸ·ï¸ Khu Vá»±c Äá»“ng Bá»™ PhÃ¡ch</h3>
                <p class="mb-2 text-gray-700">
                    Bá»™ Ä‘á» hiá»‡n táº¡i (PhÃ¡ch sá»‘): <strong id="current-phach-display" class="text-sky-600 text-lg">1</strong>
                </p>
                <div>
                    <label for="phach-input" class="text-gray-700">Nháº­p sá»‘ phÃ¡ch (1-10):</label>
                    <input type="number" id="phach-input" min="1" max="10" value="1">
                    <button onclick="handleMatchPhach()">âœ”ï¸ Khá»›p PhÃ¡ch</button>
                </div>
            </div>

            <div id="buyer-role-card" class="role-card buyer-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">ğŸ‘ï¸ Hiá»‡n Pinyin</button>
                <h2 class="role-title buyer-title">PHIáº¾U A: NGÆ¯á»œI MUA <span class="chinese-text">(ä¹°ä¸œè¥¿çš„äºº)</span> <span class="pinyin-text">(mÇi dÅngxi de rÃ©n)</span> ğŸ§‘â€ğŸŒ¾</h2>
                <h3>ğŸ“ Nhiá»‡m vá»¥ cá»§a báº¡n:</h3>
                <p class="mb-3 text-gray-700">Báº¡n Ä‘áº¿n má»™t cá»­a hÃ ng hoa quáº£. Há»i giÃ¡ vÃ  mua nhá»¯ng thá»© trong "Danh sÃ¡ch cáº§n mua". Báº¡n cÃ³ <strong class="text-red-600">30 Ä‘á»“ng (ä¸‰åå—é’± <span class="pinyin-text">sÄnshÃ­ kuÃ i qiÃ¡n</span>)</strong>, hÃ£y tÃ­nh toÃ¡n cáº©n tháº­n nhÃ©!</p>
                <h3>ğŸ›ï¸ Danh sÃ¡ch cáº§n mua <span class="chinese-text">(è´­ç‰©å•</span> <span class="pinyin-text">gÃ²uwÃ¹ dÄn</span>):</h3>
                <ul id="shopping-list-buyer" class="list-none p-0"></ul>
                <p class="mt-2 text-sm text-gray-600">VÃ  há»i giÃ¡ thÃªm má»™t loáº¡i quáº£ khÃ¡c mÃ  báº¡n thÃ­ch.</p>
                
                <div class="script-suggestion mt-6">
                    <h4>ğŸ“ Ká»‹ch báº£n gá»£i Ã½ cho báº¡n (NgÆ°á»i Mua):</h4>
                    <ul class="script-suggestion-list list-none p-0 text-sm">
                        <li><strong>ChÃ o há»i:</strong> <span class="chinese-text">ä½ å¥½ï¼</span> <span class="pinyin-text">(NÇ hÇo!)</span></li>
                        <li><strong>NÃ³i muá»‘n mua gÃ¬:</strong> <span class="chinese-text">æˆ‘æƒ³ä¹°æ°´æœã€‚</span> <span class="pinyin-text">(WÇ’ xiÇng mÇi shuÇguÇ’.)</span></li>
                        <li><strong>Há»i giÃ¡ (vÃ­ dá»¥ TÃ¡o):</strong> <span class="chinese-text">è¯·é—®è‹¹æœä¸€æ–¤å¤šå°‘é’±ï¼Ÿ</span> <span class="pinyin-text">(QÇngwÃ¨n pÃ­ngguÇ’ yÃ¬ jÄ«n duÅshao qiÃ¡n?)</span></li>
                        <li><strong>Máº·c cáº£ (náº¿u cáº§n):</strong> <span class="chinese-text">å¤ªè´µäº†ï¼Œä¾¿å®œä¸€ç‚¹å„¿å§ï¼</span> <span class="pinyin-text">(TÃ i guÃ¬ le, piÃ¡nyi yÃ¬diÇnr ba!)</span></li>
                        <li><strong>NÃ³i sá»‘ lÆ°á»£ng (vÃ­ dá»¥ 2 cÃ¢n):</strong> <span class="chinese-text">æˆ‘è¦ä¸¤æ–¤ã€‚</span> <span class="pinyin-text">(WÇ’ yÃ o liÇng jÄ«n.)</span></li>
                        <li><strong>Há»i tá»•ng tiá»n:</strong> <span class="chinese-text">ä¸€å…±å¤šå°‘é’±ï¼Ÿ</span> <span class="pinyin-text">(YÃ­gÃ²ng duÅshao qiÃ¡n?)</span></li>
                        <li><strong>Tráº£ tiá»n:</strong> <span class="chinese-text">ç»™ä½ é’±ã€‚</span> <span class="pinyin-text">(GÄ›i nÇ qiÃ¡n.)</span></li>
                    </ul>
                </div>
            </div>

            <div id="seller-role-card" class="role-card seller-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">ğŸ‘ï¸ Hiá»‡n Pinyin</button>
                <h2 class="role-title seller-title">PHIáº¾U B: NGÆ¯á»œI BÃN <span class="chinese-text">(å–ä¸œè¥¿çš„äºº)</span> <span class="pinyin-text">(mÃ i dÅngxi de rÃ©n)</span> ğŸª</h2>
                <h3>ğŸ“ Nhiá»‡m vá»¥ cá»§a báº¡n:</h3>
                <p class="mb-3 text-gray-700">Báº¡n lÃ  chá»§ cá»­a hÃ ng hoa quáº£. Tráº£ lá»i khÃ¡ch hÃ ng vÃ  tÃ­nh tiá»n cho há».</p>
                <h3>ğŸ·ï¸ Báº£ng giÃ¡ cá»§a báº¡n hÃ´m nay <span class="chinese-text">(ä»Šæ—¥ä»·æ ¼å•</span> <span class="pinyin-text">jÄ«nrÃ¬ jiÃ gÃ© dÄn</span>):</h3>
                <ul id="price-list-seller" class="list-none p-0"></ul>

                <div class="script-suggestion mt-6">
                    <h4>ğŸ“ Ká»‹ch báº£n gá»£i Ã½ cho báº¡n (NgÆ°á»i BÃ¡n):</h4>
                    <ul class="script-suggestion-list list-none p-0 text-sm">
                        <li><strong>ChÃ o khÃ¡ch:</strong> <span class="chinese-text">ä½ å¥½ï¼/ æ¬¢è¿å…‰ä¸´ï¼</span> <span class="pinyin-text">(NÇ hÇo! / HuÄnyÃ­ng guÄnglÃ­n!)</span></li>
                        <li><strong>Há»i khÃ¡ch muá»‘n gÃ¬:</strong> <span class="chinese-text">ä½ ä¹°ä»€ä¹ˆï¼Ÿ</span> <span class="pinyin-text">(NÇ mÇi shÃ©nme?)</span></li>
                        <li><strong>BÃ¡o giÃ¡ (vÃ­ dá»¥ TÃ¡o 3 Ä‘á»“ng):</strong> <span class="chinese-text">è‹¹æœä¸‰å—ä¸€æ–¤ã€‚</span> <span class="pinyin-text">(PÃ­ngguÇ’ sÄn kuÃ i yÃ¬ jÄ«n.)</span></li>
                        <li><strong>Há»i sá»‘ lÆ°á»£ng:</strong> <span class="chinese-text">ä½ è¦å‡ æ–¤ï¼Ÿ</span> <span class="pinyin-text">(NÇ yÃ o jÇ jÄ«n?)</span></li>
                        <li><strong>TÃ­nh tá»•ng tiá»n (vÃ­ dá»¥ 16.5 Ä‘á»“ng):</strong> <span class="chinese-text">ä¸€å…±åå…­å—äº”æ¯›ã€‚</span> <span class="pinyin-text">(YÃ­gÃ²ng shÃ­liÃ¹ kuÃ i wÇ” mÃ¡o.)</span></li>
                        <li><strong>Nháº­n tiá»n vÃ  thá»‘i tiá»n (vÃ­ dá»¥ nháº­n 50, thá»‘i 33.5):</strong> <span class="chinese-text">æ”¶ä½ äº”åå—ï¼Œæ‰¾ä½ ä¸‰åä¸‰å—äº”æ¯›ã€‚</span> <span class="pinyin-text">(ShÅu nÇ wÇ”shÃ­ kuÃ i, zhÇo nÇ sÄnshÃ­sÄn kuÃ i wÇ” mÃ¡o.)</span></li>
                         <li><strong>Cáº£m Æ¡n, tiá»…n khÃ¡ch:</strong> <span class="chinese-text">è°¢è°¢ï¼æ‚¨æ…¢èµ°ï¼</span> <span class="pinyin-text">(XiÃ¨xie! NÃ­n mÃ n zÇ’u!)</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="action-buttons-section text-center mt-8 mb-4 no-print">
                <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700">
                    ğŸ–¨ï¸ In Phiáº¿u
                </button>
                <button onclick="handleChangeScenario()" class="bg-green-500 hover:bg-green-700 ml-2">
                    ğŸ”„ Äá»•i Bá»™ Äá» (PhÃ¡ch)
                </button>
            </div>
        </div>
    </div>

    <script>
        const allFruitsData = [
            { name: "TÃ¡o", chinese: "è‹¹æœ", pinyin: "pÃ­ngguÇ’", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoCDBwHdRmovxn9d3GZ14Uwbb7YUK7hFgq1A&s", basePriceMin: 2.5, basePriceMax: 6 },
            { name: "QuÃ½t", chinese: "æ©˜å­", pinyin: "jÃºzi", imageUrl: "https://vcdn1-suckhoe.vnecdn.net/2022/11/17/close-up-fresh-organic-mandari-7704-8534-1668676426.jpg?w=1200&h=0&q=100&dpr=1&fit=crop&s=7xwH-Nb8gPUf1pAZGZ7jyg", basePriceMin: 2, basePriceMax: 4.5 },
            { name: "Chuá»‘i", chinese: "é¦™è•‰", pinyin: "xiÄngjiÄo", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/324455921873985536/2021/10/14/chuoi1-16341869574602070184903.jpg", basePriceMin: 3, basePriceMax: 5 },
            { name: "DÆ°a háº¥u", chinese: "è¥¿ç“œ", pinyin: "xÄ«guÄ", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/324455921873985536/2022/11/12/dua-hau-16682703712011380946081.jpg", basePriceMin: 1.5, basePriceMax: 3 },
            { name: "Nho", chinese: "è‘¡è„", pinyin: "pÃºtao", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSw33gbpYpsdGtOMdLeYFmPpdX-I-8ku8e8SA&s", basePriceMin: 6, basePriceMax: 12 },
            { name: "XoÃ i", chinese: "èŠ’æœ", pinyin: "mÃ¡ngguÇ’", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/Images/duylinh/2019/08/15/8-loi-ich-it-biet-cua-xoai1565855128.jpg", basePriceMin: 5, basePriceMax: 10 },
            { name: "LÃª", chinese: "æ¢¨", pinyin: "lÃ­", imageUrl: "https://cdn.tgdd.vn/Products/Images/8788/223091/bhx/le-duong-hop-1kg-4-6-trai-202205111941249856.jpg", basePriceMin: 3, basePriceMax: 5.5 },
            { name: "ÄÃ o", chinese: "æ¡ƒå­", pinyin: "tÃ¡ozi", imageUrl: "https://citifruit.com/uploads/images/Products/qua-dao-800x600.jpg", basePriceMin: 4, basePriceMax: 8 }
        ];

        const jinQuantitiesData = [
            { amount: 1, chinese: "ä¸€æ–¤", pinyin: "yÃ¬ jÄ«n" },
            { amount: 1.5, chinese: "ä¸€æ–¤åŠ", pinyin: "yÃ¬ jÄ«n bÃ n" },
            { amount: 2, chinese: "ä¸¤æ–¤", pinyin: "liÇng jÄ«n" },
            { amount: 2.5, chinese: "ä¸¤æ–¤åŠ", pinyin: "liÇng jÄ«n bÃ n" },
            { amount: 3, chinese: "ä¸‰æ–¤", pinyin: "sÄn jÄ«n" }
        ];

        const MAX_SCENARIOS = 10;
        let currentScenarioId = 1;
        let selectedRole = null; 

        // DOM Elements
        const characterSelectionView = document.getElementById('character-selection-view');
        const rolePlayView = document.getElementById('role-play-view');
        const buyerRoleCard = document.getElementById('buyer-role-card');
        const sellerRoleCard = document.getElementById('seller-role-card');
        const currentPhachDisplay = document.getElementById('current-phach-display');
        const phachInput = document.getElementById('phach-input');
        const shoppingListBuyerContainer = document.getElementById('shopping-list-buyer');
        const priceListSellerContainer = document.getElementById('price-list-seller');

        // Seeded Pseudo-Random Number Generator
        let scenarioPrng;
        function mulberry32(a) {
            return function() {
              var t = a += 0x6D2B79F5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function getSeededRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(scenarioPrng() * (max - min + 1)) + min;
        }

        function getSeededRandomElement(arr) {
            if (!arr || arr.length === 0) return undefined;
            return arr[Math.floor(scenarioPrng() * arr.length)];
        }
        
        function generateSeededRandomPrice(minKuai, maxKuai) {
            const kuai = getSeededRandomInt(Math.floor(minKuai), Math.floor(maxKuai -1 < minKuai ? minKuai : maxKuai -1));
            const mao = getSeededRandomInt(0, 9);
            let priceValue = kuai + (mao / 10);
            priceValue = Math.max(minKuai, Math.min(maxKuai, priceValue));
            const finalKuai = Math.floor(priceValue);
            const finalMao = Math.round((priceValue - finalKuai) * 10);
            let priceString = `${finalKuai}å—`;
            let pinyinString = `${kuaiToPinyin(finalKuai)} kuÃ i`;
            if (finalMao > 0) {
                priceString += `${finalMao}æ¯›`;
                pinyinString += ` ${maoToPinyin(finalMao)} mÃ¡o`;
            }
            return { value: parseFloat(priceValue.toFixed(1)), string: priceString, pinyin: pinyinString };
        }

        function kuaiToPinyin(num) {
            const pinyinMap = ["lÃ­ng", "yÄ«", "Ã¨r", "sÄn", "sÃ¬", "wÇ”", "liÃ¹", "qÄ«", "bÄ", "jiÇ”", "shÃ­"];
            if (num >= 0 && num <= 10) return pinyinMap[num];
            if (num > 10 && num < 20) return `shÃ­ ${pinyinMap[num%10] || ''}`.trim();
            if (num % 10 === 0 && num <=90) return `${pinyinMap[num/10]} shÃ­`.trim();
            if (num > 20 && num < 100) return `${pinyinMap[Math.floor(num/10)]} shÃ­ ${pinyinMap[num%10] || ''}`.trim();
            return String(num); 
        }
        function maoToPinyin(num) {
            const pinyinMap = ["lÃ­ng", "yÄ«", "Ã¨r", "sÄn", "sÃ¬", "wÇ”", "liÃ¹", "qÄ«", "bÄ", "jiÇ”"];
            return (num >=0 && num <=9) ? pinyinMap[num] : String(num);
        }

        function generateSpecificScenario(scenarioId) {
            scenarioPrng = mulberry32(scenarioId * 12345 + 67890); 

            const marketDayOfferings = [];
            let availableFruitsForThisScenario = [...allFruitsData];
            const numFruitsInMarket = getSeededRandomInt(Math.min(5, availableFruitsForThisScenario.length), Math.min(8, availableFruitsForThisScenario.length));

            for (let j = 0; j < numFruitsInMarket; j++) {
                if (availableFruitsForThisScenario.length === 0) break;
                const fruitIndex = Math.floor(scenarioPrng() * availableFruitsForThisScenario.length);
                const fruitData = availableFruitsForThisScenario.splice(fruitIndex, 1)[0];
                const price = generateSeededRandomPrice(fruitData.basePriceMin, fruitData.basePriceMax); 
                marketDayOfferings.push({ ...fruitData, price: price });
            }
            marketDayOfferings.sort((a, b) => a.name.localeCompare(b.name));

            const buyerShoppingListItems = [];
            let fruitsToChooseFromForBuyer = [...marketDayOfferings]; 
            const numItemsToBuy = getSeededRandomInt(Math.min(2, fruitsToChooseFromForBuyer.length), Math.min(3, fruitsToChooseFromForBuyer.length));

            for (let k = 0; k < numItemsToBuy; k++) {
                if (fruitsToChooseFromForBuyer.length === 0) break;
                const itemIndex = Math.floor(scenarioPrng() * fruitsToChooseFromForBuyer.length);
                const marketItem = fruitsToChooseFromForBuyer.splice(itemIndex, 1)[0];
                const quantity = getSeededRandomElement(jinQuantitiesData); 
                buyerShoppingListItems.push({ ...marketItem, quantity: quantity });
            }
            return {
                id: scenarioId,
                buyerShoppingList: buyerShoppingListItems, 
                sellerPriceList: marketDayOfferings      
            };
        }

        function displayShoppingList(shoppingListItems) {
            shoppingListBuyerContainer.innerHTML = '';
            if (!shoppingListItems) return;
            shoppingListItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'fruit-list-item';
                li.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.chinese}">
                    <div class="info">
                        <div class="name">
                            <span class="chinese-text">${item.chinese}</span> 
                            <span class="pinyin-text">${item.pinyin}</span>
                        </div>
                        <div class="details">
                            ${item.quantity.amount} cÃ¢n <span class="chinese-text">(${item.quantity.chinese})</span> 
                            <span class="pinyin-text">(${item.quantity.pinyin})</span>
                        </div>
                    </div>
                `;
                shoppingListBuyerContainer.appendChild(li);
            });
        }

        function displayPriceList(priceListItems) {
            priceListSellerContainer.innerHTML = '';
            if (!priceListItems) return;
            priceListItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'fruit-list-item';
                const priceStringForChinese = item.price.string.replace('å—', 'å—ä¸€æ–¤').replace(/(\d)æ¯›$/, '$1æ¯›ä¸€æ–¤');
                li.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.chinese}">
                    <div class="info">
                        <div class="name">
                            <span class="chinese-text">${item.chinese}</span> 
                            <span class="pinyin-text">${item.pinyin}</span>
                        </div>
                        <div class="details">
                            ${item.price.string}/cÃ¢n 
                            <span class="chinese-text">(${priceStringForChinese})</span> 
                            <span class="pinyin-text">(${item.price.pinyin} yÃ¬ jÄ«n)</span>
                        </div>
                    </div>
                `;
                priceListSellerContainer.appendChild(li);
            });
        }
        
        function resetPinyinVisibility() {
            document.querySelectorAll('.pinyin-text').forEach(el => el.classList.remove('visible'));
            const pinyinToggleButtons = document.querySelectorAll('.toggle-pinyin-btn');
            pinyinToggleButtons.forEach(btn => {
                if (btn.closest('.role-card:not(.hidden)')) {
                     btn.textContent = 'ğŸ‘ï¸ Hiá»‡n Pinyin';
                }
            });
        }

        function loadScenario(scenarioId) {
            const scenario = generateSpecificScenario(scenarioId);
            if (scenario) {
                currentScenarioId = scenario.id;
                currentPhachDisplay.textContent = currentScenarioId;
                phachInput.value = currentScenarioId;
                displayShoppingList(scenario.buyerShoppingList);
                displayPriceList(scenario.sellerPriceList);
                resetPinyinVisibility();
            }
        }
        
        window.selectRole = function(role) {
            selectedRole = role;
            characterSelectionView.classList.add('hidden');
            rolePlayView.classList.remove('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');

            if (role === 'buyer') buyerRoleCard.classList.remove('hidden');
            else if (role === 'seller') sellerRoleCard.classList.remove('hidden');
            
            loadScenario(currentScenarioId); 
        }

        window.showCharacterSelection = function() {
            rolePlayView.classList.add('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');
            characterSelectionView.classList.remove('hidden');
            selectedRole = null;
        }
        
        window.handleChangeScenario = function() {
            let randomId;
            if (MAX_SCENARIOS <= 1) randomId = 1;
            else {
                do { randomId = Math.floor(Math.random() * MAX_SCENARIOS) + 1; } 
                while (randomId === currentScenarioId && MAX_SCENARIOS > 1);
            }
            loadScenario(randomId);
        }

        window.handleMatchPhach = function() {
            const inputPhach = parseInt(phachInput.value);
            if (!isNaN(inputPhach) && inputPhach >= 1 && inputPhach <= MAX_SCENARIOS) {
                loadScenario(inputPhach);
            } else {
                 alert(`Vui lÃ²ng nháº­p sá»‘ phÃ¡ch há»£p lá»‡ tá»« 1 Ä‘áº¿n ${MAX_SCENARIOS}.`);
            }
        }

        window.togglePinyin = function(buttonElement) {
            const card = buttonElement.closest('.role-card');
            if (!card) return; 
            const pinyinTexts = card.querySelectorAll('.pinyin-text');
            let isCurrentlyVisible = pinyinTexts.length > 0 && pinyinTexts[0].classList.contains('visible');
            pinyinTexts.forEach(el => el.classList.toggle('visible'));
            buttonElement.textContent = isCurrentlyVisible ? 'ğŸ‘ï¸ Hiá»‡n Pinyin' : 'ğŸ™ˆ áº¨n Pinyin';
        }
        
        function initializeApp() {
            showCharacterSelection(); 
        }
        window.onload = initializeApp;
    </script></body></html>
