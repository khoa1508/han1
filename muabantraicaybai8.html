<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ho·∫°t ƒê·ªông Giao Ti·∫øp: ƒêi Ch·ª£ Mua Hoa Qu·∫£ (Ch·ªçn Nh√¢n V·∫≠t & Theo Ph√°ch)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 background */
        }
        .role-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem; /* 24px */
            border-left-width: 8px;
        }
        .buyer-card {
            border-left-color: #3b82f6; /* Blue-500 */
        }
        .seller-card {
            border-left-color: #16a34a; /* Green-600 */
        }
        .role-title {
            font-size: 1.75rem; /* 28px */
            font-weight: 700;
            margin-bottom: 1rem; /* 16px */
        }
        .buyer-title {
            color: #2563eb; /* Blue-600 */
        }
        .seller-title {
            color: #15803d; /* Green-700 */
        }
        .price-list li, .shopping-list li {
            background-color: #f9fafb; /* Gray-50 */
            padding: 0.75rem; /* 12px */
            border-radius: 6px;
            margin-bottom: 0.5rem; /* 8px */
            border: 1px solid #e5e7eb; /* Gray-200 */
        }
        .price-list li strong, .shopping-list li strong {
            color: #4b5563; /* Gray-600 */
        }
        .suggestion {
            background-color: #fffbeb; /* Amber-50 */
            border: 1px dashed #f59e0b; /* Amber-500 */
            padding: 1rem; /* 16px */
            border-radius: 8px;
            margin-top: 1rem; /* 16px */
        }
        .chinese-text {
            font-style: italic;
            color: #57534e; /* Stone-600 */
        }
        .pinyin-text {
            font-size: 0.9em;
            color: #78716c; /* Stone-500 */
            display: none; 
        }
        .pinyin-text.visible {
            display: inline; 
        }
        h3 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            margin-top: 1.25rem; 
            margin-bottom: 0.75rem; 
            color: #374151; /* Gray-700 */
        }
        .phach-section, .action-buttons-section {
            background-color: #e0f2fe; /* Sky-100 */
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #bae6fd; /* Sky-200 */
        }
        .phach-section input[type="number"] {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #9ca3af; /* Gray-400 */
            margin-left: 0.5rem;
            margin-right: 0.5rem;
            width: 80px;
        }
        .phach-section button, .action-buttons-section button, #character-selection-view button {
            background-color: #38bdf8; /* Sky-500 */
            color: white;
            padding: 0.75rem 1.5rem; /* Increased padding for bigger buttons */
            border-radius: 8px; /* More rounded */
            font-weight: 600; /* Bolder text */
            font-size: 1.1rem; /* Larger font */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phach-section button:hover, .action-buttons-section button:hover, #character-selection-view button:hover {
            background-color: #0ea5e9; /* Sky-600 */
            transform: translateY(-1px);
        }
         #character-selection-view button.buyer-btn {
            background-color: #3b82f6; /* Blue-500 */
        }
        #character-selection-view button.buyer-btn:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        #character-selection-view button.seller-btn {
            background-color: #16a34a; /* Green-600 */
        }
        #character-selection-view button.seller-btn:hover {
            background-color: #15803d; /* Green-700 */
        }
        .toggle-pinyin-btn {
            background-color: #eab308; /* Yellow-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 1rem;
            border: none;
        }
        .toggle-pinyin-btn:hover {
            background-color: #ca8a04; /* Yellow-600 */
        }
        .hidden {
            display: none !important;
        }
        #character-selection-view {
            text-align: center;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        #character-selection-view h2 {
            font-size: 2rem;
            color: #1f2937; /* Gray-800 */
            margin-bottom: 1.5rem;
        }
        #character-selection-view .button-container {
            display: flex;
            justify-content: center;
            gap: 1rem; /* Space between buttons */
        }

        @media print {
            body { background-color: white; font-size: 12pt; }
            .role-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 1.5rem; padding: 1rem; page-break-inside: avoid; }
            .no-print { display: none; }
            .printable-area { max-width: 100%; }
            .phach-section, .action-buttons-section, #character-selection-view { display: none; }
            .toggle-pinyin-btn { display: none; }
            .pinyin-text { display: inline !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-gray-700">üõí Ho·∫°t ƒê·ªông Giao Ti·∫øp: ƒêi Ch·ª£ Mua Hoa Qu·∫£ üçì</h1>
            <p class="text-md text-gray-500">ÂéªÂ∏ÇÂú∫‰π∞Ê∞¥Êûú <span class="pinyin-text">(q√π sh√¨ch«éng m«éi shu«êgu«í)</span></p>
        </header>

        <div id="character-selection-view">
            <h2>üëã B·∫°n l√† ai h√¥m nay?</h2>
            <div class="button-container">
                <button onclick="selectRole('buyer')" class="buyer-btn">T√¥i l√† Ng∆∞·ªùi Mua üßë‚Äçüåæ</button>
                <button onclick="selectRole('seller')" class="seller-btn">T√¥i l√† Ng∆∞·ªùi B√°n üè™</button>
            </div>
        </div>

        <div id="role-play-view" class="hidden">
            <div class="text-center mb-4 no-print">
                 <button onclick="showCharacterSelection()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">
                    ‚Ü©Ô∏è Quay l·∫°i ch·ªçn nh√¢n v·∫≠t
                </button>
            </div>
            <div class="phach-section no-print text-center">
                <h3 class="text-xl font-semibold text-sky-700 mt-0 mb-3">üè∑Ô∏è Khu V·ª±c ƒê·ªìng B·ªô Ph√°ch</h3>
                <p class="mb-2 text-gray-700">
                    B·ªô ƒë·ªÅ hi·ªán t·∫°i (Ph√°ch s·ªë): <strong id="current-phach-display" class="text-sky-600 text-lg">1</strong>
                </p>
                <div>
                    <label for="phach-input" class="text-gray-700">Nh·∫≠p s·ªë ph√°ch (1-10):</label>
                    <input type="number" id="phach-input" min="1" max="10" value="1">
                    <button onclick="handleMatchPhach()">‚úîÔ∏è Kh·ªõp Ph√°ch</button>
                </div>
            </div>

            <div id="buyer-role-card" class="role-card buyer-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">üëÅÔ∏è Hi·ªán Pinyin</button>
                <h2 class="role-title buyer-title">PHI·∫æU A: NG∆Ø·ªúI MUA <span class="chinese-text">(‰π∞‰∏úË•øÁöÑ‰∫∫)</span> <span class="pinyin-text">(m«éi d≈çngxi de r√©n)</span> üßë‚Äçüåæ</h2>
                <h3>üìù Nhi·ªám v·ª• c·ªßa b·∫°n:</h3>
                <p class="mb-3 text-gray-700">B·∫°n ƒë·∫øn m·ªôt c·ª≠a h√†ng hoa qu·∫£. H√£y h·ªèi gi√° v√† mua nh·ªØng th·ª© c√≥ trong "Danh s√°ch c·∫ßn mua" c·ªßa b·∫°n. B·∫°n ch·ªâ c√≥ <strong class="text-red-600">30 ƒë·ªìng (‰∏âÂçÅÂùóÈí± <span class="pinyin-text">sƒÅnsh√≠ ku√†i qi√°n</span>)</strong>, h√£y ch·∫Øc ch·∫Øn b·∫°n ƒë·ªß ti·ªÅn tr·∫£ nh√©!</p>
                <h3>üõçÔ∏è Danh s√°ch c·∫ßn mua <span class="chinese-text">(Ë¥≠Áâ©Âçï</span> <span class="pinyin-text">g√≤uw√π dƒÅn</span>):</h3>
                <ul id="shopping-list-buyer" class="shopping-list list-none p-0"></ul>
                <p class="mt-2 text-sm text-gray-600">V√† h·ªèi gi√° th√™m m·ªôt lo·∫°i qu·∫£ kh√°c m√† b·∫°n th√≠ch (v√≠ d·ª•: <span class="chinese-text">Ë•øÁìú</span> <span class="pinyin-text">xƒ´guƒÅ</span> ho·∫∑c <span class="chinese-text">Ëë°ËêÑ</span> <span class="pinyin-text">p√∫tao</span>).</p>
                <div class="suggestion mt-6">
                    <h3 class="mt-0 text-amber-700">üí° G·ª£i √Ω cho b·∫°n:</h3>
                    <p class="text-gray-700">N·∫øu th·∫•y ƒë·∫Øt, b·∫°n c√≥ th·ªÉ th·ª≠ m·∫∑c c·∫£ b·∫±ng c√°ch n√≥i:</p>
                    <p class="chinese-text text-lg">Â§™Ë¥µ‰∫ÜÔºÅ‰æøÂÆú‰∏ÄÁÇπÂÑøÂêßÔºÅ</p>
                    <p class="pinyin-text">(T√†i gu√¨ le! Pi√°nyi y√¨di«énr ba!)</p>
                    <p class="mt-3 text-gray-700">C√°c m·∫´u c√¢u h·ªØu √≠ch kh√°c:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">...‰∏ÄÊñ§Â§öÂ∞ëÈí±Ôºü</span> <span class="pinyin-text">(...y√¨ jƒ´n du≈çshao qi√°n?)</span></li>
                        <li><span class="chinese-text">‰∏ÄÂÖ±Â§öÂ∞ëÈí±Ôºü</span> <span class="pinyin-text">(y√≠g√≤ng du≈çshao qi√°n?)</span></li>
                        <li><span class="chinese-text">Áªô‰Ω†Èí±„ÄÇ</span> <span class="pinyin-text">(gƒõi n«ê qi√°n.)</span></li>
                    </ul>
                </div>
            </div>

            <div id="seller-role-card" class="role-card seller-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">üëÅÔ∏è Hi·ªán Pinyin</button>
                <h2 class="role-title seller-title">PHI·∫æU B: NG∆Ø·ªúI B√ÅN <span class="chinese-text">(Âçñ‰∏úË•øÁöÑ‰∫∫)</span> <span class="pinyin-text">(m√†i d≈çngxi de r√©n)</span> üè™</h2>
                <h3>üìù Nhi·ªám v·ª• c·ªßa b·∫°n:</h3>
                <p class="mb-3 text-gray-700">B·∫°n l√† ch·ªß m·ªôt c·ª≠a h√†ng hoa qu·∫£. H√£y tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa kh√°ch h√†ng v√† t√≠nh t·ªïng s·ªë ti·ªÅn h·ªç ph·∫£i tr·∫£.</p>
                <h3>üè∑Ô∏è B·∫£ng gi√° c·ªßa b·∫°n <span class="chinese-text">(‰Ω†ÁöÑ‰ª∑Ê†ºÂçï</span> <span class="pinyin-text">n«ê de ji√†g√© dƒÅn</span>):</h3>
                <ul id="price-list-seller" class="price-list list-none p-0"></ul>
                <div class="suggestion mt-6">
                    <h3 class="mt-0 text-amber-700">üí° G·ª£i √Ω cho b·∫°n:</h3>
                    <p class="text-gray-700">Khi kh√°ch h√†ng tr·∫£ ti·ªÅn, h√£y d√πng c√°c m·∫´u c√¢u sau:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">‰∏ÄÂÖ±...Âùó...ÊØõ„ÄÇ</span> <span class="pinyin-text">(y√≠g√≤ng...ku√†i...m√°o.)</span></li>
                        <li><span class="chinese-text">Êî∂‰Ω†...Âùó„ÄÇ</span> <span class="pinyin-text">(sh≈çu n«ê...ku√†i.)</span></li>
                        <li><span class="chinese-text">Êâæ‰Ω†...Âùó...ÊØõ„ÄÇ</span> <span class="pinyin-text">(zh«éo n«ê...ku√†i...m√°o.)</span></li>
                    </ul>
                    <p class="mt-3 text-gray-700">C√°c m·∫´u c√¢u h·ªØu √≠ch kh√°c:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">‰Ω†Ë¶ÅÂá†Êñ§Ôºü</span> <span class="pinyin-text">(n«ê y√†o j«ê jƒ´n?)</span></li>
                        <li><span class="chinese-text">ËøòË¶ÅÂà´ÁöÑÂêóÔºü</span> <span class="pinyin-text">(h√°i y√†o bi√© de ma?)</span></li>
                        <li><span class="chinese-text">Â•ΩÁöÑ„ÄÇ/ Ë°å„ÄÇ</span> <span class="pinyin-text">(h«éo de. / x√≠ng.)</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="action-buttons-section text-center mt-8 mb-4 no-print">
                <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700">
                    üñ®Ô∏è In Phi·∫øu
                </button>
                <button onclick="handleChangeScenario()" class="bg-green-500 hover:bg-green-700 ml-2">
                    üîÑ ƒê·ªïi B·ªô ƒê·ªÅ (Ph√°ch)
                </button>
            </div>
        </div>
    </div>

    <script>
        const allFruitsData = [
            { name: "T√°o", chinese: "ËãπÊûú", pinyin: "p√≠nggu«í", basePriceMin: 2.5, basePriceMax: 6 },
            { name: "Cam", chinese: "Ê©òÂ≠ê", pinyin: "j√∫zi", basePriceMin: 2, basePriceMax: 4.5 },
            { name: "Chu·ªëi", chinese: "È¶ôËïâ", pinyin: "xiƒÅngjiƒÅo", basePriceMin: 3, basePriceMax: 5 },
            { name: "D∆∞a h·∫•u", chinese: "Ë•øÁìú", pinyin: "xƒ´guƒÅ", basePriceMin: 1.5, basePriceMax: 3 },
            { name: "Nho", chinese: "Ëë°ËêÑ", pinyin: "p√∫tao", basePriceMin: 6, basePriceMax: 12 },
            { name: "Xo√†i", chinese: "ËäíÊûú", pinyin: "m√°nggu«í", basePriceMin: 5, basePriceMax: 10 },
            { name: "L√™", chinese: "Ê¢®", pinyin: "l√≠", basePriceMin: 3, basePriceMax: 5.5 },
            { name: "ƒê√†o", chinese: "Ê°ÉÂ≠ê", pinyin: "t√°ozi", basePriceMin: 4, basePriceMax: 8 },
            { name: "V·∫£i", chinese: "ËçîÊûù", pinyin: "l√¨zhƒ´", basePriceMin: 7, basePriceMax: 15 },
            { name: "D√¢u t√¢y", chinese: "ËçâËéì", pinyin: "c«éom√©i", basePriceMin: 10, basePriceMax: 20 },
            { name: "Thanh long", chinese: "ÁÅ´ÈæôÊûú", pinyin: "hu«íl√≥nggu«í", basePriceMin: 4, basePriceMax: 7 },
            { name: "D·ª©a", chinese: "Ëè†Ëêù", pinyin: "b≈çlu√≥", basePriceMin: 3, basePriceMax: 6 }
        ];

        const jinQuantitiesData = [
            { amount: 1, chinese: "‰∏ÄÊñ§", pinyin: "y√¨ jƒ´n" },
            { amount: 1.5, chinese: "‰∏ÄÊñ§Âçä", pinyin: "y√¨ jƒ´n b√†n" },
            { amount: 2, chinese: "‰∏§Êñ§", pinyin: "li«éng jƒ´n" },
            { amount: 2.5, chinese: "‰∏§Êñ§Âçä", pinyin: "li«éng jƒ´n b√†n" },
            { amount: 3, chinese: "‰∏âÊñ§", pinyin: "sƒÅn jƒ´n" }
        ];

        const MAX_SCENARIOS = 10;
        let allScenarios = [];
        let currentScenarioId = 1;
        let selectedRole = null; // 'buyer' or 'seller'

        // DOM Elements
        const characterSelectionView = document.getElementById('character-selection-view');
        const rolePlayView = document.getElementById('role-play-view');
        const buyerRoleCard = document.getElementById('buyer-role-card');
        const sellerRoleCard = document.getElementById('seller-role-card');
        const currentPhachDisplay = document.getElementById('current-phach-display');
        const phachInput = document.getElementById('phach-input');
        const shoppingListBuyerContainer = document.getElementById('shopping-list-buyer');
        const priceListSellerContainer = document.getElementById('price-list-seller');


        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function generateRandomPrice(minKuai, maxKuai) {
            const kuai = getRandomInt(Math.floor(minKuai), Math.floor(maxKuai -1 < minKuai ? minKuai : maxKuai -1));
            const mao = getRandomInt(0, 9);
            let priceValue = kuai + (mao / 10);
            priceValue = Math.max(minKuai, Math.min(maxKuai, priceValue));

            const finalKuai = Math.floor(priceValue);
            const finalMao = Math.round((priceValue - finalKuai) * 10);

            let priceString = `${finalKuai}Âùó`;
            let pinyinString = `${kuaiToPinyin(finalKuai)} ku√†i`;
            if (finalMao > 0) {
                priceString += `${finalMao}ÊØõ`;
                pinyinString += ` ${maoToPinyin(finalMao)} m√°o`;
            }
            return { value: parseFloat(priceValue.toFixed(1)), string: priceString, pinyin: pinyinString };
        }

        function kuaiToPinyin(num) {
            const pinyinMap = ["l√≠ng", "yƒ´", "√®r", "sƒÅn", "s√¨", "w«î", "li√π", "qƒ´", "bƒÅ", "ji«î", "sh√≠"];
            if (num >= 0 && num <= 10) return pinyinMap[num];
            if (num > 10 && num < 20) return `sh√≠ ${pinyinMap[num%10] || ''}`.trim();
            if (num % 10 === 0 && num <=90) return `${pinyinMap[num/10]} sh√≠`.trim();
            if (num > 20 && num < 100) return `${pinyinMap[Math.floor(num/10)]} sh√≠ ${pinyinMap[num%10] || ''}`.trim();
            return String(num); 
        }

        function maoToPinyin(num) {
            const pinyinMap = ["l√≠ng", "yƒ´", "√®r", "sƒÅn", "s√¨", "w«î", "li√π", "qƒ´", "bƒÅ", "ji«î"];
            return (num >=0 && num <=9) ? pinyinMap[num] : String(num);
        }

        function generateRandomShoppingListItems() {
            let numItemsToBuy = getRandomInt(2, 3);
            let shoppingList = [];
            let availableFruits = [...allFruitsData];
            for (let i = 0; i < numItemsToBuy; i++) {
                if (availableFruits.length === 0) break;
                const fruitIndex = Math.floor(Math.random() * availableFruits.length);
                const fruit = availableFruits.splice(fruitIndex, 1)[0];
                const quantity = getRandomElement(jinQuantitiesData);
                shoppingList.push({ ...fruit, quantity });
            }
            return shoppingList;
        }

        function generateRandomPriceListItems(shoppingListForBuyer) {
            let sellerFruitsSet = new Map();
            shoppingListForBuyer.forEach(item => {
                const price = generateRandomPrice(item.basePriceMin, item.basePriceMax);
                sellerFruitsSet.set(item.chinese, {...item, price});
            });
            let availableForSeller = allFruitsData.filter(f => !sellerFruitsSet.has(f.chinese));
            let numExtraFruits = getRandomInt(2, 4);
            for (let i = 0; i < numExtraFruits; i++) {
                if (availableForSeller.length === 0) break;
                const fruitIndex = Math.floor(Math.random() * availableForSeller.length);
                const extraFruit = availableForSeller.splice(fruitIndex, 1)[0];
                const price = generateRandomPrice(extraFruit.basePriceMin, extraFruit.basePriceMax);
                sellerFruitsSet.set(extraFruit.chinese, {...extraFruit, price});
            }
            let priceList = Array.from(sellerFruitsSet.values());
            priceList.sort((a,b) => a.name.localeCompare(b.name));
            return priceList;
        }

        function generateAllScenarios() {
            allScenarios = [];
            for (let i = 1; i <= MAX_SCENARIOS; i++) {
                const shoppingListItems = generateRandomShoppingListItems();
                const priceListItems = generateRandomPriceListItems(shoppingListItems);
                allScenarios.push({
                    id: i,
                    shoppingList: shoppingListItems,
                    priceList: priceListItems
                });
            }
        }

        function displayShoppingList(shoppingListItems) {
            shoppingListBuyerContainer.innerHTML = '';
            shoppingListItems.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.name} (<span class="chinese-text">${item.chinese}</span> <span class="pinyin-text">${item.pinyin}</span>):</strong> ${item.quantity.amount} c√¢n <span class="chinese-text">(${item.quantity.chinese})</span> <span class="pinyin-text">(${item.quantity.pinyin})</span>`;
                shoppingListBuyerContainer.appendChild(li);
            });
        }

        function displayPriceList(priceListItems) {
            priceListSellerContainer.innerHTML = '';
            priceListItems.forEach(item => {
                const li = document.createElement('li');
                const priceStringForChinese = item.price.string.replace('Âùó', 'Âùó‰∏ÄÊñ§').replace(/(\d)ÊØõ$/, '$1ÊØõ‰∏ÄÊñ§');
                li.innerHTML = `<strong>${item.name} (<span class="chinese-text">${item.chinese}</span> <span class="pinyin-text">${item.pinyin}</span>):</strong> ${item.price.string}/c√¢n <span class="chinese-text">(${priceStringForChinese})</span> <span class="pinyin-text">(${item.price.pinyin} y√¨ jƒ´n)</span>`;
                priceListSellerContainer.appendChild(li);
            });
        }
        
        function resetPinyinVisibility() {
            document.querySelectorAll('.pinyin-text').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('.toggle-pinyin-btn').forEach(btn => btn.textContent = 'üëÅÔ∏è Hi·ªán Pinyin');
        }

        function loadScenario(scenarioId) {
            const scenario = allScenarios.find(s => s.id === scenarioId);
            if (scenario) {
                currentScenarioId = scenario.id;
                currentPhachDisplay.textContent = currentScenarioId;
                phachInput.value = currentScenarioId;

                displayShoppingList(scenario.shoppingList);
                displayPriceList(scenario.priceList);
                resetPinyinVisibility();
            } else {
                alert("S·ªë ph√°ch kh√¥ng h·ª£p l·ªá! Vui l√≤ng ch·ªçn s·ªë t·ª´ 1 ƒë·∫øn " + MAX_SCENARIOS + ".");
            }
        }
        
        window.selectRole = function(role) {
            selectedRole = role;
            characterSelectionView.classList.add('hidden');
            rolePlayView.classList.remove('hidden');

            if (role === 'buyer') {
                buyerRoleCard.classList.remove('hidden');
                sellerRoleCard.classList.add('hidden');
            } else if (role === 'seller') {
                sellerRoleCard.classList.remove('hidden');
                buyerRoleCard.classList.add('hidden');
            }
            // Ensure scenarios are generated if not already
            if(allScenarios.length === 0) {
                generateAllScenarios();
            }
            loadScenario(currentScenarioId); // Load current or default scenario
        }

        window.showCharacterSelection = function() {
            rolePlayView.classList.add('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');
            characterSelectionView.classList.remove('hidden');
            selectedRole = null;
        }
        
        window.handleChangeScenario = function() {
            let randomId;
            if (allScenarios.length <= 1) {
                randomId = 1;
            } else {
                do {
                    randomId = getRandomInt(1, MAX_SCENARIOS);
                } while (randomId === currentScenarioId && allScenarios.length > 1);
            }
            loadScenario(randomId);
        }

        window.handleMatchPhach = function() {
            const inputPhach = parseInt(phachInput.value);
            if (!isNaN(inputPhach) && inputPhach >= 1 && inputPhach <= MAX_SCENARIOS) {
                loadScenario(inputPhach);
            } else {
                 alert(`Vui l√≤ng nh·∫≠p s·ªë ph√°ch h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${MAX_SCENARIOS}.`);
            }
        }

        window.togglePinyin = function(buttonElement) {
            const card = buttonElement.closest('.role-card');
            if (!card) return; // Should not happen if button is inside a card
            const pinyinTexts = card.querySelectorAll('.pinyin-text');
            let isCurrentlyVisible = pinyinTexts.length > 0 && pinyinTexts[0].classList.contains('visible');

            pinyinTexts.forEach(el => {
                el.classList.toggle('visible');
            });
            buttonElement.textContent = isCurrentlyVisible ? 'üëÅÔ∏è Hi·ªán Pinyin' : 'üôà ·∫®n Pinyin';
        }
        
        // Initialize
        function initializeApp() {
            generateAllScenarios(); // Generate scenarios once
            showCharacterSelection(); // Start with character selection
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
