<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoáº¡t Äá»™ng Giao Tiáº¿p: Äi Chá»£ Mua Hoa Quáº£ (Chá»n NhÃ¢n Váº­t & Theo PhÃ¡ch)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 background */
        }
        .role-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem; /* 24px */
            border-left-width: 8px;
        }
        .buyer-card {
            border-left-color: #3b82f6; /* Blue-500 */
        }
        .seller-card {
            border-left-color: #16a34a; /* Green-600 */
        }
        .role-title {
            font-size: 1.75rem; /* 28px */
            font-weight: 700;
            margin-bottom: 1rem; /* 16px */
        }
        .buyer-title {
            color: #2563eb; /* Blue-600 */
        }
        .seller-title {
            color: #15803d; /* Green-700 */
        }
        .price-list li, .shopping-list li {
            background-color: #f9fafb; /* Gray-50 */
            padding: 0.75rem; /* 12px */
            border-radius: 6px;
            margin-bottom: 0.5rem; /* 8px */
            border: 1px solid #e5e7eb; /* Gray-200 */
        }
        .price-list li strong, .shopping-list li strong {
            color: #4b5563; /* Gray-600 */
        }
        .suggestion {
            background-color: #fffbeb; /* Amber-50 */
            border: 1px dashed #f59e0b; /* Amber-500 */
            padding: 1rem; /* 16px */
            border-radius: 8px;
            margin-top: 1rem; /* 16px */
        }
        .chinese-text {
            font-style: italic;
            color: #57534e; /* Stone-600 */
        }
        .pinyin-text {
            font-size: 0.9em;
            color: #78716c; /* Stone-500 */
            display: none; 
        }
        .pinyin-text.visible {
            display: inline; 
        }
        h3 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            margin-top: 1.25rem; 
            margin-bottom: 0.75rem; 
            color: #374151; /* Gray-700 */
        }
        .phach-section, .action-buttons-section {
            background-color: #e0f2fe; /* Sky-100 */
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #bae6fd; /* Sky-200 */
        }
        .phach-section input[type="number"] {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #9ca3af; /* Gray-400 */
            margin-left: 0.5rem;
            margin-right: 0.5rem;
            width: 80px;
        }
        .phach-section button, .action-buttons-section button, #character-selection-view button {
            background-color: #38bdf8; /* Sky-500 */
            color: white;
            padding: 0.75rem 1.5rem; /* Increased padding for bigger buttons */
            border-radius: 8px; /* More rounded */
            font-weight: 600; /* Bolder text */
            font-size: 1.1rem; /* Larger font */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phach-section button:hover, .action-buttons-section button:hover, #character-selection-view button:hover {
            background-color: #0ea5e9; /* Sky-600 */
            transform: translateY(-1px);
        }
         #character-selection-view button.buyer-btn {
            background-color: #3b82f6; /* Blue-500 */
        }
        #character-selection-view button.buyer-btn:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        #character-selection-view button.seller-btn {
            background-color: #16a34a; /* Green-600 */
        }
        #character-selection-view button.seller-btn:hover {
            background-color: #15803d; /* Green-700 */
        }
        .toggle-pinyin-btn {
            background-color: #eab308; /* Yellow-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 1rem;
            border: none;
        }
        .toggle-pinyin-btn:hover {
            background-color: #ca8a04; /* Yellow-600 */
        }
        .hidden {
            display: none !important;
        }
        #character-selection-view {
            text-align: center;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        #character-selection-view h2 {
            font-size: 2rem;
            color: #1f2937; /* Gray-800 */
            margin-bottom: 1.5rem;
        }
        #character-selection-view .button-container {
            display: flex;
            justify-content: center;
            gap: 1rem; /* Space between buttons */
        }

        @media print {
            body { background-color: white; font-size: 12pt; }
            .role-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 1.5rem; padding: 1rem; page-break-inside: avoid; }
            .no-print { display: none; }
            .printable-area { max-width: 100%; }
            .phach-section, .action-buttons-section, #character-selection-view { display: none; }
            .toggle-pinyin-btn { display: none; }
            .pinyin-text { display: inline !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-gray-700">ğŸ›’ Hoáº¡t Äá»™ng Giao Tiáº¿p: Äi Chá»£ Mua Hoa Quáº£ ğŸ“</h1>
            <p class="text-md text-gray-500">å»å¸‚åœºä¹°æ°´æœ <span class="pinyin-text">(qÃ¹ shÃ¬chÇng mÇi shuÇguÇ’)</span></p>
        </header>

        <div id="character-selection-view">
            <h2>ğŸ‘‹ Báº¡n lÃ  ai hÃ´m nay?</h2>
            <div class="button-container">
                <button onclick="selectRole('buyer')" class="buyer-btn">TÃ´i lÃ  NgÆ°á»i Mua ğŸ§‘â€ğŸŒ¾</button>
                <button onclick="selectRole('seller')" class="seller-btn">TÃ´i lÃ  NgÆ°á»i BÃ¡n ğŸª</button>
            </div>
        </div>

        <div id="role-play-view" class="hidden">
            <div class="text-center mb-4 no-print">
                 <button onclick="showCharacterSelection()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">
                    â†©ï¸ Quay láº¡i chá»n nhÃ¢n váº­t
                </button>
            </div>
            <div class="phach-section no-print text-center">
                <h3 class="text-xl font-semibold text-sky-700 mt-0 mb-3">ğŸ·ï¸ Khu Vá»±c Äá»“ng Bá»™ PhÃ¡ch</h3>
                <p class="mb-2 text-gray-700">
                    Bá»™ Ä‘á» hiá»‡n táº¡i (PhÃ¡ch sá»‘): <strong id="current-phach-display" class="text-sky-600 text-lg">1</strong>
                </p>
                <div>
                    <label for="phach-input" class="text-gray-700">Nháº­p sá»‘ phÃ¡ch (1-10):</label>
                    <input type="number" id="phach-input" min="1" max="10" value="1">
                    <button onclick="handleMatchPhach()">âœ”ï¸ Khá»›p PhÃ¡ch</button>
                </div>
            </div>

            <div id="buyer-role-card" class="role-card buyer-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">ğŸ‘ï¸ Hiá»‡n Pinyin</button>
                <h2 class="role-title buyer-title">PHIáº¾U A: NGÆ¯á»œI MUA <span class="chinese-text">(ä¹°ä¸œè¥¿çš„äºº)</span> <span class="pinyin-text">(mÇi dÅngxi de rÃ©n)</span> ğŸ§‘â€ğŸŒ¾</h2>
                <h3>ğŸ“ Nhiá»‡m vá»¥ cá»§a báº¡n:</h3>
                <p class="mb-3 text-gray-700">Báº¡n Ä‘áº¿n má»™t cá»­a hÃ ng hoa quáº£. HÃ£y há»i giÃ¡ vÃ  mua nhá»¯ng thá»© cÃ³ trong "Danh sÃ¡ch cáº§n mua" cá»§a báº¡n. Báº¡n chá»‰ cÃ³ <strong class="text-red-600">30 Ä‘á»“ng (ä¸‰åå—é’± <span class="pinyin-text">sÄnshÃ­ kuÃ i qiÃ¡n</span>)</strong>, hÃ£y cháº¯c cháº¯n báº¡n Ä‘á»§ tiá»n tráº£ nhÃ©!</p>
                <h3>ğŸ›ï¸ Danh sÃ¡ch cáº§n mua <span class="chinese-text">(è´­ç‰©å•</span> <span class="pinyin-text">gÃ²uwÃ¹ dÄn</span>):</h3>
                <ul id="shopping-list-buyer" class="shopping-list list-none p-0"></ul>
                <p class="mt-2 text-sm text-gray-600">VÃ  há»i giÃ¡ thÃªm má»™t loáº¡i quáº£ khÃ¡c mÃ  báº¡n thÃ­ch (vÃ­ dá»¥: <span class="chinese-text">è¥¿ç“œ</span> <span class="pinyin-text">xÄ«guÄ</span> hoáº·c <span class="chinese-text">è‘¡è„</span> <span class="pinyin-text">pÃºtao</span>).</p>
                <div class="suggestion mt-6">
                    <h3 class="mt-0 text-amber-700">ğŸ’¡ Gá»£i Ã½ cho báº¡n:</h3>
                    <p class="text-gray-700">Náº¿u tháº¥y Ä‘áº¯t, báº¡n cÃ³ thá»ƒ thá»­ máº·c cáº£ báº±ng cÃ¡ch nÃ³i:</p>
                    <p class="chinese-text text-lg">å¤ªè´µäº†ï¼ä¾¿å®œä¸€ç‚¹å„¿å§ï¼</p>
                    <p class="pinyin-text">(TÃ i guÃ¬ le! PiÃ¡nyi yÃ¬diÇnr ba!)</p>
                    <p class="mt-3 text-gray-700">CÃ¡c máº«u cÃ¢u há»¯u Ã­ch khÃ¡c:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">...ä¸€æ–¤å¤šå°‘é’±ï¼Ÿ</span> <span class="pinyin-text">(...yÃ¬ jÄ«n duÅshao qiÃ¡n?)</span></li>
                        <li><span class="chinese-text">ä¸€å…±å¤šå°‘é’±ï¼Ÿ</span> <span class="pinyin-text">(yÃ­gÃ²ng duÅshao qiÃ¡n?)</span></li>
                        <li><span class="chinese-text">ç»™ä½ é’±ã€‚</span> <span class="pinyin-text">(gÄ›i nÇ qiÃ¡n.)</span></li>
                    </ul>
                </div>
            </div>

            <div id="seller-role-card" class="role-card seller-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">ğŸ‘ï¸ Hiá»‡n Pinyin</button>
                <h2 class="role-title seller-title">PHIáº¾U B: NGÆ¯á»œI BÃN <span class="chinese-text">(å–ä¸œè¥¿çš„äºº)</span> <span class="pinyin-text">(mÃ i dÅngxi de rÃ©n)</span> ğŸª</h2>
                <h3>ğŸ“ Nhiá»‡m vá»¥ cá»§a báº¡n:</h3>
                <p class="mb-3 text-gray-700">Báº¡n lÃ  chá»§ má»™t cá»­a hÃ ng hoa quáº£. HÃ£y tráº£ lá»i cÃ¢u há»i cá»§a khÃ¡ch hÃ ng vÃ  tÃ­nh tá»•ng sá»‘ tiá»n há» pháº£i tráº£.</p>
                <h3>ğŸ·ï¸ Báº£ng giÃ¡ cá»§a báº¡n <span class="chinese-text">(ä½ çš„ä»·æ ¼å•</span> <span class="pinyin-text">nÇ de jiÃ gÃ© dÄn</span>):</h3>
                <ul id="price-list-seller" class="price-list list-none p-0"></ul>
                <div class="suggestion mt-6">
                    <h3 class="mt-0 text-amber-700">ğŸ’¡ Gá»£i Ã½ cho báº¡n:</h3>
                    <p class="text-gray-700">Khi khÃ¡ch hÃ ng tráº£ tiá»n, hÃ£y dÃ¹ng cÃ¡c máº«u cÃ¢u sau:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">ä¸€å…±...å—...æ¯›ã€‚</span> <span class="pinyin-text">(yÃ­gÃ²ng...kuÃ i...mÃ¡o.)</span></li>
                        <li><span class="chinese-text">æ”¶ä½ ...å—ã€‚</span> <span class="pinyin-text">(shÅu nÇ...kuÃ i.)</span></li>
                        <li><span class="chinese-text">æ‰¾ä½ ...å—...æ¯›ã€‚</span> <span class="pinyin-text">(zhÇo nÇ...kuÃ i...mÃ¡o.)</span></li>
                    </ul>
                    <p class="mt-3 text-gray-700">CÃ¡c máº«u cÃ¢u há»¯u Ã­ch khÃ¡c:</p>
                    <ul class="list-disc pl-5 text-sm text-gray-600">
                        <li><span class="chinese-text">ä½ è¦å‡ æ–¤ï¼Ÿ</span> <span class="pinyin-text">(nÇ yÃ o jÇ jÄ«n?)</span></li>
                        <li><span class="chinese-text">è¿˜è¦åˆ«çš„å—ï¼Ÿ</span> <span class="pinyin-text">(hÃ¡i yÃ o biÃ© de ma?)</span></li>
                        <li><span class="chinese-text">å¥½çš„ã€‚/ è¡Œã€‚</span> <span class="pinyin-text">(hÇo de. / xÃ­ng.)</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="action-buttons-section text-center mt-8 mb-4 no-print">
                <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700">
                    ğŸ–¨ï¸ In Phiáº¿u
                </button>
                <button onclick="handleChangeScenario()" class="bg-green-500 hover:bg-green-700 ml-2">
                    ğŸ”„ Äá»•i Bá»™ Äá» (PhÃ¡ch)
                </button>
            </div>
        </div>
    </div>

    <script>
        const allFruitsData = [
            { name: "TÃ¡o", chinese: "è‹¹æœ", pinyin: "pÃ­ngguÇ’", basePriceMin: 2.5, basePriceMax: 6 },
            { name: "Cam", chinese: "æ©˜å­", pinyin: "jÃºzi", basePriceMin: 2, basePriceMax: 4.5 },
            { name: "Chuá»‘i", chinese: "é¦™è•‰", pinyin: "xiÄngjiÄo", basePriceMin: 3, basePriceMax: 5 },
            { name: "DÆ°a háº¥u", chinese: "è¥¿ç“œ", pinyin: "xÄ«guÄ", basePriceMin: 1.5, basePriceMax: 3 },
            { name: "Nho", chinese: "è‘¡è„", pinyin: "pÃºtao", basePriceMin: 6, basePriceMax: 12 },
            { name: "XoÃ i", chinese: "èŠ’æœ", pinyin: "mÃ¡ngguÇ’", basePriceMin: 5, basePriceMax: 10 },
            { name: "LÃª", chinese: "æ¢¨", pinyin: "lÃ­", basePriceMin: 3, basePriceMax: 5.5 },
            { name: "ÄÃ o", chinese: "æ¡ƒå­", pinyin: "tÃ¡ozi", basePriceMin: 4, basePriceMax: 8 },
            { name: "Váº£i", chinese: "è”æ", pinyin: "lÃ¬zhÄ«", basePriceMin: 7, basePriceMax: 15 },
            { name: "DÃ¢u tÃ¢y", chinese: "è‰è“", pinyin: "cÇomÃ©i", basePriceMin: 10, basePriceMax: 20 },
            { name: "Thanh long", chinese: "ç«é¾™æœ", pinyin: "huÇ’lÃ³ngguÇ’", basePriceMin: 4, basePriceMax: 7 },
            { name: "Dá»©a", chinese: "è è", pinyin: "bÅluÃ³", basePriceMin: 3, basePriceMax: 6 }
        ];

        const jinQuantitiesData = [
            { amount: 1, chinese: "ä¸€æ–¤", pinyin: "yÃ¬ jÄ«n" },
            { amount: 1.5, chinese: "ä¸€æ–¤åŠ", pinyin: "yÃ¬ jÄ«n bÃ n" },
            { amount: 2, chinese: "ä¸¤æ–¤", pinyin: "liÇng jÄ«n" },
            { amount: 2.5, chinese: "ä¸¤æ–¤åŠ", pinyin: "liÇng jÄ«n bÃ n" },
            { amount: 3, chinese: "ä¸‰æ–¤", pinyin: "sÄn jÄ«n" }
        ];

        const MAX_SCENARIOS = 10;
        let allScenarios = [];
        let currentScenarioId = 1;
        let selectedRole = null; // 'buyer' or 'seller'

        // DOM Elements
        const characterSelectionView = document.getElementById('character-selection-view');
        const rolePlayView = document.getElementById('role-play-view');
        const buyerRoleCard = document.getElementById('buyer-role-card');
        const sellerRoleCard = document.getElementById('seller-role-card');
        const currentPhachDisplay = document.getElementById('current-phach-display');
        const phachInput = document.getElementById('phach-input');
        const shoppingListBuyerContainer = document.getElementById('shopping-list-buyer');
        const priceListSellerContainer = document.getElementById('price-list-seller');


        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function generateRandomPrice(minKuai, maxKuai) {
            const kuai = getRandomInt(Math.floor(minKuai), Math.floor(maxKuai -1 < minKuai ? minKuai : maxKuai -1));
            const mao = getRandomInt(0, 9);
            let priceValue = kuai + (mao / 10);
            priceValue = Math.max(minKuai, Math.min(maxKuai, priceValue));

            const finalKuai = Math.floor(priceValue);
            const finalMao = Math.round((priceValue - finalKuai) * 10);

            let priceString = `${finalKuai}å—`;
            let pinyinString = `${kuaiToPinyin(finalKuai)} kuÃ i`;
            if (finalMao > 0) {
                priceString += `${finalMao}æ¯›`;
                pinyinString += ` ${maoToPinyin(finalMao)} mÃ¡o`;
            }
            return { value: parseFloat(priceValue.toFixed(1)), string: priceString, pinyin: pinyinString };
        }

        function kuaiToPinyin(num) {
            const pinyinMap = ["lÃ­ng", "yÄ«", "Ã¨r", "sÄn", "sÃ¬", "wÇ”", "liÃ¹", "qÄ«", "bÄ", "jiÇ”", "shÃ­"];
            if (num >= 0 && num <= 10) return pinyinMap[num];
            if (num > 10 && num < 20) return `shÃ­ ${pinyinMap[num%10] || ''}`.trim();
            if (num % 10 === 0 && num <=90) return `${pinyinMap[num/10]} shÃ­`.trim();
            if (num > 20 && num < 100) return `${pinyinMap[Math.floor(num/10)]} shÃ­ ${pinyinMap[num%10] || ''}`.trim();
            return String(num); 
        }

        function maoToPinyin(num) {
            const pinyinMap = ["lÃ­ng", "yÄ«", "Ã¨r", "sÄn", "sÃ¬", "wÇ”", "liÃ¹", "qÄ«", "bÄ", "jiÇ”"];
            return (num >=0 && num <=9) ? pinyinMap[num] : String(num);
        }

        function generateRandomShoppingListItems() {
            let numItemsToBuy = getRandomInt(2, 3);
            let shoppingList = [];
            let availableFruits = [...allFruitsData];
            for (let i = 0; i < numItemsToBuy; i++) {
                if (availableFruits.length === 0) break;
                const fruitIndex = Math.floor(Math.random() * availableFruits.length);
                const fruit = availableFruits.splice(fruitIndex, 1)[0];
                const quantity = getRandomElement(jinQuantitiesData);
                shoppingList.push({ ...fruit, quantity });
            }
            return shoppingList;
        }

        function generateRandomPriceListItems(shoppingListForBuyer) {
            let sellerFruitsSet = new Map();
            shoppingListForBuyer.forEach(item => {
                const price = generateRandomPrice(item.basePriceMin, item.basePriceMax);
                sellerFruitsSet.set(item.chinese, {...item, price});
            });
            let availableForSeller = allFruitsData.filter(f => !sellerFruitsSet.has(f.chinese));
            let numExtraFruits = getRandomInt(2, 4);
            for (let i = 0; i < numExtraFruits; i++) {
                if (availableForSeller.length === 0) break;
                const fruitIndex = Math.floor(Math.random() * availableForSeller.length);
                const extraFruit = availableForSeller.splice(fruitIndex, 1)[0];
                const price = generateRandomPrice(extraFruit.basePriceMin, extraFruit.basePriceMax);
                sellerFruitsSet.set(extraFruit.chinese, {...extraFruit, price});
            }
            let priceList = Array.from(sellerFruitsSet.values());
            priceList.sort((a,b) => a.name.localeCompare(b.name));
            return priceList;
        }

        function generateAllScenarios() {
            allScenarios = [];
            for (let i = 1; i <= MAX_SCENARIOS; i++) {
                const shoppingListItems = generateRandomShoppingListItems();
                const priceListItems = generateRandomPriceListItems(shoppingListItems);
                allScenarios.push({
                    id: i,
                    shoppingList: shoppingListItems,
                    priceList: priceListItems
                });
            }
        }

        function displayShoppingList(shoppingListItems) {
            shoppingListBuyerContainer.innerHTML = '';
            shoppingListItems.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.name} (<span class="chinese-text">${item.chinese}</span> <span class="pinyin-text">${item.pinyin}</span>):</strong> ${item.quantity.amount} cÃ¢n <span class="chinese-text">(${item.quantity.chinese})</span> <span class="pinyin-text">(${item.quantity.pinyin})</span>`;
                shoppingListBuyerContainer.appendChild(li);
            });
        }

        function displayPriceList(priceListItems) {
            priceListSellerContainer.innerHTML = '';
            priceListItems.forEach(item => {
                const li = document.createElement('li');
                const priceStringForChinese = item.price.string.replace('å—', 'å—ä¸€æ–¤').replace(/(\d)æ¯›$/, '$1æ¯›ä¸€æ–¤');
                li.innerHTML = `<strong>${item.name} (<span class="chinese-text">${item.chinese}</span> <span class="pinyin-text">${item.pinyin}</span>):</strong> ${item.price.string}/cÃ¢n <span class="chinese-text">(${priceStringForChinese})</span> <span class="pinyin-text">(${item.price.pinyin} yÃ¬ jÄ«n)</span>`;
                priceListSellerContainer.appendChild(li);
            });
        }
        
        function resetPinyinVisibility() {
            document.querySelectorAll('.pinyin-text').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('.toggle-pinyin-btn').forEach(btn => btn.textContent = 'ğŸ‘ï¸ Hiá»‡n Pinyin');
        }

        function loadScenario(scenarioId) {
            const scenario = allScenarios.find(s => s.id === scenarioId);
            if (scenario) {
                currentScenarioId = scenario.id;
                currentPhachDisplay.textContent = currentScenarioId;
                phachInput.value = currentScenarioId;

                displayShoppingList(scenario.shoppingList);
                displayPriceList(scenario.priceList);
                resetPinyinVisibility();
            } else {
                alert("Sá»‘ phÃ¡ch khÃ´ng há»£p lá»‡! Vui lÃ²ng chá»n sá»‘ tá»« 1 Ä‘áº¿n " + MAX_SCENARIOS + ".");
            }
        }
        
        window.selectRole = function(role) {
            selectedRole = role;
            characterSelectionView.classList.add('hidden');
            rolePlayView.classList.remove('hidden');

            if (role === 'buyer') {
                buyerRoleCard.classList.remove('hidden');
                sellerRoleCard.classList.add('hidden');
            } else if (role === 'seller') {
                sellerRoleCard.classList.remove('hidden');
                buyerRoleCard.classList.add('hidden');
            }
            // Ensure scenarios are generated if not already
            if(allScenarios.length === 0) {
                generateAllScenarios();
            }
            loadScenario(currentScenarioId); // Load current or default scenario
        }

        window.showCharacterSelection = function() {
            rolePlayView.classList.add('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');
            characterSelectionView.classList.remove('hidden');
            selectedRole = null;
        }
        
        window.handleChangeScenario = function() {
            let randomId;
            if (allScenarios.length <= 1) {
                randomId = 1;
            } else {
                do {
                    randomId = getRandomInt(1, MAX_SCENARIOS);
                } while (randomId === currentScenarioId && allScenarios.length > 1);
            }
            loadScenario(randomId);
        }

        window.handleMatchPhach = function() {
            const inputPhach = parseInt(phachInput.value);
            if (!isNaN(inputPhach) && inputPhach >= 1 && inputPhach <= MAX_SCENARIOS) {
                loadScenario(inputPhach);
            } else {
                 alert(`Vui lÃ²ng nháº­p sá»‘ phÃ¡ch há»£p lá»‡ tá»« 1 Ä‘áº¿n ${MAX_SCENARIOS}.`);
            }
        }

        window.togglePinyin = function(buttonElement) {
            const card = buttonElement.closest('.role-card');
            if (!card) return; // Should not happen if button is inside a card
            const pinyinTexts = card.querySelectorAll('.pinyin-text');
            let isCurrentlyVisible = pinyinTexts.length > 0 && pinyinTexts[0].classList.contains('visible');

            pinyinTexts.forEach(el => {
                el.classList.toggle('visible');
            });
            buttonElement.textContent = isCurrentlyVisible ? 'ğŸ‘ï¸ Hiá»‡n Pinyin' : 'ğŸ™ˆ áº¨n Pinyin';
        }
        
        // Initialize
        function initializeApp() {
            generateAllScenarios(); // Generate scenarios once
            showCharacterSelection(); // Start with character selection
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
