<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ho·∫°t ƒê·ªông Giao Ti·∫øp: ƒêi Ch·ª£ Mua Hoa Qu·∫£ (C√≥ H√¨nh ·∫¢nh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        .role-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem; 
            border-left-width: 8px;
        }
        .buyer-card { border-left-color: #3b82f6; }
        .seller-card { border-left-color: #16a34a; }
        .role-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
        .buyer-title { color: #2563eb; }
        .seller-title { color: #15803d; }
        .fruit-list-item {
            background-color: #f9fafb; 
            padding: 0.75rem; 
            border-radius: 8px;
            margin-bottom: 0.75rem; 
            border: 1px solid #e5e7eb; 
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between image and text */
        }
        .fruit-list-item img {
            width: 5rem; /* 80px */
            height: 5rem; /* 80px */
            object-fit: cover;
            border-radius: 6px;
        }
        .fruit-list-item .info {
            flex-grow: 1;
        }
        .fruit-list-item .info .name {
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            color: #111827; /* Gray-900 */
        }
        .fruit-list-item .info .details {
            font-size: 1rem; /* 16px */
            color: #4b5563; /* Gray-600 */
        }

        .script-suggestion-list li {
            background-color: #f9fafb; 
            padding: 0.75rem; 
            border-radius: 6px;
            margin-bottom: 0.5rem; 
            border: 1px solid #e5e7eb; 
        }
        .suggestion, .script-suggestion {
            background-color: #fffbeb; 
            border: 1px dashed #f59e0b; 
            padding: 1rem; 
            border-radius: 8px;
            margin-top: 1rem; 
        }
        .script-suggestion { background-color: #eff6ff; border-color: #60a5fa; }
        .script-suggestion h4 { color: #1d4ed8; margin-top:0; font-size: 1.1rem; font-weight:600; }

        .chinese-text { font-style: italic; color: #57534e; }
        .pinyin-text { font-size: 0.9em; color: #78716c; display: none; }
        .pinyin-text.visible { display: inline; }
        h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.75rem; color: #374151; }
        
        .phach-section, .action-buttons-section {
            background-color: #e0f2fe; 
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #bae6fd; 
        }
        .phach-section input[type="number"] {
            padding: 0.5rem; border-radius: 6px; border: 1px solid #9ca3af; 
            margin-left: 0.5rem; margin-right: 0.5rem; width: 80px;
        }
        .phach-section button, .action-buttons-section button, #character-selection-view button {
            background-color: #38bdf8; color: white; padding: 0.75rem 1.5rem; 
            border-radius: 8px; font-weight: 600; font-size: 1.1rem; 
            border: none; cursor: pointer; transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phach-section button:hover, .action-buttons-section button:hover, #character-selection-view button:hover {
            background-color: #0ea5e9; transform: translateY(-1px);
        }
        #character-selection-view button.buyer-btn { background-color: #3b82f6; }
        #character-selection-view button.buyer-btn:hover { background-color: #2563eb; }
        #character-selection-view button.seller-btn { background-color: #16a34a; }
        #character-selection-view button.seller-btn:hover { background-color: #15803d; }
        .toggle-pinyin-btn {
            background-color: #eab308; color: white; padding: 0.5rem 1rem;
            border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; margin-bottom: 1rem; border: none;
        }
        .toggle-pinyin-btn:hover { background-color: #ca8a04; }
        .hidden { display: none !important; }
        #character-selection-view {
            text-align: center; padding: 2rem; background-color: white;
            border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        #character-selection-view h2 { font-size: 2rem; color: #1f2937; margin-bottom: 1.5rem; }
        #character-selection-view .button-container { display: flex; justify-content: center; gap: 1rem; }

        @media print {
            body { background-color: white; font-size: 12pt; }
            .role-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 1.5rem; padding: 1rem; page-break-inside: avoid; }
            .no-print { display: none; }
            .printable-area { max-width: 100%; }
            .phach-section, .action-buttons-section, #character-selection-view, .script-suggestion { display: none; }
            .toggle-pinyin-btn { display: none; }
            .pinyin-text { display: inline !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-gray-700">üõí Ho·∫°t ƒê·ªông Giao Ti·∫øp: ƒêi Ch·ª£ Mua Hoa Qu·∫£ üçì</h1>
            <p class="text-md text-gray-500">ÂéªÂ∏ÇÂú∫‰π∞Ê∞¥Êûú <span class="pinyin-text">(q√π sh√¨ch«éng m«éi shu«êgu«í)</span></p>
        </header>

        <div id="character-selection-view">
            <h2>üëã B·∫°n l√† ai h√¥m nay?</h2>
            <div class="button-container">
                <button onclick="selectRole('buyer')" class="buyer-btn">T√¥i l√† Ng∆∞·ªùi Mua üßë‚Äçüåæ</button>
                <button onclick="selectRole('seller')" class="seller-btn">T√¥i l√† Ng∆∞·ªùi B√°n üè™</button>
            </div>
        </div>

        <div id="role-play-view" class="hidden">
            <div class="text-center mb-4 no-print">
                 <button onclick="showCharacterSelection()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">
                    ‚Ü©Ô∏è Quay l·∫°i ch·ªçn nh√¢n v·∫≠t
                </button>
            </div>
            <div class="phach-section no-print text-center">
                <h3 class="text-xl font-semibold text-sky-700 mt-0 mb-3">üè∑Ô∏è Khu V·ª±c ƒê·ªìng B·ªô Ph√°ch</h3>
                <p class="mb-2 text-gray-700">
                    B·ªô ƒë·ªÅ hi·ªán t·∫°i (Ph√°ch s·ªë): <strong id="current-phach-display" class="text-sky-600 text-lg">1</strong>
                </p>
                <div>
                    <label for="phach-input" class="text-gray-700">Nh·∫≠p s·ªë ph√°ch (1-10):</label>
                    <input type="number" id="phach-input" min="1" max="10" value="1">
                    <button onclick="handleMatchPhach()">‚úîÔ∏è Kh·ªõp Ph√°ch</button>
                </div>
            </div>

            <div id="buyer-role-card" class="role-card buyer-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">üëÅÔ∏è Hi·ªán Pinyin</button>
                <h2 class="role-title buyer-title">PHI·∫æU A: NG∆Ø·ªúI MUA <span class="chinese-text">(‰π∞‰∏úË•øÁöÑ‰∫∫)</span> <span class="pinyin-text">(m«éi d≈çngxi de r√©n)</span> üßë‚Äçüåæ</h2>
                <h3>üìù Nhi·ªám v·ª• c·ªßa b·∫°n:</h3>
                <p class="mb-3 text-gray-700">B·∫°n ƒë·∫øn m·ªôt c·ª≠a h√†ng hoa qu·∫£. H·ªèi gi√° v√† mua nh·ªØng th·ª© trong "Danh s√°ch c·∫ßn mua". B·∫°n c√≥ <strong class="text-red-600">30 ƒë·ªìng (‰∏âÂçÅÂùóÈí± <span class="pinyin-text">sƒÅnsh√≠ ku√†i qi√°n</span>)</strong>, h√£y t√≠nh to√°n c·∫©n th·∫≠n nh√©!</p>
                <h3>üõçÔ∏è Danh s√°ch c·∫ßn mua <span class="chinese-text">(Ë¥≠Áâ©Âçï</span> <span class="pinyin-text">g√≤uw√π dƒÅn</span>):</h3>
                <ul id="shopping-list-buyer" class="list-none p-0"></ul>
                <p class="mt-2 text-sm text-gray-600">V√† h·ªèi gi√° th√™m m·ªôt lo·∫°i qu·∫£ kh√°c m√† b·∫°n th√≠ch.</p>
                
                <div class="script-suggestion mt-6">
                    <h4>üìù K·ªãch b·∫£n g·ª£i √Ω cho b·∫°n (Ng∆∞·ªùi Mua):</h4>
                    <ul class="script-suggestion-list list-none p-0 text-sm">
                        <li><strong>Ch√†o h·ªèi:</strong> <span class="chinese-text">‰Ω†Â•ΩÔºÅ</span> <span class="pinyin-text">(N«ê h«éo!)</span></li>
                        <li><strong>N√≥i mu·ªën mua g√¨:</strong> <span class="chinese-text">ÊàëÊÉ≥‰π∞Ê∞¥Êûú„ÄÇ</span> <span class="pinyin-text">(W«í xi«éng m«éi shu«êgu«í.)</span></li>
                        <li><strong>H·ªèi gi√° (v√≠ d·ª• T√°o):</strong> <span class="chinese-text">ËØ∑ÈóÆËãπÊûú‰∏ÄÊñ§Â§öÂ∞ëÈí±Ôºü</span> <span class="pinyin-text">(Q«êngw√®n p√≠nggu«í y√¨ jƒ´n du≈çshao qi√°n?)</span></li>
                        <li><strong>M·∫∑c c·∫£ (n·∫øu c·∫ßn):</strong> <span class="chinese-text">Â§™Ë¥µ‰∫ÜÔºå‰æøÂÆú‰∏ÄÁÇπÂÑøÂêßÔºÅ</span> <span class="pinyin-text">(T√†i gu√¨ le, pi√°nyi y√¨di«énr ba!)</span></li>
                        <li><strong>N√≥i s·ªë l∆∞·ª£ng (v√≠ d·ª• 2 c√¢n):</strong> <span class="chinese-text">ÊàëË¶Å‰∏§Êñ§„ÄÇ</span> <span class="pinyin-text">(W«í y√†o li«éng jƒ´n.)</span></li>
                        <li><strong>H·ªèi t·ªïng ti·ªÅn:</strong> <span class="chinese-text">‰∏ÄÂÖ±Â§öÂ∞ëÈí±Ôºü</span> <span class="pinyin-text">(Y√≠g√≤ng du≈çshao qi√°n?)</span></li>
                        <li><strong>Tr·∫£ ti·ªÅn:</strong> <span class="chinese-text">Áªô‰Ω†Èí±„ÄÇ</span> <span class="pinyin-text">(Gƒõi n«ê qi√°n.)</span></li>
                    </ul>
                </div>
            </div>

            <div id="seller-role-card" class="role-card seller-card hidden">
                <button class="toggle-pinyin-btn no-print" onclick="togglePinyin(this)">üëÅÔ∏è Hi·ªán Pinyin</button>
                <h2 class="role-title seller-title">PHI·∫æU B: NG∆Ø·ªúI B√ÅN <span class="chinese-text">(Âçñ‰∏úË•øÁöÑ‰∫∫)</span> <span class="pinyin-text">(m√†i d≈çngxi de r√©n)</span> üè™</h2>
                <h3>üìù Nhi·ªám v·ª• c·ªßa b·∫°n:</h3>
                <p class="mb-3 text-gray-700">B·∫°n l√† ch·ªß c·ª≠a h√†ng hoa qu·∫£. Tr·∫£ l·ªùi kh√°ch h√†ng v√† t√≠nh ti·ªÅn cho h·ªç.</p>
                <h3>üè∑Ô∏è B·∫£ng gi√° c·ªßa b·∫°n h√¥m nay <span class="chinese-text">(‰ªäÊó•‰ª∑Ê†ºÂçï</span> <span class="pinyin-text">jƒ´nr√¨ ji√†g√© dƒÅn</span>):</h3>
                <ul id="price-list-seller" class="list-none p-0"></ul>

                <div class="script-suggestion mt-6">
                    <h4>üìù K·ªãch b·∫£n g·ª£i √Ω cho b·∫°n (Ng∆∞·ªùi B√°n):</h4>
                    <ul class="script-suggestion-list list-none p-0 text-sm">
                        <li><strong>Ch√†o kh√°ch:</strong> <span class="chinese-text">‰Ω†Â•ΩÔºÅ/ Ê¨¢ËøéÂÖâ‰∏¥ÔºÅ</span> <span class="pinyin-text">(N«ê h«éo! / HuƒÅny√≠ng guƒÅngl√≠n!)</span></li>
                        <li><strong>H·ªèi kh√°ch mu·ªën g√¨:</strong> <span class="chinese-text">‰Ω†‰π∞‰ªÄ‰πàÔºü</span> <span class="pinyin-text">(N«ê m«éi sh√©nme?)</span></li>
                        <li><strong>B√°o gi√° (v√≠ d·ª• T√°o 3 ƒë·ªìng):</strong> <span class="chinese-text">ËãπÊûú‰∏âÂùó‰∏ÄÊñ§„ÄÇ</span> <span class="pinyin-text">(P√≠nggu«í sƒÅn ku√†i y√¨ jƒ´n.)</span></li>
                        <li><strong>H·ªèi s·ªë l∆∞·ª£ng:</strong> <span class="chinese-text">‰Ω†Ë¶ÅÂá†Êñ§Ôºü</span> <span class="pinyin-text">(N«ê y√†o j«ê jƒ´n?)</span></li>
                        <li><strong>T√≠nh t·ªïng ti·ªÅn (v√≠ d·ª• 16.5 ƒë·ªìng):</strong> <span class="chinese-text">‰∏ÄÂÖ±ÂçÅÂÖ≠Âùó‰∫îÊØõ„ÄÇ</span> <span class="pinyin-text">(Y√≠g√≤ng sh√≠li√π ku√†i w«î m√°o.)</span></li>
                        <li><strong>Nh·∫≠n ti·ªÅn v√† th·ªëi ti·ªÅn (v√≠ d·ª• nh·∫≠n 50, th·ªëi 33.5):</strong> <span class="chinese-text">Êî∂‰Ω†‰∫îÂçÅÂùóÔºåÊâæ‰Ω†‰∏âÂçÅ‰∏âÂùó‰∫îÊØõ„ÄÇ</span> <span class="pinyin-text">(Sh≈çu n«ê w«îsh√≠ ku√†i, zh«éo n«ê sƒÅnsh√≠sƒÅn ku√†i w«î m√°o.)</span></li>
                         <li><strong>C·∫£m ∆°n, ti·ªÖn kh√°ch:</strong> <span class="chinese-text">Ë∞¢Ë∞¢ÔºÅÊÇ®ÊÖ¢Ëµ∞ÔºÅ</span> <span class="pinyin-text">(Xi√®xie! N√≠n m√†n z«íu!)</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="action-buttons-section text-center mt-8 mb-4 no-print">
                <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700">
                    üñ®Ô∏è In Phi·∫øu
                </button>
                <button onclick="handleChangeScenario()" class="bg-green-500 hover:bg-green-700 ml-2">
                    üîÑ ƒê·ªïi B·ªô ƒê·ªÅ (Ph√°ch)
                </button>
            </div>
        </div>
    </div>

    <script>
        const allFruitsData = [
            { name: "T√°o", chinese: "ËãπÊûú", pinyin: "p√≠nggu«í", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoCDBwHdRmovxn9d3GZ14Uwbb7YUK7hFgq1A&s", basePriceMin: 2.5, basePriceMax: 6 },
            { name: "Qu√Ωt", chinese: "Ê©òÂ≠ê", pinyin: "j√∫zi", imageUrl: "https://vcdn1-suckhoe.vnecdn.net/2022/11/17/close-up-fresh-organic-mandari-7704-8534-1668676426.jpg?w=1200&h=0&q=100&dpr=1&fit=crop&s=7xwH-Nb8gPUf1pAZGZ7jyg", basePriceMin: 2, basePriceMax: 4.5 },
            { name: "Chu·ªëi", chinese: "È¶ôËïâ", pinyin: "xiƒÅngjiƒÅo", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/324455921873985536/2021/10/14/chuoi1-16341869574602070184903.jpg", basePriceMin: 3, basePriceMax: 5 },
            { name: "D∆∞a h·∫•u", chinese: "Ë•øÁìú", pinyin: "xƒ´guƒÅ", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/324455921873985536/2022/11/12/dua-hau-16682703712011380946081.jpg", basePriceMin: 1.5, basePriceMax: 3 },
            { name: "Nho", chinese: "Ëë°ËêÑ", pinyin: "p√∫tao", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSw33gbpYpsdGtOMdLeYFmPpdX-I-8ku8e8SA&s", basePriceMin: 6, basePriceMax: 12 },
            { name: "Xo√†i", chinese: "ËäíÊûú", pinyin: "m√°nggu«í", imageUrl: "https://suckhoedoisong.qltns.mediacdn.vn/Images/duylinh/2019/08/15/8-loi-ich-it-biet-cua-xoai1565855128.jpg", basePriceMin: 5, basePriceMax: 10 },
            { name: "L√™", chinese: "Ê¢®", pinyin: "l√≠", imageUrl: "https://cdn.tgdd.vn/Products/Images/8788/223091/bhx/le-duong-hop-1kg-4-6-trai-202205111941249856.jpg", basePriceMin: 3, basePriceMax: 5.5 },
            { name: "ƒê√†o", chinese: "Ê°ÉÂ≠ê", pinyin: "t√°ozi", imageUrl: "https://citifruit.com/uploads/images/Products/qua-dao-800x600.jpg", basePriceMin: 4, basePriceMax: 8 }
        ];

        const jinQuantitiesData = [
            { amount: 1, chinese: "‰∏ÄÊñ§", pinyin: "y√¨ jƒ´n" },
            { amount: 1.5, chinese: "‰∏ÄÊñ§Âçä", pinyin: "y√¨ jƒ´n b√†n" },
            { amount: 2, chinese: "‰∏§Êñ§", pinyin: "li«éng jƒ´n" },
            { amount: 2.5, chinese: "‰∏§Êñ§Âçä", pinyin: "li«éng jƒ´n b√†n" },
            { amount: 3, chinese: "‰∏âÊñ§", pinyin: "sƒÅn jƒ´n" }
        ];

        const MAX_SCENARIOS = 10;
        let currentScenarioId = 1;
        let selectedRole = null; 

        // DOM Elements
        const characterSelectionView = document.getElementById('character-selection-view');
        const rolePlayView = document.getElementById('role-play-view');
        const buyerRoleCard = document.getElementById('buyer-role-card');
        const sellerRoleCard = document.getElementById('seller-role-card');
        const currentPhachDisplay = document.getElementById('current-phach-display');
        const phachInput = document.getElementById('phach-input');
        const shoppingListBuyerContainer = document.getElementById('shopping-list-buyer');
        const priceListSellerContainer = document.getElementById('price-list-seller');

        // Seeded Pseudo-Random Number Generator
        let scenarioPrng;
        function mulberry32(a) {
            return function() {
              var t = a += 0x6D2B79F5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function getSeededRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(scenarioPrng() * (max - min + 1)) + min;
        }

        function getSeededRandomElement(arr) {
            if (!arr || arr.length === 0) return undefined;
            return arr[Math.floor(scenarioPrng() * arr.length)];
        }
        
        function generateSeededRandomPrice(minKuai, maxKuai) {
            const kuai = getSeededRandomInt(Math.floor(minKuai), Math.floor(maxKuai -1 < minKuai ? minKuai : maxKuai -1));
            const mao = getSeededRandomInt(0, 9);
            let priceValue = kuai + (mao / 10);
            priceValue = Math.max(minKuai, Math.min(maxKuai, priceValue));
            const finalKuai = Math.floor(priceValue);
            const finalMao = Math.round((priceValue - finalKuai) * 10);
            let priceString = `${finalKuai}Âùó`;
            let pinyinString = `${kuaiToPinyin(finalKuai)} ku√†i`;
            if (finalMao > 0) {
                priceString += `${finalMao}ÊØõ`;
                pinyinString += ` ${maoToPinyin(finalMao)} m√°o`;
            }
            return { value: parseFloat(priceValue.toFixed(1)), string: priceString, pinyin: pinyinString };
        }

        function kuaiToPinyin(num) {
            const pinyinMap = ["l√≠ng", "yƒ´", "√®r", "sƒÅn", "s√¨", "w«î", "li√π", "qƒ´", "bƒÅ", "ji«î", "sh√≠"];
            if (num >= 0 && num <= 10) return pinyinMap[num];
            if (num > 10 && num < 20) return `sh√≠ ${pinyinMap[num%10] || ''}`.trim();
            if (num % 10 === 0 && num <=90) return `${pinyinMap[num/10]} sh√≠`.trim();
            if (num > 20 && num < 100) return `${pinyinMap[Math.floor(num/10)]} sh√≠ ${pinyinMap[num%10] || ''}`.trim();
            return String(num); 
        }
        function maoToPinyin(num) {
            const pinyinMap = ["l√≠ng", "yƒ´", "√®r", "sƒÅn", "s√¨", "w«î", "li√π", "qƒ´", "bƒÅ", "ji«î"];
            return (num >=0 && num <=9) ? pinyinMap[num] : String(num);
        }

        function generateSpecificScenario(scenarioId) {
            scenarioPrng = mulberry32(scenarioId * 12345 + 67890); 

            const marketDayOfferings = [];
            let availableFruitsForThisScenario = [...allFruitsData];
            const numFruitsInMarket = getSeededRandomInt(Math.min(5, availableFruitsForThisScenario.length), Math.min(8, availableFruitsForThisScenario.length));

            for (let j = 0; j < numFruitsInMarket; j++) {
                if (availableFruitsForThisScenario.length === 0) break;
                const fruitIndex = Math.floor(scenarioPrng() * availableFruitsForThisScenario.length);
                const fruitData = availableFruitsForThisScenario.splice(fruitIndex, 1)[0];
                const price = generateSeededRandomPrice(fruitData.basePriceMin, fruitData.basePriceMax); 
                marketDayOfferings.push({ ...fruitData, price: price });
            }
            marketDayOfferings.sort((a, b) => a.name.localeCompare(b.name));

            const buyerShoppingListItems = [];
            let fruitsToChooseFromForBuyer = [...marketDayOfferings]; 
            const numItemsToBuy = getSeededRandomInt(Math.min(2, fruitsToChooseFromForBuyer.length), Math.min(3, fruitsToChooseFromForBuyer.length));

            for (let k = 0; k < numItemsToBuy; k++) {
                if (fruitsToChooseFromForBuyer.length === 0) break;
                const itemIndex = Math.floor(scenarioPrng() * fruitsToChooseFromForBuyer.length);
                const marketItem = fruitsToChooseFromForBuyer.splice(itemIndex, 1)[0];
                const quantity = getSeededRandomElement(jinQuantitiesData); 
                buyerShoppingListItems.push({ ...marketItem, quantity: quantity });
            }
            return {
                id: scenarioId,
                buyerShoppingList: buyerShoppingListItems, 
                sellerPriceList: marketDayOfferings      
            };
        }

        function displayShoppingList(shoppingListItems) {
            shoppingListBuyerContainer.innerHTML = '';
            if (!shoppingListItems) return;
            shoppingListItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'fruit-list-item';
                li.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.chinese}">
                    <div class="info">
                        <div class="name">
                            <span class="chinese-text">${item.chinese}</span> 
                            <span class="pinyin-text">${item.pinyin}</span>
                        </div>
                        <div class="details">
                            ${item.quantity.amount} c√¢n <span class="chinese-text">(${item.quantity.chinese})</span> 
                            <span class="pinyin-text">(${item.quantity.pinyin})</span>
                        </div>
                    </div>
                `;
                shoppingListBuyerContainer.appendChild(li);
            });
        }

        function displayPriceList(priceListItems) {
            priceListSellerContainer.innerHTML = '';
            if (!priceListItems) return;
            priceListItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'fruit-list-item';
                const priceStringForChinese = item.price.string.replace('Âùó', 'Âùó‰∏ÄÊñ§').replace(/(\d)ÊØõ$/, '$1ÊØõ‰∏ÄÊñ§');
                li.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.chinese}">
                    <div class="info">
                        <div class="name">
                            <span class="chinese-text">${item.chinese}</span> 
                            <span class="pinyin-text">${item.pinyin}</span>
                        </div>
                        <div class="details">
                            ${item.price.string}/c√¢n 
                            <span class="chinese-text">(${priceStringForChinese})</span> 
                            <span class="pinyin-text">(${item.price.pinyin} y√¨ jƒ´n)</span>
                        </div>
                    </div>
                `;
                priceListSellerContainer.appendChild(li);
            });
        }
        
        function resetPinyinVisibility() {
            document.querySelectorAll('.pinyin-text').forEach(el => el.classList.remove('visible'));
            const pinyinToggleButtons = document.querySelectorAll('.toggle-pinyin-btn');
            pinyinToggleButtons.forEach(btn => {
                if (btn.closest('.role-card:not(.hidden)')) {
                     btn.textContent = 'üëÅÔ∏è Hi·ªán Pinyin';
                }
            });
        }

        function loadScenario(scenarioId) {
            const scenario = generateSpecificScenario(scenarioId);
            if (scenario) {
                currentScenarioId = scenario.id;
                currentPhachDisplay.textContent = currentScenarioId;
                phachInput.value = currentScenarioId;
                displayShoppingList(scenario.buyerShoppingList);
                displayPriceList(scenario.sellerPriceList);
                resetPinyinVisibility();
            }
        }
        
        window.selectRole = function(role) {
            selectedRole = role;
            characterSelectionView.classList.add('hidden');
            rolePlayView.classList.remove('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');

            if (role === 'buyer') buyerRoleCard.classList.remove('hidden');
            else if (role === 'seller') sellerRoleCard.classList.remove('hidden');
            
            loadScenario(currentScenarioId); 
        }

        window.showCharacterSelection = function() {
            rolePlayView.classList.add('hidden');
            buyerRoleCard.classList.add('hidden');
            sellerRoleCard.classList.add('hidden');
            characterSelectionView.classList.remove('hidden');
            selectedRole = null;
        }
        
        window.handleChangeScenario = function() {
            let randomId;
            if (MAX_SCENARIOS <= 1) randomId = 1;
            else {
                do { randomId = Math.floor(Math.random() * MAX_SCENARIOS) + 1; } 
                while (randomId === currentScenarioId && MAX_SCENARIOS > 1);
            }
            loadScenario(randomId);
        }

        window.handleMatchPhach = function() {
            const inputPhach = parseInt(phachInput.value);
            if (!isNaN(inputPhach) && inputPhach >= 1 && inputPhach <= MAX_SCENARIOS) {
                loadScenario(inputPhach);
            } else {
                 alert(`Vui l√≤ng nh·∫≠p s·ªë ph√°ch h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${MAX_SCENARIOS}.`);
            }
        }

        window.togglePinyin = function(buttonElement) {
            const card = buttonElement.closest('.role-card');
            if (!card) return; 
            const pinyinTexts = card.querySelectorAll('.pinyin-text');
            let isCurrentlyVisible = pinyinTexts.length > 0 && pinyinTexts[0].classList.contains('visible');
            pinyinTexts.forEach(el => el.classList.toggle('visible'));
            buttonElement.textContent = isCurrentlyVisible ? 'üëÅÔ∏è Hi·ªán Pinyin' : 'üôà ·∫®n Pinyin';
        }
        
        function initializeApp() {
            showCharacterSelection(); 
        }
        window.onload = initializeApp;
    </script></body></html>
